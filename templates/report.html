{% extends "base.html" %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('accounts') }}"><svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>RepoRadar</a></li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item active" aria-current="page">{{ report.company_name }}</li>
    </ol>
</nav>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}?v={{ cache_bust }}">
{% endblock %}

{% block content %}
{% set goldilocks_status = report.scan_data.goldilocks_status or report.ai_analysis.goldilocks_status or 'none' %}
{% set lead_status = report.scan_data.lead_status or report.ai_analysis.lead_status or '' %}

<div class="report-page">

  <!-- ===== STICKY HEADER ===== -->
  <div class="report-sticky-header" id="reportStickyHeader">
    <span class="sticky-company-name">{{ report.company_name|title }}</span>
    {% if goldilocks_status == 'preparing' %}
    <span class="sticky-verdict verdict-hot">Call Now</span>
    {% elif goldilocks_status == 'thinking' %}
    <span class="sticky-verdict verdict-warm">Warm Lead</span>
    {% elif goldilocks_status == 'launched' %}
    <span class="sticky-verdict verdict-late">Too Late</span>
    {% else %}
    <span class="sticky-verdict verdict-cold">Cold Lead</span>
    {% endif %}
  </div>

  <!-- ===== HERO HEADER ===== -->
  <div class="hero" id="reportHero">
    <div class="hero-left">
      <h1 class="hero-company">{{ report.company_name|title }}</h1>
      <div class="hero-meta">
        <a href="{{ report.scan_data.org_url }}" target="_blank" class="meta-link">@{{ report.github_org }}</a>
        {% if report.website %}
        <a href="{{ report.website|normalize_url }}" target="_blank" class="meta-link">{{ report.website }}</a>
        {% endif %}
        {% if report.annual_revenue %}
        <span class="meta-tag revenue-display" data-raw="{{ report.annual_revenue }}">{{ report.annual_revenue|format_revenue }}</span>
        {% endif %}
        <span class="meta-date">{{ report.created_at }}</span>
      </div>
    </div>
    <div class="hero-right">
      {% if goldilocks_status == 'preparing' %}
      <div class="verdict-badge verdict-hot">
        <div class="verdict-label"><svg class="verdict-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>Call Now</div>
        <div class="verdict-detail">Goldilocks signal detected</div>
      </div>
      {% elif goldilocks_status == 'thinking' %}
      <div class="verdict-badge verdict-warm">
        <div class="verdict-label"><svg class="verdict-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2c1 3 3 5 6 6-3 1-5 3-6 6-1-3-3-5-6-6 3-1 5-3 6-6z"/></svg>Warm Lead</div>
        <div class="verdict-detail">Early momentum</div>
      </div>
      {% elif goldilocks_status == 'launched' %}
      <div class="verdict-badge verdict-late">
        <div class="verdict-label"><svg class="verdict-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Too Late</div>
        <div class="verdict-detail">Already localized</div>
      </div>
      {% else %}
      <div class="verdict-badge verdict-cold">
        <div class="verdict-label"><svg class="verdict-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M8 6l4-4 4 4M8 18l4 4 4-4M2 12h20"/></svg>Cold Lead</div>
        <div class="verdict-detail">Keep monitoring</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- ===== INTEL STRIP ===== -->
  <div class="intel-strip">
    {% if report.scan_data.scoring_v2 %}
    {% set v2 = report.scan_data.scoring_v2 %}
    <div class="intel-item">
      <span class="intel-label">Maturity</span>
      <span class="intel-info" title="How mature their i18n infrastructure is">i</span>
      <span class="intel-value badge-maturity-{{ v2.org_maturity_level|default('unknown') }}">{{ v2.org_maturity_label|default('Unknown') }}</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Readiness</span>
      <span class="intel-info" title="How close to needing a localization platform">i</span>
      <div class="readiness-bar-mini">
        <div class="readiness-fill" style="width: {{ (v2.readiness_index|default(0) * 100)|int }}%"></div>
      </div>
      <span class="intel-value">{{ (v2.readiness_index|default(0) * 100)|int }}%</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Confidence</span>
      <span class="intel-info" title="Assessment confidence based on available data">i</span>
      <span class="intel-value">{{ "%.0f"|format(v2.confidence_percent|default(0)) }}%</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Risk</span>
      <span class="intel-info" title="Risk they already have a competing solution">i</span>
      <span class="intel-value risk-{{ v2.risk_label|default('unknown')|lower }}">{{ v2.risk_label|default('N/A') }}</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Outreach</span>
      <span class="intel-value">{{ v2.outreach_strategy|default('N/A') }}</span>
    </div>
    {% endif %}
    <div class="intel-item">
      <span class="intel-label">Signals</span>
      <span class="intel-value">{{ report.signals_found }}</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Repos</span>
      <span class="intel-value">{{ report.repos_scanned }}</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Intent</span>
      <span class="intel-value">{{ report.scan_data.intent_score or 0 }}</span>
    </div>
    <div class="intel-item">
      <span class="intel-label">Opportunity</span>
      <span class="intel-value">{{ report.ai_analysis.opportunity_score or 5 }}/10</span>
    </div>
  </div>

  <!-- ===== EXECUTIVE SUMMARY ===== -->
  {% if report.ai_analysis.executive_summary %}
  <div class="summary-bar">
    {{ report.ai_analysis.executive_summary }}
  </div>
  {% endif %}

  <!-- ===== BDR ACTION ALERT ===== -->
  {% if goldilocks_status == 'preparing' %}
  <div class="action-alert action-alert-hot">
    <strong>Action Required:</strong> This company has installed i18n libraries but has zero translation files. The infrastructure is ready, waiting for content. Reach out today.
  </div>
  {% elif goldilocks_status == 'launched' %}
  <div class="action-alert action-alert-low">
    <strong>Low Priority:</strong> This company already has translation files in place. Focus on higher-priority leads. The email draft below is available if needed.
  </div>
  {% endif %}

  <!-- ===== TWO-COLUMN LAYOUT: EMAIL + CONTACTS ===== -->
  <div class="main-grid">

    <!-- LEFT: Email Draft -->
    <div class="panel">
      {% if report.ai_analysis.email_draft %}
      <div class="panel-header">
        <h2>Cold Email Draft</h2>
        <div class="panel-actions">
          <span class="skill-tag">{{ report.ai_analysis.email_draft.skill_applied|default('Cold Outreach') }}</span>
          <button class="btn btn-outline" onclick="copyEmailDraft(this)" id="copyEmailBtn">
            <span class="btn-text">Copy Email</span>
          </button>
          <button class="btn btn-primary" onclick="triggerApolloEnroll(this)" data-report-id="{{ report.id }}">
            <span class="btn-text">Enroll in Apollo</span>
          </button>
        </div>
      </div>
      <div id="selected-contact-banner" class="selected-contact-indicator"></div>
      <div class="email-form">
        <label class="field-label">Subject</label>
        <input type="text" id="emailSubject" class="email-input" value="{{ report.ai_analysis.email_draft.subject|default('') }}">
        <label class="field-label">Body</label>
        <textarea id="emailBody" class="email-textarea" oninput="autoResizeEmailBody(this)">{{ report.ai_analysis.email_draft.body|default('') }}</textarea>
      </div>
      <p class="email-hint">Click any field to personalize. Merge tags auto-resolve when a contributor is selected.</p>
      {% else %}
      <div class="panel-header"><h2>Email Draft</h2></div>
      <p class="empty-state">No email draft generated for this account.</p>
      {% endif %}
    </div>

    <!-- RIGHT: Key Contacts -->
    <div class="panel">
      <div class="panel-header">
        <h2>Key Contacts</h2>
        <span class="contact-count">{{ report.ai_analysis.key_engineering_contacts|length if report.ai_analysis.key_engineering_contacts else 0 }} people</span>
      </div>

      {% if report.ai_analysis.key_engineering_contacts %}
      <div class="contacts-list">
        {% for contact in report.ai_analysis.key_engineering_contacts %}
        {% set details = report.scan_data.contributors.get(contact.login, {}) if report.scan_data.contributors else {} %}
        <div class="contact-card contributor-card" data-contributor-login="{{ contact.login }}"
             onclick='selectContributor(this, {{ contact.name|tojson }}, {{ contact.login|tojson }}, {{ report.company_name|tojson }})'>
          <img src="{{ details.avatar_url or 'https://github.com/identicons/' ~ contact.login ~ '.png' }}"
               class="contact-avatar" alt="{{ contact.name }}">
          <div class="contact-body">
            <div class="contact-name">{{ contact.name }} <span class="contact-handle">@{{ contact.login }}</span></div>
            <div class="contact-role">{{ contact.role_inference }}</div>
            {% if details.bio %}
            <div class="contact-bio">"{{ details.bio }}"</div>
            {% endif %}
            <div class="contact-reason">{{ contact.outreach_reason }}</div>
          </div>
          <div class="contact-actions">
            <button class="btn-sm btn-fetch-email" onclick='event.stopPropagation(); fetchContributorEmail(this, {{ contact.name|tojson }}, {{ report.company_name|tojson }})' data-login="{{ contact.login }}">
              Find Email
            </button>
            <div class="seq-enroll-wrapper" style="position:relative;">
              <button class="btn-sm btn-add-sequence" id="enroll-seq-btn-{{ contact.login }}" data-name="{{ contact.name }}" data-company="{{ report.company_name }}" onclick='event.stopPropagation(); showSequenceSelector({{ contact.login|tojson }}, {{ contact.name|tojson }}, {{ report.company_name|tojson }})'>
                Add to Sequence
              </button>
              <div class="sequence-selector-dropdown" id="seq-dropdown-{{ contact.login }}"></div>
            </div>
            <span class="enrollment-status-text" id="enrollment-status-{{ contact.login }}"></span>
          </div>
          <!-- Inline email composer -->
          <div class="prospect-email-section">
            <span class="email-result" id="email-result-{{ contact.login }}" style="display:none;"></span>
            <button class="btn-compose-email" id="compose-btn-{{ contact.login }}" style="display:none;"
                    onclick='openComposer({{ contact.login|tojson }}, {{ contact.name|tojson }})'>
              Compose &amp; Send
            </button>
            <div class="inline-email-composer" id="composer-{{ contact.login }}">
              <div class="composer-header">
                <h4>Email to {{ contact.name }}</h4>
                <button class="btn-cancel-compose" onclick='closeComposer({{ contact.login|tojson }})'>Cancel</button>
              </div>
              <div class="composer-field">
                <label>To</label>
                <input type="email" id="composer-to-{{ contact.login }}" readonly>
              </div>
              <div class="composer-field">
                <label>Subject</label>
                <input type="text" id="composer-subject-{{ contact.login }}">
              </div>
              <div class="composer-field">
                <label>Body</label>
                <textarea id="composer-body-{{ contact.login }}"></textarea>
              </div>
              <div class="composer-actions">
                <button class="btn-enroll" onclick='sendOutreachEmail({{ contact.login|tojson }}, {{ report.company_name|tojson }}, {{ report.id|tojson }})' id="send-btn-{{ contact.login }}">
                  Enroll
                </button>
                <button class="btn-cancel-compose" onclick='closeComposer({{ contact.login|tojson }})'>Cancel</button>
                <span class="send-status" id="send-status-{{ contact.login }}"></span>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="empty-state">No key contacts identified yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- ===== SUPPORTING INTEL SECTIONS ===== -->
  <div class="intel-sections">

    <!-- Why Reach Out -->
    {% if report.ai_analysis.reachout_reasons %}
    <div class="section">
      <h2 class="section-title">Why Reach Out</h2>
      <div class="reasons-grid">
        {% for reason in report.ai_analysis.reachout_reasons %}
        <div class="reason-card">{{ reason }}</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Outreach Suggestions -->
    {% if report.ai_analysis.outreach_suggestions %}
    <div class="section">
      <h2 class="section-title">Outreach Suggestions</h2>
      <div class="suggestions-list">
        {% for suggestion in report.ai_analysis.outreach_suggestions %}
        <div class="suggestion-item">{{ suggestion }}</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Key Contacts to Find -->
    {% if report.ai_analysis.key_contacts_to_find %}
    <div class="section">
      <h2 class="section-title">Key Contacts to Find</h2>
      <div class="suggestions-list">
        {% for contact_info in report.ai_analysis.key_contacts_to_find %}
        <div class="suggestion-item">{{ contact_info }}</div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Engineering Velocity -->
    {% if report.scan_data.engineering_velocity %}
    <div class="section">
      <h2 class="section-title">Recent Engineering Velocity</h2>
      <div class="velocity-content">{{ report.scan_data.engineering_velocity }}</div>
    </div>
    {% endif %}

    <!-- All Contributors -->
    {% if report.scan_data.contributors %}
    <div class="section contributors-section">
      <h2 class="section-title">Contributors
        <span class="contributor-stats">{{ report.scan_data.contributors|length }} Total &middot; {{ report.scan_data.i18n_contributors|default(0) }} i18n Involved</span>
      </h2>
      <div class="contributors-grid">
        {% for login, contrib in report.scan_data.contributors.items() %}
        <div class="contributor-card mini" data-contributor-login="{{ login }}">
          <img src="{{ contrib.avatar_url or 'https://github.com/identicons/' ~ login ~ '.png' }}" class="contrib-avatar" alt="{{ contrib.name|default(login) }}">
          <div class="contrib-info">
            <div class="contrib-name">{{ contrib.name|default(login) }} <span class="contact-handle">@{{ login }}</span></div>
            <div class="contrib-stats-row">
              <span>{{ contrib.contributions|default(contrib.commits)|default(0) }} commits</span>
              <span>{{ contrib.repos|default(0) }} repos</span>
              {% if contrib.i18n_signals %}
              <span class="i18n-badge">i18n</span>
              {% endif %}
            </div>
            {% if contrib.bio %}
            <div class="contrib-bio">"{{ contrib.bio }}"</div>
            {% endif %}
          </div>
          <div class="contact-actions compact">
            <button class="btn-sm btn-fetch-email" onclick='event.stopPropagation(); fetchContributorEmail(this, {{ (contrib.name|default(login))|tojson }}, {{ report.company_name|tojson }})' data-login="{{ login }}">
              Find Email
            </button>
            <div class="seq-enroll-wrapper" style="position:relative;">
              <button class="btn-sm btn-add-sequence" id="enroll-seq-btn-{{ login }}" data-name="{{ contrib.name|default(login) }}" data-company="{{ report.company_name }}" onclick='event.stopPropagation(); showSequenceSelector({{ login|tojson }}, {{ (contrib.name|default(login))|tojson }}, {{ report.company_name|tojson }})'>
                Add to Sequence
              </button>
              <div class="sequence-selector-dropdown" id="seq-dropdown-{{ login }}"></div>
            </div>
            <span class="enrollment-status-text" id="enrollment-status-{{ login }}"></span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

<!-- Contributor Detail Panel -->
<div class="report-detail-panel" id="reportDetailPanel">
  <div class="detail-panel-header">
    <h3 id="detailPanelTitle">Contributor</h3>
    <button class="detail-panel-close" onclick="closeDetailPanel()" aria-label="Close panel">&times;</button>
  </div>
  <div class="detail-panel-body" id="detailPanelBody">
    <!-- Populated dynamically -->
  </div>
</div>

<!-- Send to BDR Modal -->
<div class="bdr-modal" id="bdrModal" role="dialog" aria-modal="true" aria-labelledby="bdrModalTitle">
  <div class="bdr-modal-content">
    <div class="bdr-modal-header">
      <h3 id="bdrModalTitle">Send to BDR</h3>
      <button class="bdr-modal-close" onclick="closeBDRModal()" aria-label="Close modal" type="button">&times;</button>
    </div>
    <p class="bdr-modal-desc">Send the cold email draft to your BDR's inbox for follow-up.</p>
    <div class="bdr-form-group">
      <label for="bdrEmail">BDR Email Address</label>
      <input type="email" id="bdrEmail" placeholder="bdr@company.com" autocomplete="email">
    </div>
    <div class="bdr-modal-actions">
      <button class="bdr-cancel-btn" onclick="closeBDRModal()">Cancel</button>
      <button class="bdr-send-btn" id="bdrSendBtn" onclick="sendToBDR()">Send Email</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Contributor data for detail panel
    const contributorsData = {{ (report.scan_data.contributors or {})|tojson }};

    // Default Apollo sequence — all enrollment flows use this unless overridden
    const DEFAULT_SEQUENCE_ID = '696ea11188bc73001f2afa87';
    const DEFAULT_SEQUENCE_NAME = 'Test Zapier Workflow';

    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function copyEmailDraft(button) {
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;

        const emailText = `Subject: ${subject}\n\n${body}`;

        navigator.clipboard.writeText(emailText).then(() => {
            button.classList.add('copied');
            button.querySelector('.btn-text').textContent = 'Copied!';

            setTimeout(() => {
                button.classList.remove('copied');
                button.querySelector('.btn-text').textContent = 'Copy Email';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy email. Please select and copy manually.');
        });
    }

    async function triggerApolloEnroll(button) {
        const btnText = button.querySelector('.btn-text');
        const originalText = btnText.textContent;

        if (!selectedContributor) {
            alert('Please select a contributor card first so we know who to enroll.');
            return;
        }

        const subject = document.getElementById('emailSubject').value.trim();
        const body = document.getElementById('emailBody').value.trim();

        button.disabled = true;
        button.classList.add('loading');
        btnText.textContent = 'Enrolling...';

        try {
            // Resolve email — prefer card's cached email, otherwise look up via Apollo
            const card = document.querySelector(`.contributor-card[data-login="${selectedContributor.login}"]`);
            let email = card ? card.dataset.email : null;

            if (!email) {
                btnText.textContent = 'Finding email...';
                const lookupResp = await fetch('/api/apollo-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: selectedContributor.name, company: selectedContributor.company, github_login: selectedContributor.login })
                });
                const lookupData = await lookupResp.json();
                if (lookupData.email) {
                    email = lookupData.email;
                    if (card) card.dataset.email = email;
                } else {
                    throw new Error('Could not find an email for this contributor. Use "Find Email" on their card first.');
                }
            }

            btnText.textContent = 'Enrolling...';
            const nameParts = (selectedContributor.name || '').trim().split(' ');
            const resp = await fetch('/api/apollo/enroll-sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    first_name: nameParts[0] || selectedContributor.login,
                    last_name: nameParts.slice(1).join(' '),
                    sequence_id: DEFAULT_SEQUENCE_ID,
                    company_name: selectedContributor.company || '',
                    personalized_subject: subject,
                    personalized_email_body: body
                })
            });
            const data = await resp.json();

            if (data.status === 'success') {
                button.classList.remove('loading');
                button.classList.add('success');
                btnText.textContent = 'Enrolled!';
                setTimeout(() => {
                    button.classList.remove('success');
                    button.disabled = false;
                    btnText.textContent = originalText;
                }, 3000);
            } else {
                throw new Error(data.message || 'Enrollment failed');
            }

        } catch (error) {
            console.error('Apollo enrollment error:', error);
            alert('Failed to enroll in Apollo: ' + error.message);
            button.classList.remove('loading');
            button.disabled = false;
            btnText.textContent = originalText;
        }
    }

    function showSendToBDRModal() {
        const modal = document.getElementById('bdrModal');
        if (modal) {
            modal.classList.add('active');
            const emailInput = document.getElementById('bdrEmail');
            const savedEmail = localStorage.getItem('bdrEmail');
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (emailInput) emailInput.focus();
        }
    }

    function closeBDRModal() {
        const modal = document.getElementById('bdrModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    async function sendToBDR() {
        const emailInput = document.getElementById('bdrEmail');
        const sendBtn = document.getElementById('bdrSendBtn');
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;
        const toEmail = emailInput.value.trim();

        if (!toEmail) {
            alert('Please enter a BDR email address.');
            return;
        }

        if (!toEmail.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        localStorage.setItem('bdrEmail', toEmail);

        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';

        try {
            const response = await fetch('/api/send-to-bdr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    to_email: toEmail,
                    subject: subject,
                    body: body,
                    company_name: {{ report.company_name|tojson }},
                    report_url: window.location.href
                })
            });

            const data = await response.json();

            if (data.success) {
                sendBtn.textContent = 'Sent!';
                setTimeout(() => {
                    closeBDRModal();
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Email';
                }, 1500);
            } else {
                throw new Error(data.error || 'Failed to send email');
            }
        } catch (error) {
            console.error('Send error:', error);
            alert('Failed to send email: ' + error.message);
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send Email';
        }
    }

    document.getElementById('bdrModal')?.addEventListener('click', function (e) {
        if (e.target === this) closeBDRModal();
    });

    function autoResizeEmailBody(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    }

    // Format revenue displays
    function formatRevenue(value) {
        if (!value) return '';
        // If already formatted (contains letters like M, B, K), return as-is
        if (typeof value === 'string' && /[a-zA-Z$]/.test(value)) {
            return value;
        }
        // Parse the number
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        // Format based on magnitude
        if (num >= 1000000000) {
            return '$' + (num / 1000000000).toFixed(num % 1000000000 === 0 ? 0 : 1) + 'B';
        } else if (num >= 1000000) {
            return '$' + (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 1) + 'M';
        } else if (num >= 1000) {
            return '$' + (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'K';
        }
        return '$' + num.toLocaleString();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const textarea = document.getElementById('emailBody');
        if (textarea) {
            autoResizeEmailBody(textarea);
            textarea.addEventListener('input', () => autoResizeEmailBody(textarea));
        }

        // Format any revenue displays on the page
        document.querySelectorAll('.revenue-display').forEach(el => {
            const rawValue = el.dataset.raw || el.textContent;
            el.textContent = formatRevenue(rawValue);
        });
    });

    function openComposer(login, name) {
        const composer = document.getElementById(`composer-${login}`);
        if (!composer) return;
        composer.classList.add('active');

        // Show selected contact banner in email section
        const banner = document.getElementById('selected-contact-banner');
        if (banner) {
            banner.textContent = `Composing email to: ${name}`;
            banner.classList.add('active');
        }

        composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function closeComposer(login) {
        const composer = document.getElementById(`composer-${login}`);
        const card = composer.closest('.prospect-card');
        composer.classList.remove('active');
        if (card) card.classList.remove('selected');
        
        const banner = document.getElementById('selected-contact-banner');
        if (banner) banner.classList.remove('active');
    }
    
    async function sendOutreachEmail(login, company, reportId) {
        const toEmail = document.getElementById(`composer-to-${login}`).value;
        const subject = document.getElementById(`composer-subject-${login}`).value;
        const body = document.getElementById(`composer-body-${login}`).value;
        const btn = document.getElementById(`send-btn-${login}`);
        const status = document.getElementById(`send-status-${login}`);
        
        if (!toEmail || !subject || !body) {
            status.innerHTML = '<span style="color: #dc3545;">Please fill all fields</span>';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Sending...';
        status.innerHTML = '';
        
        try {
            const resp = await fetch('/api/send-outreach-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ to_email: toEmail, subject, body, company_name: company, report_id: reportId })
            });
            const data = await resp.json();
            
            if (data.status === 'success') {
                btn.textContent = 'Sent!';
                btn.style.background = '#155724';
                status.innerHTML = '<span style="color: #155724;">&#10003; Email sent successfully</span>';
            } else {
                btn.disabled = false;
                btn.textContent = 'Enroll';
                status.innerHTML = `<span style="color: #dc3545;">${escapeHtml(data.message || 'Failed to send')}</span>`;
            }
        } catch(e) {
            btn.disabled = false;
            btn.textContent = 'Enroll';
            status.innerHTML = '<span style="color: #dc3545;">Network error</span>';
        }
    }

    
        // ============================================
        // Contributor Email Workflow
        // ============================================
        
        let selectedContributor = null;
        
        function selectContributor(card, name, login, company) {
            // Deselect previous
            document.querySelectorAll('.contributor-card.selected').forEach(c => c.classList.remove('selected'));

            // Select this card
            card.classList.add('selected');
            selectedContributor = { name, login, company };

            // Open detail panel
            openDetailPanel(login);
            
            // Show selected contact indicator in email draft section
            const banner = document.getElementById('selected-contact-banner');
            if (banner) {
                banner.className = 'selected-contact-indicator visible';
                const avatarUrl = `https://github.com/${login}.png`;
                banner.innerHTML = `
                    <img src="${escapeHtml(avatarUrl)}" class="contact-avatar-sm" alt="${escapeHtml(name)}">
                    <strong>Selected:</strong> ${escapeHtml(name)} (@${escapeHtml(login)})
                    <span style="margin-left: auto; font-size: 0.75rem; color: var(--text-secondary);">Email will be sent to this contributor</span>
                `;
            }
            
            // Update the email draft with personalized content for this contributor
            const subjectEl = document.getElementById('emailSubject');
            const bodyEl = document.getElementById('emailBody');
            if (subjectEl && bodyEl) {
                const firstName = name ? name.split(' ')[0] : login;
                // Resolve all merge tags in subject and body
                {% raw %}
                const mergeTags = {
                    '{{first_name}}': firstName, '{{ first_name }}': firstName,
                    '{{company}}': company || '', '{{ company }}': company || '',
                    '{{name}}': name || login, '{{ name }}': name || login,
                };
                let updatedSubject = subjectEl.value;
                let updatedBody = bodyEl.value;
                for (const [tag, val] of Object.entries(mergeTags)) {
                    if (tag && val) {
                        if (updatedSubject.includes(tag)) updatedSubject = updatedSubject.replaceAll(tag, val);
                        if (updatedBody.includes(tag)) updatedBody = updatedBody.replaceAll(tag, val);
                    }
                }
                // Also fix greeting patterns (Hey/Hi/Hello)
                updatedBody = updatedBody.replace(/^(Hey|Hi|Hello) \{\{first_name\}\}/m, `$1 ${firstName}`);
                {% endraw %}
                subjectEl.value = updatedSubject;
                bodyEl.value = updatedBody;
            }
            
            // Pre-fill composer to field if we have an email from the card
            const composerTo = document.getElementById(`composer-to-${login}`);
            if (composerTo && card && card.dataset.email) {
                composerTo.value = card.dataset.email;
            }
            
            // Scroll to email draft section
            const emailSection = document.querySelector('.email-draft-section');
            if (emailSection) {
                emailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        async function fetchContributorEmail(button, name, company) {
            button.disabled = true;
            button.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Fetching...';

            const card = button.closest('.contributor-card');
            const login = card ? card.dataset.contributorLogin : (button.dataset.login || null);

            try {
                const response = await fetch('/api/apollo-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, company: company, github_login: login || '' })
                });

                const data = await response.json();

                // Treat both 'success' and 'domain_mismatch' as usable when email exists
                if (data.email && (data.status === 'success' || data.status === 'domain_mismatch')) {
                    const isVerified = data.email_status === 'verified';
                    const isDomainMismatch = data.status === 'domain_mismatch';
                    // Store email on the card for later use by enroll
                    if (card) card.dataset.email = data.email;

                    button.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${escapeHtml(data.email)}`;
                    button.style.background = isDomainMismatch ? '#fef3c7' : '#d1fae5';
                    button.style.color = isDomainMismatch ? '#92400e' : '#065f46';
                    button.style.borderColor = isDomainMismatch ? '#fde68a' : '#a7f3d0';
                    button.classList.add('email-found');
                    if (isDomainMismatch) {
                        button.title = `Email found at ${data.organization || 'different org'} — verify before enrolling`;
                    }

                    // Show verification badge next to button
                    let badge = button.nextElementSibling;
                    if (!badge || !badge.classList.contains('email-verify-badge')) {
                        badge = document.createElement('span');
                        badge.className = 'email-verify-badge';
                        button.after(badge);
                    }
                    badge.className = `email-verify-badge ${isVerified ? 'email-badge-verified' : 'email-badge-unverified'}`;
                    badge.textContent = isVerified ? 'Verified' : 'Unverified';

                    // Enable the "Add to Sequence" button on this card
                    if (card) {
                        const seqBtn = card.querySelector('.btn-add-sequence');
                        if (seqBtn) seqBtn.disabled = false;
                    }

                    // Update composer to field if exists
                    if (login) {
                        const composerTo = document.getElementById(`composer-to-${login}`);
                        if (composerTo) composerTo.value = data.email;
                    }
                } else if (data.status === 'not_found') {
                    button.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Not Found';
                    button.style.background = '#fee2e2';
                    button.style.color = '#991b1b';
                    button.style.borderColor = '#fecaca';
                } else {
                    button.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> ${escapeHtml(data.message || 'Error')}`;
                    button.style.background = '#fee2e2';
                    button.style.color = '#991b1b';
                }
            } catch (error) {
                console.error('Email fetch error:', error);
                button.innerHTML = 'Error';
                button.style.background = '#fee2e2';
                button.style.color = '#991b1b';
            }

            setTimeout(() => { button.disabled = false; }, 2000);
        }
        
        async function sendContributorEmail(login, company) {
            const toEl = document.getElementById(`composer-to-${login}`);
            const subjectEl = document.getElementById(`composer-subject-${login}`);
            const bodyEl = document.getElementById(`composer-body-${login}`);
            
            if (!toEl || !toEl.value) {
                alert('Please fetch the email address first.');
                return;
            }
            
            const enrollBtn = event.target;
            enrollBtn.disabled = true;
            enrollBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/send-outreach-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: toEl.value,
                        subject: subjectEl.value,
                        body: bodyEl.value,
                        company_name: company,
                        report_id: '{{ report.id }}'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    enrollBtn.textContent = 'Sent!';
                    enrollBtn.style.background = '#059669';
                } else {
                    enrollBtn.textContent = 'Failed';
                    enrollBtn.style.background = '#ef4444';
                    alert('Send failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Send error:', error);
                enrollBtn.textContent = 'Error';
                enrollBtn.style.background = '#ef4444';
            }
            
            setTimeout(() => {
                enrollBtn.disabled = false;
                enrollBtn.textContent = 'Enroll';
                enrollBtn.style.background = '#10b981';
            }, 3000);
        }

        // ============================================
        // Apollo Sequence Enrollment
        // ============================================

        let apolloSequencesCache = null;
        let sequencesCacheLoading = false;
        let sequencesCacheCallbacks = [];

        async function loadApolloSequences() {
            if (apolloSequencesCache) return apolloSequencesCache;

            if (sequencesCacheLoading) {
                return new Promise((resolve, reject) => {
                    sequencesCacheCallbacks.push({ resolve, reject });
                });
            }

            sequencesCacheLoading = true;
            try {
                const resp = await fetch('/api/apollo/sequences');
                const data = await resp.json();

                if (data.status === 'success') {
                    apolloSequencesCache = data.sequences;
                } else {
                    apolloSequencesCache = { error: data.message || data.code || 'Failed to load sequences' };
                }
                sequencesCacheCallbacks.forEach(cb => cb.resolve(apolloSequencesCache));
                sequencesCacheCallbacks = [];
                return apolloSequencesCache;
            } catch (e) {
                const err = { error: 'Network error loading sequences' };
                sequencesCacheCallbacks.forEach(cb => cb.resolve(err));
                sequencesCacheCallbacks = [];
                apolloSequencesCache = err;
                return err;
            } finally {
                sequencesCacheLoading = false;
            }
        }

        function closeAllSequenceDropdowns() {
            document.querySelectorAll('.sequence-selector-dropdown.open').forEach(d => d.classList.remove('open'));
        }

        async function showSequenceSelector(login, name, company) {
            closeAllSequenceDropdowns();

            const dropdown = document.getElementById(`seq-dropdown-${login}`);
            if (!dropdown) return;

            dropdown.innerHTML = '<div class="sequence-loading">Loading sequences...</div>';
            dropdown.classList.add('open');

            const sequences = await loadApolloSequences();

            if (sequences.error) {
                dropdown.innerHTML = `<div class="sequence-error">${sequences.error}</div>`;
                return;
            }

            if (!sequences.length) {
                dropdown.innerHTML = '<div class="sequence-empty">No sequences found in Apollo</div>';
                return;
            }

            // Sort so default sequence always appears first
            const sortedSeqs = [...sequences].sort((a, b) => {
                if (a.id === DEFAULT_SEQUENCE_ID) return -1;
                if (b.id === DEFAULT_SEQUENCE_ID) return 1;
                return 0;
            });

            let html = '<div class="sequence-selector-header">Select a Sequence</div>';
            sortedSeqs.forEach(seq => {
                const dotClass = seq.active ? 'active' : 'inactive';
                const safeName = seq.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                const isDefault = seq.id === DEFAULT_SEQUENCE_ID;
                const inactiveTooltip = !seq.active ? ' title="This sequence is paused in Apollo — contacts can still be added but emails won\'t send until it\'s activated"' : '';
                html += `
                    <div class="sequence-option${isDefault ? ' sequence-option-default' : ''}${!seq.active ? ' sequence-option-paused' : ''}" data-seq-id="${seq.id}" data-seq-name="${safeName}" data-login="${login}"${inactiveTooltip} onclick="event.stopPropagation(); enrollInSequence(this.dataset.login, this.closest('.sequence-selector-dropdown').previousElementSibling.dataset.name, this.closest('.sequence-selector-dropdown').previousElementSibling.dataset.company, this.dataset.seqId, this.dataset.seqName)">
                        <div>
                            <span class="sequence-option-active ${dotClass}"></span>
                            <span class="sequence-option-name">${safeName}</span>
                            ${!seq.active ? '<span class="sequence-paused-badge">Paused</span>' : ''}
                            ${isDefault ? '<span class="sequence-default-badge">Default</span>' : ''}
                        </div>
                        <span class="sequence-option-meta">${seq.num_steps} steps</span>
                    </div>
                `;
            });

            dropdown.innerHTML = html;
        }

        async function enrollInSequence(login, name, company, sequenceId, sequenceName) {
            closeAllSequenceDropdowns();

            const btn = document.getElementById(`enroll-seq-btn-${login}`);
            const statusEl = document.getElementById(`enrollment-status-${login}`);

            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Enrolling...';
            }

            // Step 1: Check if email is already fetched (stored on the card)
            const card = btn ? btn.closest('.contributor-card') : null;
            let email = card ? card.dataset.email : null;

            if (!email) {
                // Auto-fetch email first
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status pending">Fetching email...</span>';

                try {
                    const lookupResp = await fetch('/api/apollo-lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, company: company, github_login: login })
                    });
                    const lookupData = await lookupResp.json();

                    if ((lookupData.status === 'success' || lookupData.status === 'domain_mismatch') && lookupData.email) {
                        email = lookupData.email;
                        if (card) card.dataset.email = email;
                        const fetchBtn = card ? card.querySelector('.btn-fetch-email') : null;
                        if (fetchBtn) {
                            const isDomainMismatch = lookupData.status === 'domain_mismatch';
                            fetchBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${email}`;
                            fetchBtn.style.background = isDomainMismatch ? '#fef3c7' : '#d1fae5';
                            fetchBtn.style.color = isDomainMismatch ? '#92400e' : '#065f46';
                            fetchBtn.style.borderColor = isDomainMismatch ? '#fcd34d' : '#a7f3d0';
                            fetchBtn.classList.add('email-found');
                        }
                    } else {
                        if (btn) {
                            btn.classList.remove('loading');
                            btn.classList.add('error');
                            btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> No Email Found';
                            setTimeout(() => { resetEnrollBtn(btn); }, 3000);
                        }
                        if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not find email for this contributor</span>';
                        return;
                    }
                } catch (e) {
                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('error');
                        btn.innerHTML = 'Lookup Failed';
                        setTimeout(() => { resetEnrollBtn(btn); }, 3000);
                    }
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Email lookup failed</span>';
                    return;
                }
            }

            // Step 2: Enroll in sequence
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Enrolling in "${sequenceName}"...</span>`;

            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            try {
                const draftSubject = (document.getElementById('emailSubject') || {}).value || '';
                const draftBody = (document.getElementById('emailBody') || {}).value || '';
                const resp = await fetch('/api/apollo/enroll-sequence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        sequence_id: sequenceId,
                        company_name: company,
                        github_login: login,
                        personalized_subject: draftSubject,
                        personalized_email_body: draftBody
                    })
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('success');
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Enrolled!';
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status enrolled">Enrolled in "${sequenceName}"</span>`;
                } else {
                    // Translate raw API errors to user-friendly messages
                    let friendlyMsg = 'Enrollment failed. Please try again.';
                    const rawMsg = (data.message || '').toLowerCase();
                    if (rawMsg.includes('422') || rawMsg.includes('unprocessable')) {
                        friendlyMsg = 'Find a valid email first before enrolling in a sequence.';
                    } else if (rawMsg.includes('404') || rawMsg.includes('not found')) {
                        friendlyMsg = 'Sequence not found. It may have been deleted in Apollo.';
                    } else if (rawMsg.includes('401') || rawMsg.includes('unauthorized')) {
                        friendlyMsg = 'Apollo API key is invalid or expired. Check settings.';
                    } else if (rawMsg.includes('already') || rawMsg.includes('duplicate')) {
                        friendlyMsg = 'This contact is already enrolled in this sequence.';
                    }

                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('error');
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Failed';
                        setTimeout(() => { resetEnrollBtn(btn); }, 4000);
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status error">${friendlyMsg}</span>`;
                }
            } catch (e) {
                if (btn) {
                    btn.classList.remove('loading');
                    btn.classList.add('error');
                    btn.innerHTML = 'Error';
                    setTimeout(() => { resetEnrollBtn(btn); }, 4000);
                }
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not connect to Apollo. Check your network and try again.</span>';
            }
        }

        function resetEnrollBtn(btn) {
            btn.classList.remove('loading', 'success', 'error');
            btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> Enroll in Sequence';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-enroll-sequence') && !e.target.closest('.sequence-selector-dropdown')) {
                closeAllSequenceDropdowns();
            }
        });

        // ============================================
        // Item 1: Contributor Detail Panel
        // ============================================
        function openDetailPanel(login) {
            const panel = document.getElementById('reportDetailPanel');
            const body = document.getElementById('detailPanelBody');
            const title = document.getElementById('detailPanelTitle');
            if (!panel || !body) return;

            const contrib = contributorsData[login] || {};
            const name = contrib.name || login;
            const avatarUrl = contrib.avatar_url || ('https://github.com/' + login + '.png');
            const bio = contrib.bio || '';
            const contributions = contrib.contributions || contrib.commits || 0;
            const repos = contrib.repos || 0;
            const company = {{ report.company_name|tojson }};

            title.textContent = name;
            body.innerHTML = `
                <div style="display:flex;align-items:center;gap:0.75rem;">
                    <img src="${escapeHtml(avatarUrl)}" class="detail-panel-avatar" alt="${escapeHtml(name)}">
                    <div>
                        <div class="detail-panel-name">${escapeHtml(name)}</div>
                        <div class="detail-panel-handle"><a href="https://github.com/${escapeHtml(login)}" target="_blank">@${escapeHtml(login)}</a></div>
                    </div>
                </div>
                ${bio ? `<div class="detail-panel-field"><span class="detail-panel-field-label">Bio</span><span class="detail-panel-field-value">${escapeHtml(bio)}</span></div>` : ''}
                <div class="detail-panel-field">
                    <span class="detail-panel-field-label">Contributions</span>
                    <span class="detail-panel-field-value">${contributions} commits across ${repos} repos</span>
                </div>
                ${contrib.i18n_signals ? '<div class="detail-panel-field"><span class="detail-panel-field-label">i18n Signals</span><span class="detail-panel-field-value"><span class="i18n-badge">i18n involved</span></span></div>' : ''}
                <div class="detail-panel-actions">
                    <button class="btn-sm btn-fetch-email" onclick='event.stopPropagation(); fetchContributorEmail(this, ${JSON.stringify(name)}, ${JSON.stringify(company)})' data-login="${login}">
                        Find Email
                    </button>
                    <div class="seq-enroll-wrapper" style="position:relative;">
                        <button class="btn-sm btn-add-sequence" onclick='event.stopPropagation(); showSequenceSelector(${JSON.stringify(login)}, ${JSON.stringify(name)}, ${JSON.stringify(company)})' data-name="${name}" data-company="${company}">
                            Add to Sequence
                        </button>
                        <div class="sequence-selector-dropdown" id="seq-dropdown-${login}"></div>
                    </div>
                </div>
            `;

            panel.classList.add('open');
        }

        function closeDetailPanel() {
            const panel = document.getElementById('reportDetailPanel');
            if (panel) panel.classList.remove('open');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') closeDetailPanel();
        });

        // ============================================
        // Item 4: Sticky Header (IntersectionObserver)
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const hero = document.getElementById('reportHero');
            const stickyHeader = document.getElementById('reportStickyHeader');
            if (hero && stickyHeader) {
                const observer = new IntersectionObserver(function(entries) {
                    entries.forEach(function(entry) {
                        stickyHeader.classList.toggle('visible', !entry.isIntersecting);
                    });
                }, { threshold: 0 });
                observer.observe(hero);
            }
        });

        // One-click Enrich & Enroll flow
        async function enrichAndEnroll(btn) {
            const login = btn.dataset.login;
            const name = btn.dataset.name;
            const company = btn.dataset.company;
            const card = btn.closest('.contributor-card');
            const statusEl = document.getElementById(`enrollment-status-${login}`);
            const origHTML = btn.innerHTML;

            btn.disabled = true;

            // Step 1: Find email
            btn.className = 'btn-enrich-enroll step-email';
            btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Finding email...';
            if (statusEl) statusEl.innerHTML = '<span class="enrollment-status pending">Step 1/3: Finding email...</span>';

            let email = card ? card.dataset.email : null;

            if (!email) {
                try {
                    const lookupResp = await fetch('/api/apollo-lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, company: company, github_login: login })
                    });
                    const lookupData = await lookupResp.json();

                    if ((lookupData.status === 'success' || lookupData.status === 'domain_mismatch') && lookupData.email) {
                        email = lookupData.email;
                        if (card) card.dataset.email = email;
                        // Update the Find Email button too
                        const fetchBtn = card ? card.querySelector('.btn-fetch-email') : null;
                        if (fetchBtn) {
                            const isDomainMismatch = lookupData.status === 'domain_mismatch';
                            fetchBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${email}`;
                            fetchBtn.style.background = isDomainMismatch ? '#fef3c7' : '#d1fae5';
                            fetchBtn.style.color = isDomainMismatch ? '#92400e' : '#065f46';
                            fetchBtn.style.borderColor = isDomainMismatch ? '#fcd34d' : '#a7f3d0';
                            fetchBtn.classList.add('email-found');
                        }
                    } else {
                        btn.className = 'btn-enrich-enroll step-error';
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> No email found';
                        if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not find an email for this contributor.</span>';
                        setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                        return;
                    }
                } catch (e) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'Lookup failed';
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Email lookup failed. Check your network.</span>';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    return;
                }
            }

            // Step 2: Load sequences and show picker
            btn.className = 'btn-enrich-enroll step-enroll';
            btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Pick sequence...';
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Step 2/3: Email found (${email}). Choose a sequence...</span>`;

            try {
                const sequences = await loadApolloSequences();
                if (!sequences || sequences.length === 0) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'No sequences';
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">No Apollo sequences available.</span>';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    return;
                }

                // Show inline sequence picker as a dropdown from this button
                let picker = btn.nextElementSibling;
                if (!picker || !picker.classList.contains('enrich-sequence-picker')) {
                    picker = document.createElement('div');
                    picker.className = 'enrich-sequence-picker sequence-selector-dropdown';
                    btn.after(picker);
                }

                picker.innerHTML = sequences.map(seq =>
                    `<div class="sequence-option" onclick='completeEnrichEnroll(this, ${JSON.stringify(login)}, ${JSON.stringify(name)}, ${JSON.stringify(company)}, ${JSON.stringify(seq.id)}, ${JSON.stringify(seq.name)})'>
                        <span class="sequence-option-name">${seq.name}</span>
                        <span class="sequence-option-meta">${seq.num_steps} steps</span>
                    </div>`
                ).join('');
                picker.style.display = 'block';
                picker.style.position = 'absolute';
                picker.style.top = '100%';
                picker.style.left = '0';
                picker.style.zIndex = '100';

                btn.disabled = false;
                btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Pick sequence...';

            } catch (e) {
                btn.className = 'btn-enrich-enroll step-error';
                btn.innerHTML = 'Error loading sequences';
                setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
            }
        }

        async function completeEnrichEnroll(optionEl, login, name, company, sequenceId, sequenceName) {
            const picker = optionEl.closest('.enrich-sequence-picker');
            if (picker) picker.style.display = 'none';

            const card = optionEl.closest('.contributor-card');
            const btn = card ? card.querySelector('.btn-enrich-enroll') : null;
            const statusEl = document.getElementById(`enrollment-status-${login}`);
            const email = card ? card.dataset.email : null;

            if (!email) return;

            if (btn) {
                btn.disabled = true;
                btn.className = 'btn-enrich-enroll step-enroll';
                btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Enrolling...';
            }
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Step 3/3: Enrolling in "${sequenceName}"...</span>`;

            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            try {
                const draftSubject = (document.getElementById('emailSubject') || {}).value || '';
                const draftBody = (document.getElementById('emailBody') || {}).value || '';
                const resp = await fetch('/api/apollo/enroll-sequence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        sequence_id: sequenceId,
                        company_name: company,
                        github_login: login,
                        personalized_subject: draftSubject,
                        personalized_email_body: draftBody
                    })
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    if (btn) {
                        btn.className = 'btn-enrich-enroll step-done';
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Done!';
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status enrolled">Enrolled in "${sequenceName}"</span>`;
                } else {
                    let friendlyMsg = 'Enrollment failed. Please try again.';
                    const rawMsg = (data.message || '').toLowerCase();
                    if (rawMsg.includes('422')) friendlyMsg = 'Find a valid email first.';
                    else if (rawMsg.includes('already') || rawMsg.includes('duplicate')) friendlyMsg = 'Already enrolled in this sequence.';

                    if (btn) {
                        btn.className = 'btn-enrich-enroll step-error';
                        btn.innerHTML = 'Failed';
                        const origHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Enrich & Enroll';
                        setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status error">${friendlyMsg}</span>`;
                }
            } catch (e) {
                if (btn) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'Network error';
                    const origHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Enrich & Enroll';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                }
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Network error. Try again.</span>';
            }
        }

        function resetEnrichBtn(btn, origHTML) {
            btn.disabled = false;
            btn.className = 'btn-enrich-enroll';
            btn.innerHTML = origHTML;
        }

    </script>
{% endblock %}
