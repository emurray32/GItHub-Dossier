{% extends "base.html" %}

{% block title %}{{ report.company_name }} Report - Lead Machine{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('accounts') }}">
                <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Accounts
            </a>
        </li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item">
            <a href="{{ url_for('history') }}">Reports</a>
        </li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item active" aria-current="page">{{ report.company_name }}</li>
    </ol>
</nav>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
{% endblock %}

{% block content %}
<div class="report-container">
    <header class="report-header">
        <h2 class="report-title">{{ report.company_name|title }}</h2>
        <div class="report-org">
            <a href="{{ report.scan_data.org_url }}" target="_blank">@{{ report.github_org }}</a>
        </div>
        <div class="report-meta">
            <span>{{ report.created_at }}</span>
            <span>{{ "%.1f"|format(report.scan_duration_seconds) }}s</span>
            {% if report.website %}
            <span><a href="{{ report.website|normalize_url }}" target="_blank">{{ report.website }}</a></span>
            {% endif %}
            {% if report.annual_revenue %}
            <span class="revenue-display">{{ report.annual_revenue|format_revenue }}</span>
            {% endif %}
        </div>
    </header>

    <!-- Goldilocks Zone Status Banner -->
    {% set goldilocks_status = report.scan_data.goldilocks_status or report.ai_analysis.goldilocks_status or 'none' %}
    {% set lead_status = report.scan_data.lead_status or report.ai_analysis.lead_status or '' %}

    {% if goldilocks_status == 'preparing' %}
    <div class="goldilocks-banner goldilocks-preparing">
        <div class="status-content">
            <span class="badge badge-success">Preparing</span>
            <div class="status-title">Call Now</div>
            <div class="status-subtitle">Goldilocks signal detected</div>
            <ul class="status-points">
                <li>Infrastructure is ready, but no translation files exist yet.</li>
            </ul>
        </div>
    </div>
    {% elif goldilocks_status == 'thinking' %}
    <div class="goldilocks-banner goldilocks-thinking">
        <div class="status-content">
            <span class="badge badge-warning">Thinking</span>
            <div class="status-title">Warm Lead</div>
            <div class="status-subtitle">Early momentum</div>
            <ul class="status-points">
                <li>They are discussing i18n but have not started building.</li>
            </ul>
        </div>
    </div>
    {% elif goldilocks_status == 'launched' %}
    <div class="goldilocks-banner goldilocks-launched">
        <div class="status-content">
            <span class="badge badge-neutral">Launched</span>
            <div class="status-title">Too Late</div>
            <div class="status-subtitle">Localization is already live</div>
            <ul class="status-points">
                <li>Translation files already exist, so localization is live.</li>
            </ul>
        </div>
    </div>
    {% else %}
    <div class="goldilocks-banner goldilocks-none">
        <div class="status-content">
            <span class="badge badge-neutral">No Signals</span>
            <div class="status-title">Cold Lead</div>
            <div class="status-subtitle">Keep monitoring</div>
            <ul class="status-points">
                <li>No significant i18n signals detected.</li>
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Scoring V2 Intelligence Panel -->
    {% if report.scan_data.scoring_v2 %}
    {% set v2 = report.scan_data.scoring_v2 %}
    <div class="scoring-v2-panel" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <span style="font-weight: 700; font-size: 0.875rem; color: #334155;">Scoring V2</span>
            <span style="font-size: 0.75rem; color: #94a3b8; background: #f1f5f9; padding: 0.125rem 0.5rem; border-radius: 4px;">Bayesian Engine</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
            <!-- Maturity Badge -->
            <div style="text-align: center;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Maturity</div>
                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; color: white; background-color: {{ v2.org_maturity_color or '#6b7280' }};">{{ v2.org_maturity_label or 'Unknown' }}</span>
            </div>
            <!-- Readiness Index -->
            <div style="text-align: center;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Readiness</div>
                <div style="position: relative; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin: 0.375rem 0;">
                    <div style="position: absolute; left: 0; top: 0; height: 100%; width: {{ (v2.readiness_index or 0) * 100 }}%; background: linear-gradient(90deg, #3b82f6, #10b981); border-radius: 4px;"></div>
                </div>
                <div style="font-size: 0.85rem; font-weight: 600; color: #1e293b;">{{ "%.0f"|format((v2.readiness_index or 0) * 100) }}%</div>
            </div>
            <!-- Confidence -->
            <div style="text-align: center;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Confidence</div>
                <div style="font-size: 1.25rem; font-weight: 700; color: #1e293b;">{{ "%.0f"|format(v2.confidence_percent or 0) }}%</div>
            </div>
            <!-- Risk Level -->
            <div style="text-align: center;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Risk</div>
                {% if v2.risk_level == 'low' %}
                <span style="color: #16a34a; font-weight: 600; font-size: 0.85rem;">LOW</span>
                {% elif v2.risk_level == 'medium' %}
                <span style="color: #ea580c; font-weight: 600; font-size: 0.85rem;">MEDIUM</span>
                {% else %}
                <span style="color: #dc2626; font-weight: 600; font-size: 0.85rem;">HIGH</span>
                {% endif %}
            </div>
            <!-- Outreach Angle -->
            <div style="text-align: center;">
                <div style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.25rem;">Outreach</div>
                <div style="font-size: 0.8rem; font-weight: 600; color: #1e40af;">{{ v2.outreach_angle_label or 'Unknown' }}</div>
            </div>
        </div>
        {% if v2.signal_clusters_detected %}
        <div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e2e8f0;">
            <span style="font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b;">Signal clusters:</span>
            {% for cluster in v2.signal_clusters_detected %}
            <span style="display: inline-block; padding: 0.125rem 0.5rem; margin: 0.125rem; border-radius: 4px; font-size: 0.75rem; background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe;">{{ cluster.replace('_', ' ').title() }}</span>
            {% endfor %}
        </div>
        {% endif %}
        {% if v2.recommended_sales_motion %}
        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #475569; font-style: italic;">{{ v2.recommended_sales_motion }}</div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Stats Row (pills) -->
    <div class="stats-row">
        <span class="stat-pill"><span class="stat-pill-value">{{ report.signals_found }}</span> <span class="stat-pill-label">signals</span></span>
        <span class="stat-pill"><span class="stat-pill-value">{{ report.repos_scanned }}</span> <span class="stat-pill-label">repos</span></span>
        <span class="stat-pill"><span class="stat-pill-value">{{ report.scan_data.intent_score or 0 }}</span> <span class="stat-pill-label">intent</span></span>
        <span class="stat-pill"><span class="stat-pill-value">{{ report.ai_analysis.opportunity_score or 5 }}/10</span> <span class="stat-pill-label">opportunity</span></span>
    </div>

    <!-- Executive Summary -->
    {% if report.ai_analysis.executive_summary %}
    <div class="executive-summary">
        {{ report.ai_analysis.executive_summary }}
    </div>
    {% endif %}


    <!-- BDR Quick Action Box (moved above email for action hierarchy) -->
    {% if goldilocks_status == 'preparing' %}
    <div class="bdr-highlight bdr-highlight-critical">
        <div class="bdr-label">BDR Action Required</div>
        <div class="bdr-text">This company has installed i18n libraries but has zero translation files. The
            infrastructure is ready, waiting for content. Reach out today â€” they need help filling the gap.</div>
    </div>
    {% elif goldilocks_status == 'launched' %}
    <div class="bdr-highlight bdr-highlight-warning">
        <div class="bdr-label">Low Priority Lead</div>
        <div class="bdr-text">This company already has translation files in place. They have a working i18n system.
            Focus on higher-priority leads. The email draft below is available if needed, but consider other accounts first.</div>
    </div>
    {% endif %}

    <!-- Email Draft (One-Click Cold Email Generator) -->
    {% if report.ai_analysis.email_draft %}
    <div class="email-draft-section{% if goldilocks_status == 'launched' %} email-draft-deprioritized{% endif %}">
        <div class="email-draft-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <h3 style="margin: 0;">Ready-to-Send Cold Email</h3>
                <div id="selected-contact-banner" class="selected-contact-banner"></div>
                <span class="badge badge-primary">Skill Applied: Cold Outreach</span>
            </div>
            <div class="email-actions">
                <button class="copy-email-btn" onclick="copyEmailDraft(this)" id="copyEmailBtn">
                    <span class="copy-icon copy-icon--default" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2"></rect>
                            <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                        </svg>
                    </span>
                    <span class="copy-icon copy-icon--success" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <path d="M20 6L9 17l-5-5"></path>
                        </svg>
                    </span>
                    <span class="btn-text">Copy Email</span>
                </button>
                <button class="btn-apollo" onclick="triggerApolloEnroll(this)" id="enrollApolloBtn" data-report-id="{{ report.id }}">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 8v8"></path>
                        <path d="M8 12h8"></path>
                    </svg>
                    <span class="btn-text">Enroll in Apollo</span>
                </button>
            </div>
        </div>
        <div class="email-draft-content" style="padding: 1.25rem 1.5rem;">
            <div class="email-edit-hint">Click any field to personalize before sending. Merge tags auto-resolve when a contributor is selected.</div>
            <div class="email-subject" style="margin-bottom: 1rem;">
                <span class="email-subject-label">Subject Line</span>
                <input id="emailSubject" class="email-edit-field email-subject-input" type="text"
                    value="{{ report.ai_analysis.email_draft.subject }}" placeholder="Enter subject line...">
            </div>
            <div>
                <span class="email-body-label">Email Body</span>
                <textarea id="emailBody" class="email-edit-field email-body-textarea"
                    style="min-height: 200px;" placeholder="Write your email body...">{{ report.ai_analysis.email_draft.body }}</textarea>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- BDR Quick Action Box moved above email draft for visibility -->

    <!-- Why Reach Out -->
    {% set scan_data = report.scan_data or {} %}
    <div class="reachout-summary">
        <h2 class="reachout-title">Why Reach Out</h2>
        <div class="reachout-subtitle">Clear, plain-language reasons to start a conversation.</div>
        <ul class="reachout-list">
            {% if report.ai_analysis.pain_point_analysis and report.ai_analysis.pain_point_analysis and report.ai_analysis.pain_point_analysis.strip() not in ['Phase analysis complete.', 'Phase analysis is complete.', 'Analysis complete', 'Analysis complete.', 'Processing done', 'Processing done.', 'Timing analysis complete.', 'Timing analysis complete', 'Scan complete.', 'N/A for pre-launch detection', 'No pain signals detected.', 'Report generated.', 'Data collection complete.', ''] %}
            <li class="reachout-item">
                <span class="reachout-label">Pain signals</span>
                <span class="reachout-text">{{ report.ai_analysis.pain_point_analysis }}</span>
            </li>
            {% endif %}
            {% if scan_data.frustration_signals %}
            <li class="reachout-item">
                <span class="reachout-label">Frustration</span>
                <span class="reachout-text">{{ scan_data.frustration_signals|length }} frustration signals found in
                    recent commits.</span>
            </li>
            {% endif %}
            {% if scan_data.competitor_detection and scan_data.competitor_detection.is_using_competitor %}
            <li class="reachout-item">
                <span class="reachout-label">Competitive swap</span>
                <span class="reachout-text">Signals show they use another localization platform today (possible switch
                    opportunity).</span>
            </li>
            {% endif %}
            {% if scan_data.locale_inventory and scan_data.locale_inventory.language_count %}
            <li class="reachout-item">
                <span class="reachout-label">Active expansion</span>
                <span class="reachout-text">Localization files detected across {{
                    scan_data.locale_inventory.language_count }} language(s).</span>
            </li>
            {% endif %}
            {% if scan_data.is_greenfield %}
            <li class="reachout-item">
                <span class="reachout-label">Greenfield gap</span>
                <span class="reachout-text">Mature repo footprint with no localization tooling in place.</span>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- Maturity & Opportunity - Goldilocks Zone Focused -->



    <!-- Risk Intelligence: Compliance -->
    {% if report.scan_data and report.scan_data.get('compliance_assets') %}
    {% set compliance_assets = report.scan_data.get('compliance_assets', {}) %}
    {% if compliance_assets.get('detected_files') %}
    {% endif %}
    {% endif %}

    <!-- Outreach Suggestions -->
    {% if report.ai_analysis.outreach_suggestions %}
    <div class="section">
        <h2 class="section-title">Outreach Suggestions</h2>
        <p class="text-secondary">{{ report.ai_analysis.outreach_suggestions|length }} tactical angle{{ 's' if report.ai_analysis.outreach_suggestions|length != 1 else '' }} for who to reach, why now, and what to say.</p>
        <div class="suggestions-grid">
            {% for suggestion in report.ai_analysis.outreach_suggestions %}
            <div class="suggestion-card">
                <div class="suggestion-row">
                    <span class="suggestion-label">Why this account</span>
                    <span class="suggestion-text">{{ suggestion.why_account }}</span>
                </div>
                <div class="suggestion-row">
                    <span class="suggestion-label">Why now</span>
                    <span class="suggestion-text">{{ suggestion.why_now }}</span>
                </div>
                <div class="suggestion-row">
                    <span class="suggestion-label">Who to reach</span>
                    <span class="suggestion-text">{{ suggestion.who_to_reach }}</span>
                </div>
                <div class="suggestion-row">
                    <span class="suggestion-label">Message hook</span>
                    <span class="suggestion-text">{{ suggestion.message_hook }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Key Contacts -->
    {% if report.ai_analysis.top_prospects %}
    <!-- Key Contacts Needed -->
    {% if report.ai_analysis.key_contacts_to_find %}
    <div class="section">
        <h2 class="section-title">Key Contacts to Find</h2>
        <div class="contacts-grid">
            {% for contact in report.ai_analysis.key_contacts_to_find %}
            <div class="contact-card">
                <div class="contact-role">{{ contact }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Key Engineering Contacts -->
    {% if report.ai_analysis.key_engineering_contacts %}
    <div class="section">
        <h2 class="section-title">Key Engineering Contacts</h2>
        <p class="text-secondary">Top contributors who may be decision-makers for i18n initiatives.</p>
        <div class="engineering-contacts-grid">
            {% for contact in report.ai_analysis.key_engineering_contacts %}
            <div class="engineering-contact-card">
                {% set details = report.scan_data.contributors.get(contact.login, {}) if report.scan_data.contributors else {} %}
                <img src="{{ details.avatar_url or 'https://github.com/identicons/' ~ contact.login ~ '.png' }}"
                    class="contact-avatar">
                <div class="contact-info">
                    <div class="contact-header">
                        <h3>{{ contact.name }} <span class="contact-login">@{{ contact.login }}</span></h3>
                        <a href="https://github.com/{{ contact.login }}" target="_blank" class="signal-link">GitHub Profile</a>
                    </div>
                    <div class="contact-role-badge">{{ contact.role_inference }}</div>
                    {% if details.bio %}
                    <div class="contact-bio">"{{ details.bio }}"</div>
                    {% endif %}
                    <div class="contact-reason">{{ contact.outreach_reason }}</div>
                    <!-- Email Workflow for Contact -->
                    <div class="prospect-email-section">
                        <button class="btn-fetch-email" onclick="fetchApolloEmail(this, {{ contact.name|tojson }}, {{ contact.login|tojson }}, {{ report.company_name|tojson }})" data-login="{{ contact.login }}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            Fetch Email
                        </button>
                        <span class="email-result" id="email-result-{{ contact.login }}" style="display:none;"></span>
                        <button class="btn-compose-email" id="compose-btn-{{ contact.login }}" style="display:none;" onclick="openComposer({{ contact.login|tojson }}, {{ contact.name|tojson }})">
                            Compose &amp; Send
                        </button>
                        <div class="inline-email-composer" id="composer-{{ contact.login }}">
                            <div class="composer-header">
                                <h4>Email to {{ contact.name }}</h4>
                                <button class="btn-cancel-compose" onclick="closeComposer({{ contact.login|tojson }})">Cancel</button>
                            </div>
                            <div class="composer-field">
                                <label>To</label>
                                <input type="email" id="composer-to-{{ contact.login }}" readonly>
                            </div>
                            <div class="composer-field">
                                <label>Subject</label>
                                <input type="text" id="composer-subject-{{ contact.login }}">
                            </div>
                            <div class="composer-field">
                                <label>Body</label>
                                <textarea id="composer-body-{{ contact.login }}"></textarea>
                            </div>
                            <div class="composer-actions">
                                <button class="btn-enroll" onclick="sendOutreachEmail({{ contact.login|tojson }}, {{ report.company_name|tojson }}, {{ report.id|tojson }})" id="send-btn-{{ contact.login }}">
                                    Enroll
                                </button>
                                <button class="btn-cancel-compose" onclick="closeComposer({{ contact.login|tojson }})">Cancel</button>
                                <span class="send-status" id="send-status-{{ contact.login }}"></span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Engineering Velocity -->
    {% if report.ai_analysis.engineering_velocity %}
    <div class="section">
        <h2 class="section-title">Recent Engineering Velocity</h2>
        <p class="text-secondary">Timeline of i18n-related activity detected in the codebase.</p>
        <ul class="velocity-timeline">
            {% for item in report.ai_analysis.engineering_velocity %}
            <li class="velocity-item">{{ item }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

{% endif %}
    <!-- Contributors Section -->
    {% if report.scan_data.contributors %}
    {% set signal_repos = [] %}
    {% for signal in report.scan_data.signals %}
        {% if signal.repo and signal.repo not in signal_repos %}
            {% set _ = signal_repos.append(signal.repo) %}
        {% endif %}
    {% endfor %}
    <div class="section contributors-section">
        <h2 class="section-title">Contributors</h2>
        <p class="text-secondary">Top contributors ranked by commit activity, with i18n involvement indicators.</p>

        <!-- Contributors Summary -->
        {% set contributors_list = report.scan_data.contributors.values()|list|sort(attribute='contributions', reverse=true) %}
        {% set i18n_contributors_count = namespace(value=0) %}
        {% for contributor in contributors_list %}
            {% set contrib_repos = contributor.repos if contributor.repos else [] %}
            {% set is_i18n = namespace(value=false) %}
            {% for repo in contrib_repos %}
                {% for signal in report.scan_data.signals %}
                    {% if signal.repo == repo %}
                        {% set is_i18n.value = true %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            {% if is_i18n.value %}
                {% set i18n_contributors_count.value = i18n_contributors_count.value + 1 %}
            {% endif %}
        {% endfor %}
        <div class="contributors-summary">
            <div class="summary-stat">
                <span class="summary-stat-value">{{ contributors_list|length }}</span>
                <span class="summary-stat-label">Total Contributors</span>
            </div>
            <div class="summary-stat">
                <span class="summary-stat-value">{{ i18n_contributors_count.value }}</span>
                <span class="summary-stat-label">i18n Involved</span>
            </div>
            <div class="summary-stat">
                <span class="summary-stat-value">{{ contributors_list|sum(attribute='contributions') }}</span>
                <span class="summary-stat-label">Total Commits</span>
            </div>
        </div>

        <div class="contributors-grid">
            {% for contributor in contributors_list %}
            {% set contrib_repos = contributor.repos if contributor.repos else [] %}
            {% set i18n_repos = [] %}
            {% for repo in contrib_repos %}
                {% for signal in report.scan_data.signals %}
                    {% if signal.repo == repo and repo not in i18n_repos %}
                        {% set _ = i18n_repos.append(repo) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            {% set is_i18n_involved = i18n_repos|length > 0 %}
            <div class="contributor-card{% if is_i18n_involved %} i18n-involved{% endif %}" onclick="selectContributor(this, '{{ contributor.name or contributor.login }}', '{{ contributor.login }}', '{{ report.company_name|title }}')" data-contributor-name="{{ contributor.name or contributor.login }}" data-contributor-login="{{ contributor.login }}">
                <span class="contributor-rank{% if loop.index == 1 %} rank-1{% elif loop.index == 2 %} rank-2{% elif loop.index == 3 %} rank-3{% endif %}">#{{ loop.index }}</span>
                <img src="{{ contributor.avatar_url or 'https://github.com/identicons/' ~ contributor.login ~ '.png' }}"
                    class="contributor-avatar" alt="{{ contributor.name }} avatar">
                <div class="contributor-info">
                    <div class="contributor-header">
                        <h3 class="contributor-name">
                            {{ contributor.name or contributor.login }}
                            <span class="contributor-login">@{{ contributor.login }}</span>
                        </h3>
                        <a href="{{ contributor.github_url or 'https://github.com/' ~ contributor.login }}" target="_blank" class="signal-link">GitHub Profile</a>
                    </div>
                    <div class="contributor-meta">
                        <span class="contributor-badge badge-contributions">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                            {{ contributor.contributions }} commits
                        </span>
                        <span class="contributor-badge badge-repos">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
                            {{ contrib_repos|length }} repos
                        </span>
                        {% if is_i18n_involved %}
                        <span class="contributor-badge badge-i18n">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                            i18n Involved
                        </span>
                        {% else %}
                        <span class="contributor-badge badge-no-i18n">No i18n Signals</span>
                        {% endif %}
                    </div>
                    {% if contributor.bio %}
                    <div class="contributor-bio">"{{ contributor.bio }}"</div>
                    {% endif %}
                    {% if contributor.company %}
                    <div class="contributor-company">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: inline; vertical-align: middle; margin-right: 4px;"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                        {{ contributor.company }}
                    </div>
                    {% endif %}
                    {% if contrib_repos %}
                    <div class="contributor-repos">
                        <strong>Active in:</strong> {{ contrib_repos|join(', ') }}
                    </div>
                    {% endif %}
                    {% if is_i18n_involved %}
                    <div class="i18n-involvement-note">
                        <strong>i18n Context:</strong> Contributed to repos with i18n signals: {{ i18n_repos|join(', ') }}
                    </div>
                    {% endif %}

                    <!-- Action Bar: Find Email + Add to Sequence -->
                    <div class="contributor-action-bar" onclick="event.stopPropagation();">
                        <button class="btn-fetch-email" onclick='fetchContributorEmail(this, {{ (contributor.name or contributor.login)|tojson }}, {{ report.company_name|tojson }})'>
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                            Find Email
                        </button>
                        <div style="position: relative; display: inline-block;">
                            <button class="btn-add-sequence" id="enroll-seq-btn-{{ contributor.login }}" data-login="{{ contributor.login }}" data-name="{{ (contributor.name or contributor.login)|e }}" data-company="{{ report.company_name|title|e }}" onclick="event.stopPropagation(); showSequenceSelector(this.dataset.login, this.dataset.name, this.dataset.company)" disabled>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                                Add to Sequence
                            </button>
                            <div class="sequence-selector-dropdown" id="seq-dropdown-{{ contributor.login }}"></div>
                        </div>
                        <div id="enrollment-status-{{ contributor.login }}" class="enrollment-status-inline"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<button class="print-button" onclick="window.print()" title="Print Report" aria-label="Print Report">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round" aria-hidden="true">
        <path d="M6 9V2h12v7"></path>
        <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"></path>
        <path d="M6 14h12v8H6z"></path>
    </svg>
</button>

<!-- Send to BDR Modal -->
<div class="bdr-modal" id="bdrModal" role="dialog" aria-modal="true" aria-labelledby="bdrModalTitle">
    <div class="bdr-modal-content">
        <div class="bdr-modal-header">
            <h3 id="bdrModalTitle">Send to BDR</h3>
            <button class="bdr-modal-close" onclick="closeBDRModal()" aria-label="Close modal" type="button">&times;</button>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
            Send the cold email draft to your BDR's inbox for follow-up.
        </p>
        <div class="bdr-form-group">
            <label for="bdrEmail">BDR Email Address</label>
            <input type="email" id="bdrEmail" placeholder="bdr@company.com" autocomplete="email">
        </div>
        <div class="bdr-modal-actions">
            <button class="bdr-cancel-btn" onclick="closeBDRModal()">Cancel</button>
            <button class="bdr-send-btn" id="bdrSendBtn" onclick="sendToBDR()">Send Email</button>
        </div>
    </div>
</div>

<script>
    function copyEmailDraft(button) {
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;

        const emailText = `Subject: ${subject}\n\n${body}`;

        navigator.clipboard.writeText(emailText).then(() => {
            button.classList.add('copied');
            button.querySelector('.btn-text').textContent = 'Copied!';

            setTimeout(() => {
                button.classList.remove('copied');
                button.querySelector('.btn-text').textContent = 'Copy Email';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy email. Please select and copy manually.');
        });
    }

    async function triggerApolloEnroll(button) {
        const reportId = button.dataset.reportId;
        const btnText = button.querySelector('.btn-text');
        const originalText = btnText.textContent;

        // Disable button and show loading state
        button.disabled = true;
        button.classList.add('loading');
        btnText.textContent = 'Enrolling...';

        try {
            const response = await fetch('/api/integrations/zapier/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    report_id: parseInt(reportId)
                })
            });

            const data = await response.json();

            if (data.code === 'MISSING_URL') {
                // Prompt user for Zapier URL
                const zapierUrl = prompt(
                    'Zapier webhook URL not configured.\n\n' +
                    'Please enter your Zapier webhook URL:\n' +
                    '(e.g., https://hooks.zapier.com/hooks/catch/...)'
                );

                if (zapierUrl && zapierUrl.trim()) {
                    // Save the URL
                    const saveResponse = await fetch('/api/settings/zapier', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            zapier_url: zapierUrl.trim()
                        })
                    });

                    const saveData = await saveResponse.json();

                    if (saveData.status === 'success') {
                        // Retry the trigger
                        btnText.textContent = 'Retrying...';
                        const retryResponse = await fetch('/api/integrations/zapier/trigger', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                report_id: parseInt(reportId)
                            })
                        });

                        const retryData = await retryResponse.json();

                        if (retryData.status === 'success') {
                            button.classList.remove('loading');
                            button.classList.add('success');
                            btnText.textContent = 'Enrolled!';
                            setTimeout(() => {
                                button.classList.remove('success');
                                button.disabled = false;
                                btnText.textContent = originalText;
                            }, 3000);
                        } else {
                            throw new Error(retryData.message || 'Failed to enroll after saving URL');
                        }
                    } else {
                        throw new Error(saveData.message || 'Failed to save Zapier URL');
                    }
                } else {
                    // User cancelled or empty input
                    button.classList.remove('loading');
                    button.disabled = false;
                    btnText.textContent = originalText;
                    return;
                }
            } else if (data.status === 'success') {
                // Success!
                button.classList.remove('loading');
                button.classList.add('success');
                btnText.textContent = 'Enrolled!';
                setTimeout(() => {
                    button.classList.remove('success');
                    button.disabled = false;
                    btnText.textContent = originalText;
                }, 3000);
            } else {
                throw new Error(data.message || 'Failed to enroll lead');
            }

        } catch (error) {
            console.error('Apollo enrollment error:', error);
            alert('Failed to enroll in Apollo: ' + error.message);
            button.classList.remove('loading');
            button.disabled = false;
            btnText.textContent = originalText;
        }
    }

    function showSendToBDRModal() {
        const modal = document.getElementById('bdrModal');
        if (modal) {
            modal.classList.add('active');
            const emailInput = document.getElementById('bdrEmail');
            const savedEmail = localStorage.getItem('bdrEmail');
            if (savedEmail && emailInput) {
                emailInput.value = savedEmail;
            }
            if (emailInput) emailInput.focus();
        }
    }

    function closeBDRModal() {
        const modal = document.getElementById('bdrModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    async function sendToBDR() {
        const emailInput = document.getElementById('bdrEmail');
        const sendBtn = document.getElementById('bdrSendBtn');
        const subject = document.getElementById('emailSubject').value;
        const body = document.getElementById('emailBody').value;
        const toEmail = emailInput.value.trim();

        if (!toEmail) {
            alert('Please enter a BDR email address.');
            return;
        }

        if (!toEmail.includes('@')) {
            alert('Please enter a valid email address.');
            return;
        }

        localStorage.setItem('bdrEmail', toEmail);

        sendBtn.disabled = true;
        sendBtn.textContent = 'Sending...';

        try {
            const response = await fetch('/api/send-to-bdr', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    to_email: toEmail,
                    subject: subject,
                    body: body,
                    company_name: {{ report.company_name|tojson }},
                    report_url: window.location.href
                })
            });

            const data = await response.json();

            if (data.success) {
                sendBtn.textContent = 'Sent!';
                setTimeout(() => {
                    closeBDRModal();
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Email';
                }, 1500);
            } else {
                throw new Error(data.error || 'Failed to send email');
            }
        } catch (error) {
            console.error('Send error:', error);
            alert('Failed to send email: ' + error.message);
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send Email';
        }
    }

    document.getElementById('bdrModal')?.addEventListener('click', function (e) {
        if (e.target === this) closeBDRModal();
    });

    function autoResizeEmailBody(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = `${textarea.scrollHeight}px`;
    }

    // Format revenue displays
    function formatRevenue(value) {
        if (!value) return '';
        // If already formatted (contains letters like M, B, K), return as-is
        if (typeof value === 'string' && /[a-zA-Z$]/.test(value)) {
            return value;
        }
        // Parse the number
        const num = parseFloat(value);
        if (isNaN(num)) return value;
        // Format based on magnitude
        if (num >= 1000000000) {
            return '$' + (num / 1000000000).toFixed(num % 1000000000 === 0 ? 0 : 1) + 'B';
        } else if (num >= 1000000) {
            return '$' + (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 1) + 'M';
        } else if (num >= 1000) {
            return '$' + (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'K';
        }
        return '$' + num.toLocaleString();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const textarea = document.getElementById('emailBody');
        if (textarea) {
            autoResizeEmailBody(textarea);
            textarea.addEventListener('input', () => autoResizeEmailBody(textarea));
        }

        // Format any revenue displays on the page
        document.querySelectorAll('.revenue-display').forEach(el => {
            const rawValue = el.dataset.raw || el.textContent;
            el.textContent = formatRevenue(rawValue);
        });
    });

    function openComposer(login, name) {
        const composer = document.getElementById(`composer-${login}`);
        if (!composer) return;
        composer.classList.add('active');

        // Show selected contact banner in email section
        const banner = document.getElementById('selected-contact-banner');
        if (banner) {
            banner.textContent = `Composing email to: ${name}`;
            banner.classList.add('active');
        }

        composer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function closeComposer(login) {
        const composer = document.getElementById(`composer-${login}`);
        const card = composer.closest('.prospect-card');
        composer.classList.remove('active');
        if (card) card.classList.remove('selected');
        
        const banner = document.getElementById('selected-contact-banner');
        if (banner) banner.classList.remove('active');
    }
    
    async function sendOutreachEmail(login, company, reportId) {
        const toEmail = document.getElementById(`composer-to-${login}`).value;
        const subject = document.getElementById(`composer-subject-${login}`).value;
        const body = document.getElementById(`composer-body-${login}`).value;
        const btn = document.getElementById(`send-btn-${login}`);
        const status = document.getElementById(`send-status-${login}`);
        
        if (!toEmail || !subject || !body) {
            status.innerHTML = '<span style="color: #dc3545;">Please fill all fields</span>';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Sending...';
        status.innerHTML = '';
        
        try {
            const resp = await fetch('/api/send-outreach-email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ to_email: toEmail, subject, body, company_name: company, report_id: reportId })
            });
            const data = await resp.json();
            
            if (data.status === 'success') {
                btn.textContent = 'Sent!';
                btn.style.background = '#155724';
                status.innerHTML = '<span style="color: #155724;">&#10003; Email sent successfully</span>';
            } else {
                btn.disabled = false;
                btn.textContent = 'Enroll';
                status.innerHTML = `<span style="color: #dc3545;">${data.message || 'Failed to send'}</span>`;
            }
        } catch(e) {
            btn.disabled = false;
            btn.textContent = 'Enroll';
            status.innerHTML = '<span style="color: #dc3545;">Network error</span>';
        }
    }

    
        // ============================================
        // Contributor Email Workflow
        // ============================================
        
        let selectedContributor = null;
        
        function selectContributor(card, name, login, company) {
            // Deselect previous
            document.querySelectorAll('.contributor-card.selected').forEach(c => c.classList.remove('selected'));
            
            // Select this card
            card.classList.add('selected');
            selectedContributor = { name, login, company };
            
            // Show selected contact indicator in email draft section
            const banner = document.getElementById('selected-contact-banner');
            if (banner) {
                banner.className = 'selected-contact-indicator visible';
                const avatarUrl = `https://github.com/${login}.png`;
                banner.innerHTML = `
                    <img src="${avatarUrl}" class="contact-avatar-sm" alt="${name}">
                    <strong>Selected:</strong> ${name} (@${login})
                    <span style="margin-left: auto; font-size: 0.75rem; color: var(--text-secondary);">Email will be sent to this contributor</span>
                `;
            }
            
            // Update the email draft with personalized content for this contributor
            const subjectEl = document.getElementById('emailSubject');
            const bodyEl = document.getElementById('emailBody');
            if (subjectEl && bodyEl) {
                // Keep subject as-is, personalize body opening
                const currentBody = bodyEl.value;
                if (!currentBody.includes(`Hi ${name}`)) {
                    bodyEl.value = currentBody.replace(/^Hi .*?,/m, `Hi ${name},`).replace(/^Hello .*?,/m, `Hi ${name},`);
                }
            }
            
            // Pre-fill composer to field if we have an email from the card
            const composerTo = document.getElementById(`composer-to-${login}`);
            if (composerTo && card && card.dataset.email) {
                composerTo.value = card.dataset.email;
            }
            
            // Scroll to email draft section
            const emailSection = document.querySelector('.email-draft-section');
            if (emailSection) {
                emailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        async function fetchContributorEmail(button, name, company) {
            button.disabled = true;
            button.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Fetching...';

            const card = button.closest('.contributor-card');
            const login = card ? card.dataset.contributorLogin : null;

            try {
                const response = await fetch('/api/apollo-lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, company: company })
                });

                const data = await response.json();

                if (data.status === 'success' && data.email) {
                    const isVerified = data.email_status === 'verified';
                    // Store email on the card for later use by enroll
                    if (card) card.dataset.email = data.email;

                    button.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${data.email}`;
                    button.style.background = '#d1fae5';
                    button.style.color = '#065f46';
                    button.style.borderColor = '#a7f3d0';
                    button.classList.add('email-found');

                    // Show verification badge next to button
                    let badge = button.nextElementSibling;
                    if (!badge || !badge.classList.contains('email-verify-badge')) {
                        badge = document.createElement('span');
                        badge.className = 'email-verify-badge';
                        button.after(badge);
                    }
                    badge.className = `email-verify-badge ${isVerified ? 'email-badge-verified' : 'email-badge-unverified'}`;
                    badge.textContent = isVerified ? 'Verified' : 'Unverified';

                    // Enable the "Add to Sequence" button on this card
                    if (card) {
                        const seqBtn = card.querySelector('.btn-add-sequence');
                        if (seqBtn) seqBtn.disabled = false;
                    }

                    // Update composer to field if exists
                    if (login) {
                        const composerTo = document.getElementById(`composer-to-${login}`);
                        if (composerTo) composerTo.value = data.email;
                    }
                } else if (data.status === 'not_found') {
                    button.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Not Found';
                    button.style.background = '#fee2e2';
                    button.style.color = '#991b1b';
                    button.style.borderColor = '#fecaca';
                } else {
                    button.innerHTML = 'Error';
                    button.style.background = '#fee2e2';
                    button.style.color = '#991b1b';
                }
            } catch (error) {
                console.error('Email fetch error:', error);
                button.innerHTML = 'Error';
                button.style.background = '#fee2e2';
                button.style.color = '#991b1b';
            }

            setTimeout(() => { button.disabled = false; }, 2000);
        }
        
        async function sendContributorEmail(login, company) {
            const toEl = document.getElementById(`composer-to-${login}`);
            const subjectEl = document.getElementById(`composer-subject-${login}`);
            const bodyEl = document.getElementById(`composer-body-${login}`);
            
            if (!toEl || !toEl.value) {
                alert('Please fetch the email address first.');
                return;
            }
            
            const enrollBtn = event.target;
            enrollBtn.disabled = true;
            enrollBtn.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/send-outreach-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to_email: toEl.value,
                        subject: subjectEl.value,
                        body: bodyEl.value,
                        company_name: company,
                        report_id: '{{ report.id }}'
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    enrollBtn.textContent = 'Sent!';
                    enrollBtn.style.background = '#059669';
                } else {
                    enrollBtn.textContent = 'Failed';
                    enrollBtn.style.background = '#ef4444';
                    alert('Send failed: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Send error:', error);
                enrollBtn.textContent = 'Error';
                enrollBtn.style.background = '#ef4444';
            }
            
            setTimeout(() => {
                enrollBtn.disabled = false;
                enrollBtn.textContent = 'Enroll';
                enrollBtn.style.background = '#10b981';
            }, 3000);
        }

        // ============================================
        // Apollo Sequence Enrollment
        // ============================================

        let apolloSequencesCache = null;
        let sequencesCacheLoading = false;
        let sequencesCacheCallbacks = [];

        async function loadApolloSequences() {
            if (apolloSequencesCache) return apolloSequencesCache;

            if (sequencesCacheLoading) {
                return new Promise((resolve, reject) => {
                    sequencesCacheCallbacks.push({ resolve, reject });
                });
            }

            sequencesCacheLoading = true;
            try {
                const resp = await fetch('/api/apollo/sequences');
                const data = await resp.json();

                if (data.status === 'success') {
                    apolloSequencesCache = data.sequences;
                } else {
                    apolloSequencesCache = { error: data.message || data.code || 'Failed to load sequences' };
                }
                sequencesCacheCallbacks.forEach(cb => cb.resolve(apolloSequencesCache));
                sequencesCacheCallbacks = [];
                return apolloSequencesCache;
            } catch (e) {
                const err = { error: 'Network error loading sequences' };
                sequencesCacheCallbacks.forEach(cb => cb.resolve(err));
                sequencesCacheCallbacks = [];
                apolloSequencesCache = err;
                return err;
            } finally {
                sequencesCacheLoading = false;
            }
        }

        function closeAllSequenceDropdowns() {
            document.querySelectorAll('.sequence-selector-dropdown.open').forEach(d => d.classList.remove('open'));
        }

        async function showSequenceSelector(login, name, company) {
            closeAllSequenceDropdowns();

            const dropdown = document.getElementById(`seq-dropdown-${login}`);
            if (!dropdown) return;

            dropdown.innerHTML = '<div class="sequence-loading">Loading sequences...</div>';
            dropdown.classList.add('open');

            const sequences = await loadApolloSequences();

            if (sequences.error) {
                dropdown.innerHTML = `<div class="sequence-error">${sequences.error}</div>`;
                return;
            }

            if (!sequences.length) {
                dropdown.innerHTML = '<div class="sequence-empty">No sequences found in Apollo</div>';
                return;
            }

            let html = '<div class="sequence-selector-header">Select a Sequence</div>';
            sequences.forEach(seq => {
                const dotClass = seq.active ? 'active' : 'inactive';
                const safeName = seq.name.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                html += `
                    <div class="sequence-option" data-seq-id="${seq.id}" data-seq-name="${safeName}" data-login="${login}" onclick="event.stopPropagation(); enrollInSequence(this.dataset.login, this.closest('.sequence-selector-dropdown').previousElementSibling.dataset.name, this.closest('.sequence-selector-dropdown').previousElementSibling.dataset.company, this.dataset.seqId, this.dataset.seqName)">
                        <div>
                            <span class="sequence-option-active ${dotClass}"></span>
                            <span class="sequence-option-name">${safeName}</span>
                        </div>
                        <span class="sequence-option-meta">${seq.num_steps} steps</span>
                    </div>
                `;
            });

            dropdown.innerHTML = html;
        }

        async function enrollInSequence(login, name, company, sequenceId, sequenceName) {
            closeAllSequenceDropdowns();

            const btn = document.getElementById(`enroll-seq-btn-${login}`);
            const statusEl = document.getElementById(`enrollment-status-${login}`);

            if (btn) {
                btn.classList.add('loading');
                btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Enrolling...';
            }

            // Step 1: Check if email is already fetched (stored on the card)
            const card = btn ? btn.closest('.contributor-card') : null;
            let email = card ? card.dataset.email : null;

            if (!email) {
                // Auto-fetch email first
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status pending">Fetching email...</span>';

                try {
                    const lookupResp = await fetch('/api/apollo-lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, company: company })
                    });
                    const lookupData = await lookupResp.json();

                    if (lookupData.status === 'success' && lookupData.email) {
                        email = lookupData.email;
                        if (card) card.dataset.email = email;
                        const fetchBtn = card ? card.querySelector('.btn-fetch-email') : null;
                        if (fetchBtn) {
                            const isVerified = lookupData.email_status === 'verified';
                            fetchBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${email}`;
                            fetchBtn.style.background = '#d1fae5';
                            fetchBtn.style.color = '#065f46';
                            fetchBtn.style.borderColor = '#a7f3d0';
                            fetchBtn.classList.add('email-found');
                        }
                    } else {
                        if (btn) {
                            btn.classList.remove('loading');
                            btn.classList.add('error');
                            btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> No Email Found';
                            setTimeout(() => { resetEnrollBtn(btn); }, 3000);
                        }
                        if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not find email for this contributor</span>';
                        return;
                    }
                } catch (e) {
                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('error');
                        btn.innerHTML = 'Lookup Failed';
                        setTimeout(() => { resetEnrollBtn(btn); }, 3000);
                    }
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Email lookup failed</span>';
                    return;
                }
            }

            // Step 2: Enroll in sequence
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Enrolling in "${sequenceName}"...</span>`;

            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            try {
                const resp = await fetch('/api/apollo/enroll-sequence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        sequence_id: sequenceId,
                        company_name: company,
                        github_login: login
                    })
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('success');
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Enrolled!';
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status enrolled">Enrolled in "${sequenceName}"</span>`;
                } else {
                    // Translate raw API errors to user-friendly messages
                    let friendlyMsg = 'Enrollment failed. Please try again.';
                    const rawMsg = (data.message || '').toLowerCase();
                    if (rawMsg.includes('422') || rawMsg.includes('unprocessable')) {
                        friendlyMsg = 'Find a valid email first before enrolling in a sequence.';
                    } else if (rawMsg.includes('404') || rawMsg.includes('not found')) {
                        friendlyMsg = 'Sequence not found. It may have been deleted in Apollo.';
                    } else if (rawMsg.includes('401') || rawMsg.includes('unauthorized')) {
                        friendlyMsg = 'Apollo API key is invalid or expired. Check settings.';
                    } else if (rawMsg.includes('already') || rawMsg.includes('duplicate')) {
                        friendlyMsg = 'This contact is already enrolled in this sequence.';
                    }

                    if (btn) {
                        btn.classList.remove('loading');
                        btn.classList.add('error');
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> Failed';
                        setTimeout(() => { resetEnrollBtn(btn); }, 4000);
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status error">${friendlyMsg}</span>`;
                }
            } catch (e) {
                if (btn) {
                    btn.classList.remove('loading');
                    btn.classList.add('error');
                    btn.innerHTML = 'Error';
                    setTimeout(() => { resetEnrollBtn(btn); }, 4000);
                }
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not connect to Apollo. Check your network and try again.</span>';
            }
        }

        function resetEnrollBtn(btn) {
            btn.classList.remove('loading', 'success', 'error');
            btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg> Enroll in Sequence';
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.btn-enroll-sequence') && !e.target.closest('.sequence-selector-dropdown')) {
                closeAllSequenceDropdowns();
            }
        });

        // One-click Enrich & Enroll flow
        async function enrichAndEnroll(btn) {
            const login = btn.dataset.login;
            const name = btn.dataset.name;
            const company = btn.dataset.company;
            const card = btn.closest('.contributor-card');
            const statusEl = document.getElementById(`enrollment-status-${login}`);
            const origHTML = btn.innerHTML;

            btn.disabled = true;

            // Step 1: Find email
            btn.className = 'btn-enrich-enroll step-email';
            btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Finding email...';
            if (statusEl) statusEl.innerHTML = '<span class="enrollment-status pending">Step 1/3: Finding email...</span>';

            let email = card ? card.dataset.email : null;

            if (!email) {
                try {
                    const lookupResp = await fetch('/api/apollo-lookup', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, company: company })
                    });
                    const lookupData = await lookupResp.json();

                    if (lookupData.status === 'success' && lookupData.email) {
                        email = lookupData.email;
                        if (card) card.dataset.email = email;
                        // Update the Find Email button too
                        const fetchBtn = card ? card.querySelector('.btn-fetch-email') : null;
                        if (fetchBtn) {
                            fetchBtn.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${email}`;
                            fetchBtn.style.background = '#d1fae5';
                            fetchBtn.style.color = '#065f46';
                            fetchBtn.style.borderColor = '#a7f3d0';
                            fetchBtn.classList.add('email-found');
                        }
                    } else {
                        btn.className = 'btn-enrich-enroll step-error';
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> No email found';
                        if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Could not find an email for this contributor.</span>';
                        setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                        return;
                    }
                } catch (e) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'Lookup failed';
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Email lookup failed. Check your network.</span>';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    return;
                }
            }

            // Step 2: Load sequences and show picker
            btn.className = 'btn-enrich-enroll step-enroll';
            btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Pick sequence...';
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Step 2/3: Email found (${email}). Choose a sequence...</span>`;

            try {
                const sequences = await loadApolloSequences();
                if (!sequences || sequences.length === 0) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'No sequences';
                    if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">No Apollo sequences available.</span>';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    return;
                }

                // Show inline sequence picker as a dropdown from this button
                let picker = btn.nextElementSibling;
                if (!picker || !picker.classList.contains('enrich-sequence-picker')) {
                    picker = document.createElement('div');
                    picker.className = 'enrich-sequence-picker sequence-selector-dropdown';
                    btn.after(picker);
                }

                picker.innerHTML = sequences.map(seq =>
                    `<div class="sequence-option" onclick="completeEnrichEnroll(this, '${login}', ${JSON.stringify(name)}, ${JSON.stringify(company)}, '${seq.id}', ${JSON.stringify(seq.name)})">
                        <span class="sequence-option-name">${seq.name}</span>
                        <span class="sequence-option-meta">${seq.num_steps} steps</span>
                    </div>`
                ).join('');
                picker.style.display = 'block';
                picker.style.position = 'absolute';
                picker.style.top = '100%';
                picker.style.left = '0';
                picker.style.zIndex = '100';

                btn.disabled = false;
                btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Pick sequence...';

            } catch (e) {
                btn.className = 'btn-enrich-enroll step-error';
                btn.innerHTML = 'Error loading sequences';
                setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
            }
        }

        async function completeEnrichEnroll(optionEl, login, name, company, sequenceId, sequenceName) {
            const picker = optionEl.closest('.enrich-sequence-picker');
            if (picker) picker.style.display = 'none';

            const card = optionEl.closest('.contributor-card');
            const btn = card ? card.querySelector('.btn-enrich-enroll') : null;
            const statusEl = document.getElementById(`enrollment-status-${login}`);
            const email = card ? card.dataset.email : null;

            if (!email) return;

            if (btn) {
                btn.disabled = true;
                btn.className = 'btn-enrich-enroll step-enroll';
                btn.innerHTML = '<svg class="spin-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg> Enrolling...';
            }
            if (statusEl) statusEl.innerHTML = `<span class="enrollment-status pending">Step 3/3: Enrolling in "${sequenceName}"...</span>`;

            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            try {
                const resp = await fetch('/api/apollo/enroll-sequence', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: email,
                        first_name: firstName,
                        last_name: lastName,
                        sequence_id: sequenceId,
                        company_name: company,
                        github_login: login
                    })
                });
                const data = await resp.json();

                if (data.status === 'success') {
                    if (btn) {
                        btn.className = 'btn-enrich-enroll step-done';
                        btn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Done!';
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status enrolled">Enrolled in "${sequenceName}"</span>`;
                } else {
                    let friendlyMsg = 'Enrollment failed. Please try again.';
                    const rawMsg = (data.message || '').toLowerCase();
                    if (rawMsg.includes('422')) friendlyMsg = 'Find a valid email first.';
                    else if (rawMsg.includes('already') || rawMsg.includes('duplicate')) friendlyMsg = 'Already enrolled in this sequence.';

                    if (btn) {
                        btn.className = 'btn-enrich-enroll step-error';
                        btn.innerHTML = 'Failed';
                        const origHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Enrich & Enroll';
                        setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                    }
                    if (statusEl) statusEl.innerHTML = `<span class="enrollment-status error">${friendlyMsg}</span>`;
                }
            } catch (e) {
                if (btn) {
                    btn.className = 'btn-enrich-enroll step-error';
                    btn.innerHTML = 'Network error';
                    const origHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg> Enrich & Enroll';
                    setTimeout(() => resetEnrichBtn(btn, origHTML), 4000);
                }
                if (statusEl) statusEl.innerHTML = '<span class="enrollment-status error">Network error. Try again.</span>';
            }
        }

        function resetEnrichBtn(btn, origHTML) {
            btn.disabled = false;
            btn.className = 'btn-enrich-enroll';
            btn.innerHTML = origHTML;
        }

    </script>
{% endblock %}