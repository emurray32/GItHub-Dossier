{% extends "base.html" %}

{% block title %}Rule Set - Lead Machine{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/rules.css') }}">
{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('accounts') }}">
                <i data-lucide="building-2" style="width:14px;height:14px;"></i>
                Accounts
            </a>
        </li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item active" aria-current="page">Rule Set</li>
    </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container rules-page">
    <header class="page-header">
        <div class="page-header-content">
            <div class="page-header-text">
                <h1>Scanning Rule Set</h1>
                <p class="subtitle">Detection rules and scoring configuration for identifying i18n signals</p>
            </div>
            <div class="page-header-actions">
                <a href="/api/rules/download" class="btn-download" title="Download rules for LLM">
                    <i data-lucide="download" style="width:16px;height:16px;"></i>
                    <span>Download Rules</span>
                </a>
            </div>
            <div class="rules-meta">
                <span id="rules-last-updated" class="rules-timestamp">Loading...</span>
                <button id="rules-refresh-btn" class="rules-refresh-btn" title="Mark rules as reviewed">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 18 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>
    <div class="loading-state" id="loading-state" aria-live="polite">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p>Loading rules...</p>
    </div>
    <div id="rules-content" class="rules-content hidden"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const rulesContent = document.getElementById('rules-content');
        const loadingState = document.getElementById('loading-state');
        const rulesLastUpdated = document.getElementById('rules-last-updated');
        const rulesRefreshBtn = document.getElementById('rules-refresh-btn');
        let explanationsCache = {};

        const categoryToRuleKey = {
            'Signal 1: RFC & Discussion Keywords': 'rfc_keywords',
            'Signal 2: Smoking Gun Libraries': 'smoking_gun_libs',
            'Signal 2b: Smoking Gun Fork Repos': 'smoking_gun_fork_repos',
            'Signal 2c: Linter Libraries': 'linter_libraries',
            'Signal 2d: CMS i18n Libraries': 'cms_i18n_libs',
            'Signal 3: Ghost Branch Patterns': 'ghost_branch_patterns',
            'Signal 4: Documentation Intent Keywords': 'documentation_intent_keywords',
            'Documentation Context Keywords': 'documentation_context_keywords',
            'Exclusion Folders (Disqualifiers)': 'exclusion_folders',
            'Source Locale Patterns (Goldilocks Exception)': 'source_locale_patterns',
            'Dependency Files Scanned': 'dependency_injection_files',
            'Framework Config Files': 'framework_config_files',
            'Documentation Files Scanned': 'documentation_files',
            'i18n Script Keywords': 'i18n_script_keywords',
            'Build Script i18n Keywords': 'build_script_i18n_keywords',
            'Open Protocol Disqualifiers': 'open_protocol_disqualifiers',
            'High-Value Repo Patterns': 'high_value_patterns',
            'Low-Value Repo Patterns': 'low_value_patterns',
            'High-Value Languages': 'high_value_languages',
            'Launched Indicators (Negative)': 'documentation_launched_indicators'
        };

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
        }

        function getPhaseColor(phase) {
            const colors = { 'THINKING': '#3b82f6', 'PREPARING': '#f16a34', 'ACTIVE': '#8b5cf6', 'LAUNCHED': '#0ac2c6', 'DISQUALIFIED': '#6b7280', 'SCORING': '#d97706' };
            return colors[phase] || '#64748b';
        }

        function getPhaseLabel(phase) {
            const labels = { 'THINKING': 'Thinking Phase', 'PREPARING': 'Preparing Phase', 'ACTIVE': 'Active Phase', 'LAUNCHED': 'Already Launched', 'DISQUALIFIED': 'Disqualifier', 'SCORING': 'Scoring' };
            return labels[phase] || phase;
        }

        async function loadExplanation(ruleKey, explanationEl, btn) {
            if (explanationsCache[ruleKey]) { explanationEl.textContent = explanationsCache[ruleKey]; explanationEl.classList.remove('loading'); return; }
            explanationEl.innerHTML = '<span>Loading explanation...</span>';
            explanationEl.classList.add('loading');
            btn.disabled = true;
            try {
                const response = await fetch('/api/rules/explain', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rules: [ruleKey] }) });
                const data = await response.json();
                if (data.explanations && data.explanations[ruleKey]) { explanationsCache[ruleKey] = data.explanations[ruleKey]; explanationEl.textContent = data.explanations[ruleKey]; }
                else { explanationEl.textContent = 'Unable to load explanation.'; }
            } catch (error) { console.error('Failed to load explanation:', error); explanationEl.textContent = 'Failed to load explanation.'; }
            finally { explanationEl.classList.remove('loading'); btn.disabled = false; }
        }

        window.toggleExplanation = function(btn) {
            var row = btn.closest('tr');
            var nextRow = row.nextElementSibling;
            if (!nextRow || !nextRow.classList.contains('explanation-row')) return;
            var dropdown = nextRow.querySelector('.explanation-dropdown');
            var explanationEl = nextRow.querySelector('.explanation-text');
            var ruleKey = btn.dataset.ruleKey;
            var isOpen = dropdown.classList.contains('open');
            if (isOpen) { dropdown.classList.remove('open'); btn.classList.remove('open'); }
            else { dropdown.classList.add('open'); btn.classList.add('open'); if (!explanationEl.textContent || explanationEl.classList.contains('loading')) { loadExplanation(ruleKey, explanationEl, btn); } }
        };

        async function loadRules() {
            try {
                const response = await fetch('/api/rules');
                const data = await response.json();
                rulesLastUpdated.textContent = 'Updated: ' + formatTimestamp(data.last_updated);
                var html = '';

                // Summary Section - two tables side by side
                html += '<div class="summary-section">';
                html += '<div class="summary-table-wrap"><h2>Intent Score Weights</h2><table class="summary-table"><tbody>';
                for (const [key, value] of Object.entries(data.scoring.weights)) {
                    var label = key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    html += '<tr><td>' + label + '</td><td>' + value + ' pts</td></tr>';
                }
                html += '</tbody></table>';
                html += '<h4>Goldilocks Scores</h4><table class="summary-table"><tbody>';
                for (const [key, value] of Object.entries(data.scoring.goldilocks_scores)) {
                    var label = key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    html += '<tr><td>' + label + '</td><td>' + value + '</td></tr>';
                }
                html += '</tbody></table></div>';

                html += '<div class="summary-table-wrap"><h2>Scan Configuration</h2><table class="summary-table"><tbody>';
                html += '<tr><td>Max Repos to Scan</td><td>' + data.scan_config.max_repos_to_scan + '</td></tr>';
                html += '<tr><td>Repo Inactivity Days</td><td>' + data.scan_config.repo_inactivity_days + '</td></tr>';
                html += '<tr><td>RFC Lookback Days</td><td>' + data.scan_config.rfc_lookback_days + '</td></tr>';
                html += '<tr><td>Doc Proximity Chars</td><td>' + data.scan_config.documentation_proximity_chars + '</td></tr>';
                html += '</tbody></table>';
                if (data.scoring.lead_status_labels) {
                    html += '<h4>Lead Status Labels</h4><table class="summary-table"><tbody>';
                    for (const [key, value] of Object.entries(data.scoring.lead_status_labels)) {
                        html += '<tr><td>' + key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) + '</td><td>' + value + '</td></tr>';
                    }
                    html += '</tbody></table>';
                }
                html += '</div></div>';

                // Signals Table
                html += '<div class="signals-section"><h2>Intent Signals</h2>';
                html += '<div class="signals-table-wrap"><table class="signals-table">';
                html += '<thead><tr><th class="col-num">#</th><th class="col-name">Signal Name</th><th class="col-phase">Phase</th><th class="col-items">Keywords / Patterns</th></tr></thead>';
                html += '<tbody>';

                for (var i = 0; i < data.categories.length; i++) {
                    var category = data.categories[i];
                    var phaseColor = getPhaseColor(category.phase);
                    var phaseLabel = getPhaseLabel(category.phase);
                    var ruleKey = categoryToRuleKey[category.name] || '';

                    html += '<tr class="signal-row">';
                    html += '<td style="color:var(--text-muted);font-size:0.75rem;">' + (i + 1) + '</td>';
                    html += '<td><div class="signal-name">' + category.name + '</div>';
                    html += '<div class="signal-description">' + category.description + '</div>';
                    if (category.lookback_days) { html += '<div class="signal-lookback">Lookback: ' + category.lookback_days + ' days</div>'; }
                    if (ruleKey) {
                        html += '<button class="explain-btn" data-rule-key="' + ruleKey + '" onclick="toggleExplanation(this)">';
                        html += '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
                        html += '<span>What does this mean?</span>';
                        html += '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
                        html += '</button>';
                    }
                    html += '</td>';
                    html += '<td><span class="phase-badge" style="background-color:' + phaseColor + '28;color:' + phaseColor + ';border:1px solid ' + phaseColor + '40;">' + phaseLabel + '</span></td>';
                    html += '<td>';
                    if (category.items && category.items.length > 0) {
                        html += '<div class="rule-items">';
                        for (var j = 0; j < category.items.length; j++) { html += '<span class="rule-item">' + category.items[j] + '</span>'; }
                        html += '</div>';
                    } else { html += '<span style="color:var(--text-muted);font-size:0.8rem;">\u2014</span>'; }
                    html += '</td></tr>';

                    if (ruleKey) {
                        html += '<tr class="explanation-row"><td></td><td colspan="3"><div class="explanation-dropdown"><div class="explanation-text"></div></div></td></tr>';
                    }
                }

                html += '</tbody></table></div></div>';
                rulesContent.innerHTML = html;
                loadingState.classList.add('hidden');
                rulesContent.classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load rules:', error);
                loadingState.innerHTML = '<div class="rules-error">Failed to load rules. Please try again.</div>';
            }
        }

        async function refreshRulesTimestamp() {
            try {
                rulesRefreshBtn.disabled = true;
                rulesRefreshBtn.classList.add('refreshing');
                const response = await fetch('/api/rules/refresh', { method: 'POST' });
                const data = await response.json();
                if (data.success) { rulesLastUpdated.textContent = 'Updated: ' + formatTimestamp(data.last_updated); }
            } catch (error) { console.error('Failed to refresh rules timestamp:', error); }
            finally { rulesRefreshBtn.disabled = false; rulesRefreshBtn.classList.remove('refreshing'); }
        }

        rulesRefreshBtn.addEventListener('click', refreshRulesTimestamp);
        loadRules();
    });
</script>
{% endblock %}
