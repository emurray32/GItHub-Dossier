{% extends "base.html" %}

{% block title %}Rule Set - Lead Machine{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
        <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                                    <a href="{{ url_for('accounts') }}">
                                                        <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>path>
                                                                                <polyline points="9 22 9 12 15 12 15 22"></polyline>polyline>
                                                        </svg>svg>
                                                        Accounts
                                    </a>a>
                    </li>li>
                    <li class="breadcrumb-separator"></li>li>
                    <li class="breadcrumb-item active" aria-current="page">Rule Set</li>li>
        </ol>ol>
</nav>nav>
{% endblock %}

{% block content %}
<div class="container">
        <header class="page-header">
                    <div class="page-header-content">
                                    <div class="page-header-text">
                                                        <h1>Scanning Rule Set</h1>
                                                    <p class="subtitle">Detection rules and scoring configuration for identifying i18n signals</p>p>
                                    </div>div>
                                <div class="page-header-actions">
                                                <a href="/api/rules/download" class="btn-download" title="Download rules for LLM">
                                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>path>
                                                                                            <polyline points="7 10 12 15 17 10"></polyline>polyline>
                                                                                            <line x1="12" y1="15" x2="12" y2="3"></line>line>
                                                                    </svg>svg>
                                                                    <span>Download Rules</span>
                                                </a>a>
                                </div>div>
                                <div class="rules-meta">
                                                <span id="rules-last-updated" class="rules-timestamp">Loading...</span>
                                                <button id="rules-refresh-btn" class="rules-refresh-btn" title="Mark rules as reviewed">
                                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                                                            <polyline points="23 4 23 18 17 10"></polyline>polyline>
                                                                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>path>
                                                                    </svg>svg>
                                                </button>button>
                                </div>div>
                    </div>div>
        </header>header>
    <div class="loading-state" id="loading-state" aria-live="polite">
            <div class="loading-spinner" aria-hidden="true"></div>div>
            <p>Loading rules...</p>
    </div>div>
    <div id="rules-content" class="rules-content hidden"></div>div>
</div>div>

<style>
    .page-header { margin-bottom: 2rem; }
    .page-header-content { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; }
    .page-header-text { flex: 1; min-width: 200px; }
    .page-header-text h1 { margin: 0; font-size: 1.5rem; color: var(--text-primary); }
    .subtitle { color: var(--text-secondary); margin: 0.25rem 0 0 0; font-size: 0.875rem; }
    .page-header-actions { display: flex; align-items: center; gap: 0.75rem; }
    .btn-download { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--accent-color); color: white; border-radius: 6px; text-decoration: none; font-size: 0.875rem; font-weight: 500; transition: all var(--transition-fast); }
    .btn-download:hover { background: var(--accent-hover); color: white; transform: translateY(-1px); }
    .btn-download svg { width: 18px; height: 18px; }
    .rules-meta { display: flex; align-items: center; gap: 0.5rem; }
    .rules-timestamp { font-size: 0.8rem; color: var(--text-muted); background: var(--bg-secondary); padding: 0.375rem 0.75rem; border-radius: 6px; border: 1px solid var(--border-color); }
    .rules-refresh-btn { display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; padding: 0; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; color: var(--text-secondary); transition: all var(--transition-fast); }
    .rules-refresh-btn:hover { background: var(--bg-secondary); color: var(--accent-color); border-color: var(--accent-color); }
    .rules-refresh-btn.refreshing svg { animation: spin 1s linear infinite; }
    .rules-refresh-btn svg { width: 18px; height: 18px; }
    .loading-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem 2rem; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 12px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .rules-content { display: flex; flex-direction: column; gap: 2rem; }
    .rules-content.hidden { display: none; }
    .summary-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .summary-table-wrap { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .summary-table-wrap h2 { font-size: 0.9375rem; font-weight: 600; color: var(--text-primary); margin: 0; padding: 0.875rem 1rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
    .summary-table-wrap h4 { font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); margin: 0; padding: 0.625rem 1rem; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); border-top: 1px solid var(--border-color); }
    .summary-table { width: 100%; border-collapse: collapse; }
    .summary-table td { padding: 0.5rem 1rem; font-size: 0.8125rem; border-bottom: 1px solid var(--border-color); }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table td:first-child { color: var(--text-secondary); white-space: nowrap; }
    .summary-table td:last-child { text-align: right; font-weight: 600; color: var(--accent-color); }
    .signals-section h2 { font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin: 0 0 0.75rem 0; }
    .signals-table-wrap { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; }
    .signals-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .signals-table thead th { padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); background: var(--bg-secondary); border-bottom: 2px solid var(--border-color); text-align: left; white-space: nowrap; }
    .signals-table .col-num { width: 40px; }
    .signals-table .col-name { width: 30%; }
    .signals-table .col-phase { width: 120px; }
    .signals-table tbody tr { transition: background var(--transition-fast); }
    .signals-table tbody tr.signal-row:hover { background: var(--bg-secondary); }
    .signals-table tbody td { padding: 0.75rem 1rem; font-size: 0.8125rem; border-bottom: 1px solid var(--border-color); vertical-align: top; }
    .signals-table tbody tr:last-child td { border-bottom: none; }
    .signals-table tbody tr.explanation-row td { padding: 0 1rem 0.75rem 1rem; border-bottom: 1px solid var(--border-color); }
    .signals-table tbody tr.explanation-row:hover { background: transparent; }
    .signal-name { font-weight: 600; color: var(--text-primary); }
    .signal-description { color: var(--text-secondary); font-size: 0.8rem; margin-top: 0.2rem; }
    .signal-lookback { color: var(--text-muted); font-size: 0.75rem; font-style: italic; margin-top: 0.2rem; }
    .phase-badge { font-size: 0.6875rem; font-weight: 500; padding: 0.2rem 0.625rem; border-radius: 4px; white-space: nowrap; display: inline-block; }
    .rule-items { display: flex; flex-wrap: wrap; gap: 0.3rem; }
    .rule-item { font-size: 0.6875rem; background: var(--bg-secondary); border: 1px solid var(--border-color); padding: 0.15rem 0.5rem; border-radius: 3px; color: var(--text-secondary); font-family: monospace; white-space: nowrap; }
    .explain-btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.3rem 0.6rem; margin-top: 0.5rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #bbf7d0; border-radius: 6px; font-size: 0.7rem; font-weight: 500; color: #166534; cursor: pointer; transition: all var(--transition-fast); white-space: nowrap; }
    .explain-btn:hover { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-color: #86efac; }
    .explain-btn:disabled { opacity: 0.7; cursor: wait; }
    .explain-btn .icon { width: 14px; height: 14px; flex-shrink: 0; }
    .explain-btn .chevron { width: 12px; height: 12px; flex-shrink: 0; transition: transform var(--transition-fast); }
    .explain-btn.open .chevron { transform: rotate(180deg); }
    .explanation-dropdown { display: none; }
    .explanation-dropdown.open { display: block; }
    .explanation-text { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; padding: 0.75rem; background: var(--bg-secondary); border-radius: 6px; border: 1px solid var(--border-color); }
    @media (max-width: 768px) { .summary-section { grid-template-columns: 1fr; } }
    </style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
            const rulesContent = document.getElementById('rules-content');
            const loadingState = document.getElementById('loading-state');
            const rulesLastUpdated = document.getElementById('rules-last-updated');
            const rulesRefreshBtn = document.getElementById('rules-refresh-btn');
            let explanationsCache = {};

            const categoryToRuleKey = {
                        'Signal 1: RFC & Discussion Keywords': 'rfc_keywords',
                        'Signal 2: Smoking Gun Libraries': 'smoking_gun_libs',
                        'Signal 2b: Smoking Gun Fork Repos': 'smoking_gun_fork_repos',
                        'Signal 2c: Linter Libraries': 'linter_libraries',
                        'Signal 2d: CMS i18n Libraries': 'cms_i18n_libs',
                        'Signal 3: Ghost Branch Patterns': 'ghost_branch_patterns',
                        'Signal 4: Documentation Intent Keywords': 'documentation_intent_keywords',
                        'Documentation Context Keywords': 'documentation_context_keywords',
                        'Exclusion Folders (Disqualifiers)': 'exclusion_folders',
                        'Source Locale Patterns (Goldilocks Exception)': 'source_locale_patterns',
                        'Dependency Files Scanned': 'dependency_injection_files',
                        'Framework Config Files': 'framework_config_files',
                        'Documentation Files Scanned': 'documentation_files',
                        'i18n Script Keywords': 'i18n_script_keywords',
                        'Build Script i18n Keywords': 'build_script_i18n_keywords',
                        'Open Protocol Disqualifiers': 'open_protocol_disqualifiers',
                        'High-Value Repo Patterns': 'high_value_patterns',
                        'Low-Value Repo Patterns': 'low_value_patterns',
                        'High-Value Languages': 'high_value_languages',
                        'Launched Indicators (Negative)': 'documentation_launched_indicators'
            };

            function formatTimestamp(isoString) {
                        const date = new Date(isoString);
                        return date.toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true });
            }

            function getPhaseColor(phase) {
                        const colors = { 'THINKING': '#3b82f6', 'PREPARING': '#f16a34', 'ACTIVE': '#8b5cf6', 'LAUNCHED': '#0ac2c6', 'DISQUALIFIED': '#6b7280', 'SCORING': '#d97706' };
                        return colors[phase] || '#64748b';
            }

            function getPhaseLabel(phase) {
                        const labels = { 'THINKING': 'Thinking Phase', 'PREPARING': 'Preparing Phase', 'ACTIVE': 'Active Phase', 'LAUNCHED': 'Already Launched', 'DISQUALIFIED': 'Disqualifier', 'SCORING': 'Scoring' };
                        return labels[phase] || phase;
            }

            async function loadExplanation(ruleKey, explanationEl, btn) {
                        if (explanationsCache[ruleKey]) { explanationEl.textContent = explanationsCache[ruleKey]; explanationEl.classList.remove('loading'); return; }
                        explanationEl.innerHTML = '<span>Loading explanation...</span>';
                        explanationEl.classList.add('loading');
                        btn.disabled = true;
                        try {
                                        const response = await fetch('/api/rules/explain', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ rules: [ruleKey] }) });
                                        const data = await response.json();
                                        if (data.explanations && data.explanations[ruleKey]) { explanationsCache[ruleKey] = data.explanations[ruleKey]; explanationEl.textContent = data.explanations[ruleKey]; }
                                        else { explanationEl.textContent = 'Unable to load explanation.'; }
                        } catch (error) { console.error('Failed to load explanation:', error); explanationEl.textContent = 'Failed to load explanation.'; }
                        finally { explanationEl.classList.remove('loading'); btn.disabled = false; }
            }

            window.toggleExplanation = function(btn) {
                        var row = btn.closest('tr');
                        var nextRow = row.nextElementSibling;
                        if (!nextRow || !nextRow.classList.contains('explanation-row')) return;
                        var dropdown = nextRow.querySelector('.explanation-dropdown');
                        var explanationEl = nextRow.querySelector('.explanation-text');
                        var ruleKey = btn.dataset.ruleKey;
                        var isOpen = dropdown.classList.contains('open');
                        if (isOpen) { dropdown.classList.remove('open'); btn.classList.remove('open'); }
                        else { dropdown.classList.add('open'); btn.classList.add('open'); if (!explanationEl.textContent || explanationEl.classList.contains('loading')) { loadExplanation(ruleKey, explanationEl, btn); } }
            };

            async function loadRules() {
                        try {
                                        const response = await fetch('/api/rules');
                                        const data = await response.json();
                                        rulesLastUpdated.textContent = 'Updated: ' + formatTimestamp(data.last_updated);
                                        var html = '';

                                        // Summary Section - two tables side by side
                                        html += '<div class="summary-section">';
                                        html += '<div class="summary-table-wrap"><h2>Intent Score Weights</h2><table class="summary-table"><tbody>';
                                        for (const [key, value] of Object.entries(data.scoring.weights)) {
                                                            var label = key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                                                            html += '<tr><td>' + label + '</td><td>' + value + ' pts</td></tr>';
                                        }
                                        html += '</tbody></table>';
                                        html += '<h4>Goldilocks Scores</h4><table class="summary-table"><tbody>';
                                        for (const [key, value] of Object.entries(data.scoring.goldilocks_scores)) {
                                                            var label = key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                                                            html += '<tr><td>' + label + '</td><td>' + value + '</td></tr>';
                                        }
                                        html += '</tbody></table></div>';

                                        html += '<div class="summary-table-wrap"><h2>Scan Configuration</h2><table class="summary-table"><tbody>';
                                        html += '<tr><td>Max Repos to Scan</td><td>' + data.scan_config.max_repos_to_scan + '</td></tr>';
                                        html += '<tr><td>Repo Inactivity Days</td><td>' + data.scan_config.repo_inactivity_days + '</td></tr>';
                                        html += '<tr><td>RFC Lookback Days</td><td>' + data.scan_config.rfc_lookback_days + '</td></tr>';
                                        html += '<tr><td>Doc Proximity Chars</td><td>' + data.scan_config.documentation_proximity_chars + '</td></tr>';
                                        html += '</tbody></table>';
                                        if (data.scoring.lead_status_labels) {
                                                            html += '<h4>Lead Status Labels</h4><table class="summary-table"><tbody>';
                                                            for (const [key, value] of Object.entries(data.scoring.lead_status_labels)) {
                                                                                    html += '<tr><td>' + key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) + '</td><td>' + value + '</td></tr>';
                                                            }
                                                            html += '</tbody></table>';
                                        }
                                        html += '</div></div>';

                                        // Signals Table
                                        html += '<div class="signals-section"><h2>Intent Signals</h2>';
                                        html += '<div class="signals-table-wrap"><table class="signals-table">';
                                        html += '<thead><tr><th class="col-num">#</th><th class="col-name">Signal Name</th><th class="col-phase">Phase</th><th class="col-items">Keywords / Patterns</th></tr></thead>';
                                        html += '<tbody>';

                                        for (var i = 0; i < data.categories.length; i++) {
                                                            var category = data.categories[i];
                                                            var phaseColor = getPhaseColor(category.phase);
                                                            var phaseLabel = getPhaseLabel(category.phase);
                                                            var ruleKey = categoryToRuleKey[category.name] || '';

                                                            html += '<tr class="signal-row">';
                                                            html += '<td style="color:var(--text-muted);font-size:0.75rem;">' + (i + 1) + '</td>';
                                                            html += '<td><div class="signal-name">' + category.name + '</div>';
                                                            html += '<div class="signal-description">' + category.description + '</div>';
                                                            if (category.lookback_days) { html += '<div class="signal-lookback">Lookback: ' + category.lookback_days + ' days</div>'; }
                                                            if (ruleKey) {
                                                                                    html += '<button class="explain-btn" data-rule-key="' + ruleKey + '" onclick="toggleExplanation(this)">';
                                                                                    html += '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
                                                                                    html += '<span>What does this mean?</span>';
                                                                                    html += '<svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>';
                                                                                    html += '</button>';
                                                            }
                                                            html += '</td>';
                                                            html += '<td><span class="phase-badge" style="background-color:' + phaseColor + '28;color:' + phaseColor + ';border:1px solid ' + phaseColor + '40;">' + phaseLabel + '</span></td>';
                                                            html += '<td>';
                                                            if (category.items && category.items.length > 0) {
                                                                                    html += '<div class="rule-items">';
                                                                                    for (var j = 0; j < category.items.length; j++) { html += '<span class="rule-item">' + category.items[j] + '</span>'; }
                                                                                    html += '</div>';
                                                            } else { html += '<span style="color:var(--text-muted);font-size:0.8rem;">\u2014</span>'; }
                                                            html += '</td></tr>';

                                                            if (ruleKey) {
                                                                                    html += '<tr class="explanation-row"><td></td><td colspan="3"><div class="explanation-dropdown"><div class="explanation-text"></div></div></td></tr>';
                                                            }
                                        }

                                        html += '</tbody></table></div></div>';
                                        rulesContent.innerHTML = html;
                                        loadingState.classList.add('hidden');
                                        rulesContent.classList.remove('hidden');
                        } catch (error) {
                                        console.error('Failed to load rules:', error);
                                        loadingState.innerHTML = '<div class="rules-error">Failed to load rules. Please try again.</div>';
                        }
            }

            async function refreshRulesTimestamp() {
                        try {
                                        rulesRefreshBtn.disabled = true;
                                        rulesRefreshBtn.classList.add('refreshing');
                                        const response = await fetch('/api/rules/refresh', { method: 'POST' });
                                        const data = await response.json();
                                        if (data.success) { rulesLastUpdated.textContent = 'Updated: ' + formatTimestamp(data.last_updated); }
                        } catch (error) { console.error('Failed to refresh rules timestamp:', error); }
                        finally { rulesRefreshBtn.disabled = false; rulesRefreshBtn.classList.remove('refreshing'); }
            }

            rulesRefreshBtn.addEventListener('click', refreshRulesTimestamp);
            loadRules();
    });
</script>
{% endblock %}
</script>
</style></p></span></h1>
