{% extends "base.html" %}
{% block title %}Enrollment â€” Lead Machine{% endblock %}
{% block page_title %}Enrollment{% endblock %}

{% block head %}
<style>
/* Stepper */
.stepper { display:flex; gap:0; margin-bottom:1.5rem; border:1px solid var(--color-border); border-radius:10px; overflow:hidden; }
.step-tab { flex:1; padding:0.75rem 1rem; text-align:center; background:var(--color-surface); cursor:default; border-right:1px solid var(--color-border); font-size:0.8rem; color:var(--color-text-secondary); transition:all 0.2s; }
.step-tab:last-child { border-right:none; }
.step-tab.active { background:var(--color-primary); color:#fff; font-weight:600; }
.step-tab.done { background:#ECFDF5; color:#059669; }
.step-tab .step-num { display:inline-block; width:22px; height:22px; line-height:22px; border-radius:50%; background:var(--color-border); color:var(--color-text-secondary); font-size:0.7rem; font-weight:700; margin-right:0.4rem; }
.step-tab.active .step-num { background:rgba(255,255,255,0.3); color:#fff; }
.step-tab.done .step-num { background:#059669; color:#fff; }

/* Step panels */
.step-panel { display:none; }
.step-panel.visible { display:block; }

/* Campaign selector */
.campaign-select { width:100%; max-width:400px; padding:0.6rem 0.75rem; border:1px solid var(--color-border); border-radius:8px; font-size:0.85rem; background:#fff; }

/* Personas summary */
.personas-summary { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.75rem; }
.persona-pill { display:inline-flex; align-items:center; gap:0.4rem; padding:0.35rem 0.75rem; background:#EEF2FF; border-radius:20px; font-size:0.75rem; color:#4338CA; }
.persona-pill .seq-name { color:#6B7280; font-size:0.7rem; }

/* Account table */
.acct-table { width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:0.75rem; }
.acct-table th { text-align:left; padding:0.5rem 0.75rem; background:#F9FAFB; border-bottom:2px solid var(--color-border); font-weight:600; color:var(--color-text-secondary); font-size:0.7rem; text-transform:uppercase; letter-spacing:0.03em; }
.acct-table td { padding:0.5rem 0.75rem; border-bottom:1px solid #F3F4F6; }
.acct-table tr:hover { background:#F9FAFB; }
.acct-table input[type="checkbox"] { width:16px; height:16px; cursor:pointer; }
.acct-count { font-size:0.8rem; color:var(--color-text-secondary); margin-top:0.5rem; }
.acct-search { padding:0.5rem 0.75rem; border:1px solid var(--color-border); border-radius:8px; font-size:0.8rem; width:260px; }

/* Progress bar */
.progress-wrap { background:#E5E7EB; border-radius:8px; height:12px; overflow:hidden; margin:1rem 0; }
.progress-fill { height:100%; background:var(--color-primary); border-radius:8px; transition:width 0.5s ease; }
.phase-text { font-size:0.8rem; color:var(--color-text-secondary); margin-bottom:0.5rem; }

/* Contacts table */
.contacts-table { width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:0.75rem; }
.contacts-table th { text-align:left; padding:0.5rem 0.6rem; background:#F9FAFB; border-bottom:2px solid var(--color-border); font-weight:600; color:var(--color-text-secondary); font-size:0.7rem; text-transform:uppercase; }
.contacts-table td { padding:0.4rem 0.6rem; border-bottom:1px solid #F3F4F6; }
.contacts-table tr:hover { background:#F9FAFB; }

/* Persona group header */
.persona-group { margin-top:1rem; }
.persona-group-header { font-size:0.85rem; font-weight:600; padding:0.5rem 0; color:var(--color-text-primary); border-bottom:2px solid var(--color-primary); margin-bottom:0; display:flex; align-items:center; gap:0.5rem; }
.persona-group-count { font-size:0.7rem; font-weight:400; color:var(--color-text-secondary); background:#F3F4F6; padding:0.15rem 0.5rem; border-radius:10px; }

/* Results cards */
.results-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:1rem; margin:1rem 0; }
.result-card { text-align:center; padding:1.25rem; background:#fff; border:1px solid var(--color-border); border-radius:10px; }
.result-card .num { font-size:1.8rem; font-weight:700; line-height:1; }
.result-card .label { font-size:0.75rem; color:var(--color-text-secondary); margin-top:0.25rem; }
.result-card.success .num { color:#059669; }
.result-card.fail .num { color:#DC2626; }
.result-card.skip .num { color:#D97706; }

/* Status badges */
.status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:0.3rem; }
.status-dot.enrolled { background:#059669; }
.status-dot.failed { background:#DC2626; }
.status-dot.discovered { background:#6B7280; }
.status-dot.email_generated { background:#2563EB; }
.status-dot.skipped { background:#D97706; }

/* Buttons */
.btn-primary { padding:0.6rem 1.25rem; background:var(--color-primary); color:#fff; border:none; border-radius:8px; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.15s; }
.btn-primary:hover { background:#4338CA; }
.btn-primary:disabled { opacity:0.5; cursor:not-allowed; }
.btn-secondary { padding:0.5rem 1rem; background:#fff; color:var(--color-text-primary); border:1px solid var(--color-border); border-radius:8px; font-size:0.8rem; cursor:pointer; }
.btn-secondary:hover { background:#F9FAFB; }
.btn-danger { padding:0.5rem 1rem; background:#FEF2F2; color:#DC2626; border:1px solid #FECACA; border-radius:8px; font-size:0.8rem; cursor:pointer; }

/* Layout helpers */
.card { background:#fff; border:1px solid var(--color-border); border-radius:10px; padding:1.25rem; margin-bottom:1rem; }
.card-title { font-size:0.95rem; font-weight:600; margin-bottom:0.75rem; }
.flex-between { display:flex; justify-content:space-between; align-items:center; }
.mt-1 { margin-top:0.5rem; }
.mt-2 { margin-top:1rem; }
.empty-state { text-align:center; padding:2.5rem; color:var(--color-text-secondary); }
.empty-state i { margin-bottom:0.5rem; }
</style>
{% endblock %}

{% block content %}
<!-- Stepper -->
<div class="stepper" id="stepper">
    <div class="step-tab active" data-step="1"><span class="step-num">1</span>Campaign & Accounts</div>
    <div class="step-tab" data-step="2"><span class="step-num">2</span>Discover Contacts</div>
    <div class="step-tab" data-step="3"><span class="step-num">3</span>Generate & Enroll</div>
    <div class="step-tab" data-step="4"><span class="step-num">4</span>Results</div>
</div>

<!-- Step 1: Campaign & Accounts -->
<div class="step-panel visible" id="step1">
    <div class="card">
        <div class="card-title">Select Campaign</div>
        <select class="campaign-select" id="campaignSelect" onchange="onCampaignChange()">
            <option value="">Choose a campaign...</option>
            {% for c in campaigns %}
            <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
        </select>
        <div class="personas-summary" id="personasSummary"></div>
        <div id="noPersonasWarning" style="display:none; margin-top:0.75rem; padding:0.5rem 0.75rem; background:#FEF3C7; border-radius:8px; font-size:0.8rem; color:#92400E;">
            This campaign has no personas configured. <a href="/campaigns" style="color:#4338CA; font-weight:600;">Configure personas</a> first.
        </div>
    </div>

    <div class="card" id="accountsCard" style="display:none;">
        <div class="flex-between">
            <div class="card-title">Select Accounts</div>
            <div style="display:flex;gap:0.5rem;align-items:center;">
                <input type="text" class="acct-search" placeholder="Search accounts..." oninput="filterAccounts(this.value)">
                <button class="btn-secondary" onclick="toggleAllAccounts(true)">Select All</button>
                <button class="btn-secondary" onclick="toggleAllAccounts(false)">Deselect</button>
            </div>
        </div>
        <table class="acct-table">
            <thead>
                <tr><th style="width:40px;"></th><th>Company</th><th>Website</th><th>Revenue</th><th>Tier</th><th>Cohort</th><th>Score</th></tr>
            </thead>
            <tbody id="accountsBody"></tbody>
        </table>
        <div class="acct-count" id="acctCount"></div>
        <div class="mt-2">
            <button class="btn-primary" id="discoverBtn" onclick="startDiscovery()" disabled>
                Discover Contacts
            </button>
        </div>
    </div>
</div>

<!-- Step 2: Discover Contacts -->
<div class="step-panel" id="step2">
    <div class="card">
        <div class="card-title">Contact Discovery</div>
        <div class="phase-text" id="discoveryPhase">Starting discovery...</div>
        <div class="progress-wrap"><div class="progress-fill" id="discoveryProgress" style="width:0%"></div></div>
    </div>
    <div id="contactsResults" style="display:none;">
        <div class="card">
            <div class="flex-between">
                <div class="card-title" id="contactsTitle">Discovered Contacts</div>
                <button class="btn-primary" id="enrollBtn" onclick="startEnrollment()">Generate Emails & Enroll</button>
            </div>
            <div id="contactsByPersona"></div>
        </div>
    </div>
</div>

<!-- Step 3: Generate & Enroll -->
<div class="step-panel" id="step3">
    <div class="card">
        <div class="card-title">Enrollment Pipeline</div>
        <div class="phase-text" id="enrollPhase">Starting...</div>
        <div class="progress-wrap"><div class="progress-fill" id="enrollProgress" style="width:0%"></div></div>
        <div style="display:flex; gap:1rem; margin-top:0.75rem;">
            <div style="font-size:0.8rem;"><span style="color:#2563EB; font-weight:600;" id="genCount">0</span> emails generated</div>
            <div style="font-size:0.8rem;"><span style="color:#059669; font-weight:600;" id="enrCount">0</span> enrolled</div>
            <div style="font-size:0.8rem;"><span style="color:#DC2626; font-weight:600;" id="failCount">0</span> failed</div>
        </div>
        <div class="mt-2">
            <button class="btn-danger" id="cancelBtn" onclick="cancelBatch()">Cancel</button>
        </div>
    </div>
</div>

<!-- Step 4: Results -->
<div class="step-panel" id="step4">
    <div class="results-grid" id="resultsGrid"></div>
    <div class="card" id="failedCard" style="display:none;">
        <div class="card-title">Failed Contacts</div>
        <table class="contacts-table">
            <thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Error</th></tr></thead>
            <tbody id="failedBody"></tbody>
        </table>
    </div>
    <div class="mt-2" style="display:flex;gap:0.75rem;">
        <button class="btn-secondary" onclick="exportCSV()">Export CSV</button>
        <button class="btn-secondary" id="retryBtn" style="display:none;" onclick="retryFailed()">Retry Failed</button>
        <button class="btn-primary" onclick="resetWizard()">New Enrollment</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentStep = 1;
let allAccounts = [];
let selectedCampaign = null;
let currentBatchId = null;
let pollInterval = null;

// --- Step Navigation ---
function goToStep(n) {
    document.querySelectorAll('.step-panel').forEach(p => p.classList.remove('visible'));
    document.getElementById('step' + n).classList.add('visible');
    document.querySelectorAll('.step-tab').forEach(t => {
        const s = parseInt(t.dataset.step);
        t.classList.remove('active', 'done');
        if (s === n) t.classList.add('active');
        else if (s < n) t.classList.add('done');
    });
    currentStep = n;
}

// --- Campaign Selection ---
async function onCampaignChange() {
    const id = document.getElementById('campaignSelect').value;
    const summary = document.getElementById('personasSummary');
    const warning = document.getElementById('noPersonasWarning');
    const card = document.getElementById('accountsCard');
    summary.innerHTML = '';
    warning.style.display = 'none';
    card.style.display = 'none';
    selectedCampaign = null;

    if (!id) return;

    const resp = await fetch(`/api/campaigns/${id}`);
    const data = await resp.json();
    if (data.status !== 'success') return;

    selectedCampaign = data.campaign;
    const personas = data.campaign.personas || [];

    if (personas.length === 0) {
        warning.style.display = 'block';
        return;
    }

    summary.innerHTML = personas.map(p =>
        `<div class="persona-pill">
            <strong>${p.persona_name}</strong>
            <span class="seq-name">${p.sequence_name || 'No sequence'}</span>
        </div>`
    ).join('');

    card.style.display = 'block';
    loadAccounts();
}

// --- Accounts ---
async function loadAccounts() {
    const resp = await fetch('/api/enrollment/accounts');
    const data = await resp.json();
    allAccounts = data.accounts || [];
    renderAccounts(allAccounts);
}

function renderAccounts(accounts) {
    const body = document.getElementById('accountsBody');
    body.innerHTML = accounts.map(a => `
        <tr>
            <td><input type="checkbox" class="acct-cb" value="${a.id}" onchange="updateCount()"></td>
            <td><strong>${a.company_name}</strong></td>
            <td style="color:var(--color-text-secondary);font-size:0.75rem;">${a.website || ''}</td>
            <td>${a.annual_revenue || ''}</td>
            <td>${a.current_tier != null ? 'T' + a.current_tier : ''}</td>
            <td>${a.cohort || ''}</td>
            <td>${a.total_score || ''}</td>
        </tr>
    `).join('');
    updateCount();
}

function filterAccounts(q) {
    const lower = q.toLowerCase();
    const filtered = allAccounts.filter(a =>
        (a.company_name || '').toLowerCase().includes(lower) ||
        (a.website || '').toLowerCase().includes(lower)
    );
    renderAccounts(filtered);
}

function toggleAllAccounts(checked) {
    document.querySelectorAll('.acct-cb').forEach(cb => cb.checked = checked);
    updateCount();
}

function updateCount() {
    const checked = document.querySelectorAll('.acct-cb:checked').length;
    document.getElementById('acctCount').textContent = `${checked} account${checked !== 1 ? 's' : ''} selected`;
    document.getElementById('discoverBtn').disabled = checked === 0;
}

function getSelectedAccountIds() {
    return Array.from(document.querySelectorAll('.acct-cb:checked')).map(cb => parseInt(cb.value));
}

// --- Discovery ---
async function startDiscovery() {
    const ids = getSelectedAccountIds();
    if (!ids.length || !selectedCampaign) return;

    goToStep(2);
    document.getElementById('discoveryPhase').textContent = 'Starting discovery...';
    document.getElementById('discoveryProgress').style.width = '0%';
    document.getElementById('contactsResults').style.display = 'none';

    const resp = await fetch(`/api/campaigns/${selectedCampaign.id}/discover-contacts`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({account_ids: ids})
    });
    const data = await resp.json();
    if (data.status !== 'success') {
        document.getElementById('discoveryPhase').textContent = 'Error: ' + (data.message || 'Unknown error');
        return;
    }
    currentBatchId = data.batch_id;
    pollBatchStatus('discovery');
}

function pollBatchStatus(mode) {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(async () => {
        const resp = await fetch(`/api/enrollment-batches/${currentBatchId}/status`);
        const data = await resp.json();
        if (data.status !== 'success') return;
        const b = data.batch;

        if (mode === 'discovery') {
            document.getElementById('discoveryPhase').textContent = b.current_phase || b.status;
            const pct = b.total_accounts > 0 ? Math.min(100, Math.round((b.discovered / Math.max(b.total_accounts * 5, 1)) * 100)) : 0;
            document.getElementById('discoveryProgress').style.width = (b.status === 'discovered' ? 100 : pct) + '%';

            if (b.status === 'discovered' || b.status === 'failed') {
                clearInterval(pollInterval);
                pollInterval = null;
                if (b.status === 'discovered') {
                    document.getElementById('discoveryProgress').style.width = '100%';
                    loadDiscoveredContacts();
                } else {
                    document.getElementById('discoveryPhase').textContent = 'Failed: ' + (b.error_message || 'Unknown error');
                }
            }
        } else if (mode === 'enroll') {
            document.getElementById('enrollPhase').textContent = b.current_phase || b.status;
            document.getElementById('genCount').textContent = b.generated || 0;
            document.getElementById('enrCount').textContent = b.enrolled || 0;
            document.getElementById('failCount').textContent = b.failed || 0;
            const total = b.total_contacts || 1;
            const done = (b.enrolled || 0) + (b.failed || 0);
            const pct = Math.round(((b.generated || 0) * 0.5 + done * 0.5) / total * 100);
            document.getElementById('enrollProgress').style.width = Math.min(100, pct) + '%';

            if (b.status === 'completed' || b.status === 'failed' || b.status === 'cancelled') {
                clearInterval(pollInterval);
                pollInterval = null;
                showResults(b);
            }
        }
    }, 2000);
}

async function loadDiscoveredContacts() {
    const resp = await fetch(`/api/enrollment-batches/${currentBatchId}/contacts`);
    const data = await resp.json();
    const contacts = data.contacts || [];

    document.getElementById('contactsResults').style.display = 'block';
    document.getElementById('contactsTitle').textContent = `Discovered Contacts (${contacts.length})`;

    // Group by persona
    const groups = {};
    contacts.forEach(c => {
        const p = c.persona_name || 'Other';
        if (!groups[p]) groups[p] = [];
        groups[p].push(c);
    });

    const container = document.getElementById('contactsByPersona');
    container.innerHTML = Object.entries(groups).map(([persona, list]) => `
        <div class="persona-group">
            <div class="persona-group-header">
                ${persona} <span class="persona-group-count">${list.length}</span>
            </div>
            <table class="contacts-table">
                <thead><tr><th>Name</th><th>Email</th><th>Title</th><th>Company</th></tr></thead>
                <tbody>
                    ${list.map(c => `
                        <tr>
                            <td>${c.first_name || ''} ${c.last_name || ''}</td>
                            <td style="font-size:0.75rem;color:var(--color-text-secondary);">${c.email || ''}</td>
                            <td style="font-size:0.75rem;">${c.title || ''}</td>
                            <td style="font-size:0.75rem;">${c.company_name || ''}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `).join('');
}

// --- Enrollment ---
async function startEnrollment() {
    if (!currentBatchId || !selectedCampaign) return;
    goToStep(3);
    document.getElementById('enrollPhase').textContent = 'Starting pipeline...';
    document.getElementById('enrollProgress').style.width = '0%';
    document.getElementById('genCount').textContent = '0';
    document.getElementById('enrCount').textContent = '0';
    document.getElementById('failCount').textContent = '0';

    const resp = await fetch(`/api/campaigns/${selectedCampaign.id}/enroll`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({batch_id: currentBatchId})
    });
    const data = await resp.json();
    if (data.status !== 'success') {
        document.getElementById('enrollPhase').textContent = 'Error: ' + (data.message || 'Unknown');
        return;
    }
    pollBatchStatus('enroll');
}

async function cancelBatch() {
    if (!currentBatchId) return;
    await fetch(`/api/enrollment-batches/${currentBatchId}/cancel`, {method: 'POST'});
    document.getElementById('enrollPhase').textContent = 'Cancelling...';
}

// --- Results ---
function showResults(batch) {
    goToStep(4);
    const total = batch.total_contacts || 0;
    const enrolled = batch.enrolled || 0;
    const failed = batch.failed || 0;
    const skipped = batch.skipped || 0;

    document.getElementById('resultsGrid').innerHTML = `
        <div class="result-card"><div class="num">${total}</div><div class="label">Total Contacts</div></div>
        <div class="result-card success"><div class="num">${enrolled}</div><div class="label">Enrolled</div></div>
        <div class="result-card fail"><div class="num">${failed}</div><div class="label">Failed</div></div>
        <div class="result-card skip"><div class="num">${skipped}</div><div class="label">Skipped</div></div>
    `;

    if (failed > 0) {
        loadFailedContacts();
        document.getElementById('retryBtn').style.display = 'inline-flex';
    } else {
        document.getElementById('retryBtn').style.display = 'none';
    }
}

async function loadFailedContacts() {
    const resp = await fetch(`/api/enrollment-batches/${currentBatchId}/contacts?status=failed`);
    const data = await resp.json();
    const contacts = data.contacts || [];
    if (!contacts.length) return;

    document.getElementById('failedCard').style.display = 'block';
    document.getElementById('failedBody').innerHTML = contacts.map(c => `
        <tr>
            <td>${c.first_name || ''} ${c.last_name || ''}</td>
            <td style="font-size:0.75rem;">${c.email || ''}</td>
            <td style="font-size:0.75rem;">${c.company_name || ''}</td>
            <td style="font-size:0.75rem;color:#DC2626;">${c.error_message || 'Unknown error'}</td>
        </tr>
    `).join('');
}

// --- CSV Export ---
function exportCSV() {
    if (!currentBatchId) return;
    fetch(`/api/enrollment-batches/${currentBatchId}/contacts`)
        .then(r => r.json())
        .then(data => {
            const contacts = data.contacts || [];
            const rows = [['Name','Email','Title','Company','Persona','Sequence','Status','Error']];
            contacts.forEach(c => {
                rows.push([
                    `${c.first_name || ''} ${c.last_name || ''}`.trim(),
                    c.email || '', c.title || '', c.company_name || '',
                    c.persona_name || '', c.sequence_name || '',
                    c.status || '', c.error_message || ''
                ]);
            });
            const csv = rows.map(r => r.map(v => `"${(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `enrollment-batch-${currentBatchId}.csv`;
            a.click();
        });
}

// --- Retry Failed ---
async function retryFailed() {
    if (!currentBatchId) return;
    const resp = await fetch(`/api/enrollment-batches/${currentBatchId}/retry`, {method: 'POST'});
    const data = await resp.json();
    if (data.status === 'success') {
        document.getElementById('retryBtn').style.display = 'none';
        goToStep(3);
        document.getElementById('enrollPhase').textContent = `Retrying ${data.retrying} failed contacts...`;
        document.getElementById('enrollProgress').style.width = '0%';
        pollBatchStatus('enroll');
    }
}

// --- Reset ---
function resetWizard() {
    currentBatchId = null;
    selectedCampaign = null;
    if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
    document.getElementById('campaignSelect').value = '';
    document.getElementById('personasSummary').innerHTML = '';
    document.getElementById('accountsCard').style.display = 'none';
    document.getElementById('contactsResults').style.display = 'none';
    document.getElementById('failedCard').style.display = 'none';
    goToStep(1);
}

// Init
lucide.createIcons();
</script>
{% endblock %}
