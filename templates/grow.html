{% extends "base.html" %}

{% block title %}Grow Pipeline - Lead Machine{% endblock %}

{% block head %}
<style>
    .grow-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    @media (max-width: 1024px) {
        .grow-container {
            grid-template-columns: 1fr;
        }
    }

    .panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
    }

    .panel-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Left Panel - Bulk Import */
    .import-form {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .import-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .companies-textarea {
        flex: 1;
        min-height: 300px;
        padding: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.6;
        resize: vertical;
        outline: none;
        transition: border-color var(--transition-fast);
        margin-bottom: 1rem;
    }

    .companies-textarea:focus {
        border-color: var(--accent-color);
    }

    .companies-textarea::placeholder {
        color: var(--text-muted);
    }

    .process-batch-btn {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--success-color) 0%, #16a34a 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        margin-bottom: 1.5rem;
    }

    .process-batch-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    .process-batch-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .console-log {
        flex: 1;
        background: var(--console-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
        max-height: 400px;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--console-text);
        line-height: 1.4;
    }

    .console-entry {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .console-entry.success {
        color: var(--success-color);
    }

    .console-entry.error {
        color: var(--error-color);
    }

    .console-entry.info {
        color: var(--accent-color);
    }

    .console-entry.warning {
        color: var(--warning-color);
    }

    .console-empty {
        color: var(--text-muted);
        font-style: italic;
        text-align: center;
        padding: 2rem 0;
    }

    /* Right Panel - Discovery Engine */
    .search-box {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .discovery-search {
        flex: 1;
        padding: 0.875rem 1rem;
        font-size: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        outline: none;
        transition: border-color var(--transition-fast);
    }

    .discovery-search:focus {
        border-color: var(--accent-color);
    }

    .discovery-search::placeholder {
        color: var(--text-muted);
    }

    .search-discovery-btn {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .search-discovery-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .search-discovery-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 1rem;
        overflow-y: auto;
        flex: 1;
    }

    .org-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: all var(--transition-normal);
        display: flex;
        flex-direction: column;
    }

    .org-card:hover {
        border-color: var(--accent-color);
        transform: translateY(-2px);
    }

    .org-card.added {
        opacity: 0.5;
    }

    .org-avatar {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
    }

    .org-name {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        word-break: break-word;
    }

    .org-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        line-height: 1.4;
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 1.5em;
    }

    .org-repos {
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
    }

    .track-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 100%;
    }

    .track-btn:hover {
        background: var(--accent-hover);
        transform: scale(1.02);
    }

    .track-btn:disabled {
        background: var(--success-color);
        cursor: default;
        transform: none;
    }

    .no-results {
        text-align: center;
        color: var(--text-muted);
        padding: 3rem 1rem;
        grid-column: 1 / -1;
    }

    .loading {
        text-align: center;
        color: var(--accent-color);
        padding: 2rem 1rem;
        grid-column: 1 / -1;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .page-header {
        background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        border-bottom: 1px solid var(--border-color);
        padding: 2rem;
        margin-bottom: 1rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">üöÄ Grow Pipeline</h1>
        <p class="page-subtitle">Rapidly fill the top of your funnel with new companies</p>
    </div>
</div>

<div class="container">
    <div class="grow-container">
        <!-- Left Panel: Bulk Import -->
        <div class="panel">
            <h2 class="panel-title">üìã Bulk Import</h2>
            <form class="import-form" id="importForm" onsubmit="processImport(event)">
                <label class="import-label">Company Names (one per line)</label>
                <textarea
                    class="companies-textarea"
                    id="companiesInput"
                    placeholder="Shopify&#10;Stripe&#10;Figma&#10;Slack&#10;Notion"
                ></textarea>

                <button type="submit" class="process-batch-btn" id="processBtn">
                    ‚ñ∂ Process Batch
                </button>

                <label class="import-label">Console Log</label>
                <div class="console-log" id="consoleLog">
                    <div class="console-empty">Console output will appear here...</div>
                </div>
            </form>
        </div>

        <!-- Right Panel: Discovery Engine -->
        <div class="panel">
            <h2 class="panel-title">üîç Discovery Engine</h2>

            <div class="search-box">
                <input
                    type="text"
                    class="discovery-search"
                    id="discoverySearch"
                    placeholder="Search keywords (e.g., fintech, health, react)"
                    onkeyup="handleSearchKeyup(event)"
                />
                <button class="search-discovery-btn" id="searchBtn" onclick="performDiscovery()">
                    Search
                </button>
            </div>

            <div class="results-grid" id="resultsGrid">
                <div class="console-empty">Enter a keyword to discover organizations...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function handleSearchKeyup(event) {
        if (event.key === 'Enter') {
            performDiscovery();
        }
    }

    async function performDiscovery() {
        const keyword = document.getElementById('discoverySearch').value.trim();
        if (!keyword) {
            showGridMessage('Please enter a search keyword');
            return;
        }

        const grid = document.getElementById('resultsGrid');
        const btn = document.getElementById('searchBtn');
        btn.disabled = true;

        // Show loading
        grid.innerHTML = '<div class="loading"><div class="spinner"></div> Searching...</div>';

        try {
            const response = await fetch(`/api/discover?q=${encodeURIComponent(keyword)}`);
            const data = await response.json();

            if (response.ok) {
                displayResults(data);
            } else {
                showGridMessage(`Error: ${data.error || 'Search failed'}`);
            }
        } catch (error) {
            showGridMessage(`Error: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }

    function displayResults(orgs) {
        const grid = document.getElementById('resultsGrid');

        if (!orgs || orgs.length === 0) {
            showGridMessage('No organizations found matching this keyword');
            return;
        }

        grid.innerHTML = orgs.map(org => `
            <div class="org-card" data-login="${org.login}">
                <img src="${org.avatar_url}" alt="${org.login}" class="org-avatar" onerror="this.src='https://via.placeholder.com/60'">
                <div class="org-name">${escapeHtml(org.login)}</div>
                <div class="org-description">${escapeHtml(org.description || 'No description')}</div>
                <div class="org-repos">üì¶ ${org.public_repos} repos</div>
                <button
                    class="track-btn"
                    onclick="trackOrganization('${org.login}', this)"
                    data-org="${org.login}"
                >
                    + Track
                </button>
            </div>
        `).join('');
    }

    function showGridMessage(message) {
        document.getElementById('resultsGrid').innerHTML = `<div class="console-empty">${escapeHtml(message)}</div>`;
    }

    async function trackOrganization(orgLogin, button) {
        button.disabled = true;

        try {
            const response = await fetch('/api/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    org_login: orgLogin,
                    company_name: orgLogin
                })
            });

            const data = await response.json();

            if (response.ok) {
                button.textContent = '‚úÖ Added';
                button.parentElement.classList.add('added');
                addConsoleEntry(`‚úì Tracked ${orgLogin} to Tier 0`, 'success');
            } else {
                addConsoleEntry(`‚úó Failed to track ${orgLogin}: ${data.error}`, 'error');
                button.disabled = false;
            }
        } catch (error) {
            addConsoleEntry(`‚úó Error tracking ${orgLogin}: ${error.message}`, 'error');
            button.disabled = false;
        }
    }

    async function processImport(event) {
        event.preventDefault();

        const input = document.getElementById('companiesInput').value.trim();
        const btn = document.getElementById('processBtn');

        if (!input) {
            addConsoleEntry('‚ö† Please enter at least one company name', 'warning');
            return;
        }

        const companies = input.split('\n').map(c => c.trim()).filter(c => c.length > 0);

        clearConsole();
        btn.disabled = true;
        addConsoleEntry(`Starting batch import of ${companies.length} companies...`, 'info');

        try {
            const response = await fetch('/api/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ companies })
            });

            const data = await response.json();

            if (response.ok) {
                addConsoleEntry('', 'info');
                addConsoleEntry(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
                addConsoleEntry(`Import Complete`, 'success');
                addConsoleEntry(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
                addConsoleEntry(`Added: ${data.added.length} / ${data.total_processed}`, 'success');
                addConsoleEntry(`Failed: ${data.failed.length} / ${data.total_processed}`, 'error');
                addConsoleEntry('', 'info');

                // Show results
                data.results.forEach(result => {
                    if (result.status === 'added') {
                        addConsoleEntry(`‚úì ${result.company} ‚Üí ${result.github_org}`, 'success');
                    } else {
                        addConsoleEntry(`‚úó ${result.company} (${result.status})`, 'error');
                    }
                });
            } else {
                addConsoleEntry(`Error: ${data.error}`, 'error');
            }
        } catch (error) {
            addConsoleEntry(`Network Error: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
        }
    }

    function clearConsole() {
        const log = document.getElementById('consoleLog');
        log.innerHTML = '';
    }

    function addConsoleEntry(message, type = 'info') {
        const log = document.getElementById('consoleLog');

        // Clear "empty" message on first entry
        if (log.querySelector('.console-empty')) {
            log.innerHTML = '';
        }

        const entry = document.createElement('div');
        entry.className = `console-entry ${type}`;
        entry.textContent = message;
        log.appendChild(entry);

        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>
{% endblock %}
