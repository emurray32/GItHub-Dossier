{% extends "base.html" %}

{% block title %}Grow Pipeline - Lead Machine{% endblock %}

{% block head %}
<style>
    .grow-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    @media (max-width: 1024px) {
        .grow-container {
            grid-template-columns: 1fr;
        }
    }

    .panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        display: flex;
        flex-direction: column;
    }

    .panel-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Left Panel - Bulk Import */
    .import-form {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .import-label {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .companies-textarea {
        flex: 1;
        min-height: 300px;
        padding: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 0.875rem;
        line-height: 1.6;
        resize: vertical;
        outline: none;
        transition: border-color var(--transition-fast);
        margin-bottom: 1rem;
    }

    .companies-textarea:focus {
        border-color: var(--accent-color);
    }

    .companies-textarea::placeholder {
        color: var(--text-muted);
    }

    .process-batch-btn {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--success-color) 0%, #16a34a 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
        margin-bottom: 1.5rem;
    }

    .process-batch-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    .process-batch-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .console-log {
        flex: 1;
        background: var(--console-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        overflow-y: auto;
        max-height: 400px;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--console-text);
        line-height: 1.4;
    }

    .console-entry {
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .console-entry.success {
        color: var(--success-color);
    }

    .console-entry.error {
        color: var(--error-color);
    }

    .console-entry.info {
        color: var(--accent-color);
    }

    .console-entry.warning {
        color: var(--warning-color);
    }

    .console-empty {
        color: var(--text-muted);
        font-style: italic;
        text-align: center;
        padding: 2rem 0;
    }

    /* Right Panel - Discovery Engine */
    .icp-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .icp-btn {
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .icp-btn:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        transform: translateY(-1px);
    }

    .icp-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .search-box {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .discovery-search {
        flex: 1;
        padding: 0.875rem 1rem;
        font-size: 1rem;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        outline: none;
        transition: border-color var(--transition-fast);
    }

    .discovery-search:focus {
        border-color: var(--accent-color);
    }

    .discovery-search::placeholder {
        color: var(--text-muted);
    }

    .search-discovery-btn {
        padding: 0.875rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--accent-color) 0%, var(--accent-secondary) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }

    .search-discovery-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .search-discovery-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .results-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1rem;
        overflow-y: auto;
        flex: 1;
    }

    .org-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: all var(--transition-normal);
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .org-card:hover {
        border-color: var(--accent-color);
        transform: translateY(-2px);
    }

    .org-card.added {
        opacity: 0.5;
    }

    .org-card-header {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .org-avatar {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        flex-shrink: 0;
    }

    .org-header-info {
        flex: 1;
        min-width: 0;
    }

    .org-name {
        font-size: 0.95rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        word-break: break-word;
    }

    .org-company-name {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.25rem;
    }

    .revenue-badge {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 600;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border-radius: 4px;
    }

    .industry-tag {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
        font-weight: 500;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }

    .org-description {
        font-size: 0.75rem;
        color: var(--text-secondary);
        line-height: 1.4;
        margin-bottom: 0.75rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 2.1em;
    }

    .org-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        font-size: 0.7rem;
    }

    .org-repos {
        color: var(--text-muted);
    }

    .github-status {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 500;
    }

    .github-status.validated {
        background: rgba(34, 197, 94, 0.1);
        color: var(--success-color);
    }

    .github-status.uncertain {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .track-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all var(--transition-fast);
        width: 100%;
    }

    .track-btn:hover {
        background: var(--accent-hover);
        transform: scale(1.02);
    }

    .track-btn:disabled {
        background: var(--success-color);
        cursor: default;
        transform: none;
    }

    .no-results {
        text-align: center;
        color: var(--text-muted);
        padding: 3rem 1rem;
        grid-column: 1 / -1;
    }

    .loading {
        text-align: center;
        color: var(--accent-color);
        padding: 2rem 1rem;
        grid-column: 1 / -1;
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--border-color);
        border-top-color: var(--accent-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .discovery-mode-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .mode-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .mode-btn:hover {
        border-color: var(--accent-color);
    }

    .mode-btn.active {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .page-header {
        background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
        border-bottom: 1px solid var(--border-color);
        padding: 2rem;
        margin-bottom: 1rem;
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">üöÄ Grow Pipeline</h1>
        <p class="page-subtitle">Rapidly fill the top of your funnel with new companies</p>
    </div>
</div>

<div class="container">
    <div class="grow-container">
        <!-- Left Panel: Bulk Import -->
        <div class="panel">
            <h2 class="panel-title">üìã Bulk Import</h2>
            <form class="import-form" id="importForm" onsubmit="processImport(event)">
                <label class="import-label">Company Names (one per line)</label>
                <textarea
                    class="companies-textarea"
                    id="companiesInput"
                    placeholder="Shopify&#10;Stripe&#10;Figma&#10;Slack&#10;Notion"
                ></textarea>

                <button type="submit" class="process-batch-btn" id="processBtn">
                    ‚ñ∂ Process Batch
                </button>

                <label class="import-label">Console Log</label>
                <div class="console-log" id="consoleLog">
                    <div class="console-empty">Console output will appear here...</div>
                </div>
            </form>
        </div>

        <!-- Right Panel: Discovery Engine -->
        <div class="panel">
            <h2 class="panel-title">üîç Universal Discovery Engine</h2>

            <!-- Discovery Mode Toggle -->
            <div class="discovery-mode-toggle">
                <button class="mode-btn" id="modeGithub" onclick="setDiscoveryMode('github')">GitHub Search</button>
                <button class="mode-btn active" id="modeAI" onclick="setDiscoveryMode('ai')">AI Discovery</button>
            </div>

            <!-- ICP Presets -->
            <div class="icp-presets" id="icpPresets">
                <button class="icp-btn" onclick="selectICP('Retail/DTC E-commerce')">üõçÔ∏è Retail/DTC</button>
                <button class="icp-btn" onclick="selectICP('Fintech Banking')">üí∏ Fintech</button>
                <button class="icp-btn" onclick="selectICP('HealthTech Medical')">üè• HealthTech</button>
                <button class="icp-btn" onclick="selectICP('Logistics Supply Chain')">üè≠ Logistics</button>
                <button class="icp-btn" onclick="selectICP('SaaS B2B Software')">‚òÅÔ∏è SaaS</button>
            </div>

            <div class="search-box">
                <input
                    type="text"
                    class="discovery-search"
                    id="discoverySearch"
                    placeholder="Enter industry (e.g., Fintech, HealthTech, DTC Retail)"
                    onkeyup="handleSearchKeyup(event)"
                />
                <button class="search-discovery-btn" id="searchBtn" onclick="performDiscovery()">
                    Discover
                </button>
            </div>

            <div class="results-grid" id="resultsGrid">
                <div class="console-empty">Select an ICP preset or enter an industry to discover companies...</div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Discovery mode: 'ai' or 'github'
    let discoveryMode = 'ai';

    function setDiscoveryMode(mode) {
        discoveryMode = mode;

        // Update button states
        document.getElementById('modeAI').classList.toggle('active', mode === 'ai');
        document.getElementById('modeGithub').classList.toggle('active', mode === 'github');

        // Show/hide ICP presets (only for AI mode)
        document.getElementById('icpPresets').style.display = mode === 'ai' ? 'flex' : 'none';

        // Update placeholder
        const searchInput = document.getElementById('discoverySearch');
        if (mode === 'ai') {
            searchInput.placeholder = 'Enter industry (e.g., Fintech, HealthTech, DTC Retail)';
        } else {
            searchInput.placeholder = 'Search keywords (e.g., fintech, health, react)';
        }

        // Clear results
        showGridMessage(mode === 'ai'
            ? 'Select an ICP preset or enter an industry to discover companies...'
            : 'Enter a keyword to search GitHub organizations...'
        );
    }

    function selectICP(industry) {
        // Update search input
        document.getElementById('discoverySearch').value = industry;

        // Clear active state from all ICP buttons
        document.querySelectorAll('.icp-btn').forEach(btn => btn.classList.remove('active'));

        // Mark clicked button as active
        event.target.classList.add('active');

        // Trigger discovery
        performDiscovery();
    }

    function handleSearchKeyup(event) {
        if (event.key === 'Enter') {
            performDiscovery();
        }
    }

    async function performDiscovery() {
        const keyword = document.getElementById('discoverySearch').value.trim();
        if (!keyword) {
            showGridMessage('Please enter a search keyword');
            return;
        }

        const grid = document.getElementById('resultsGrid');
        const btn = document.getElementById('searchBtn');
        btn.disabled = true;

        // Show loading with mode-specific message
        const loadingMsg = discoveryMode === 'ai'
            ? 'AI is discovering companies...'
            : 'Searching GitHub...';
        grid.innerHTML = `<div class="loading"><div class="spinner"></div> ${loadingMsg}</div>`;

        try {
            // Use different API based on mode
            const apiUrl = discoveryMode === 'ai'
                ? `/api/ai-discover?q=${encodeURIComponent(keyword)}`
                : `/api/discover?q=${encodeURIComponent(keyword)}`;

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (response.ok) {
                if (discoveryMode === 'ai') {
                    displayAIResults(data);
                } else {
                    displayGitHubResults(data);
                }
            } else {
                showGridMessage(`Error: ${data.error || 'Search failed'}`);
            }
        } catch (error) {
            showGridMessage(`Error: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }

    function displayAIResults(companies) {
        const grid = document.getElementById('resultsGrid');

        if (!companies || companies.length === 0) {
            showGridMessage('No companies found. Try a different industry or check if AI is configured.');
            return;
        }

        grid.innerHTML = companies.map(company => {
            const githubData = company.github_data || {};
            const orgLogin = githubData.login || company.suggested_github_org || '';
            const avatarUrl = githubData.avatar_url || 'https://via.placeholder.com/50?text=' + encodeURIComponent(company.name.charAt(0));
            const repoCount = githubData.public_repos || 0;
            const isValidated = company.github_validated;

            return `
                <div class="org-card" data-login="${escapeHtml(orgLogin)}">
                    <span class="revenue-badge">üí∞ ${escapeHtml(company.revenue || 'Unknown')}</span>

                    <div class="org-card-header">
                        <img src="${avatarUrl}" alt="${escapeHtml(company.name)}" class="org-avatar" onerror="this.src='https://via.placeholder.com/50'">
                        <div class="org-header-info">
                            <div class="org-name">${escapeHtml(company.name)}</div>
                            <div class="org-company-name">@${escapeHtml(orgLogin)}</div>
                        </div>
                    </div>

                    <span class="industry-tag">${escapeHtml(company.industry || 'Tech')}</span>

                    <div class="org-description">${escapeHtml(company.description || 'No description available')}</div>

                    <div class="org-meta">
                        <span class="org-repos">üì¶ ${repoCount} repos</span>
                        <span class="github-status ${isValidated ? 'validated' : 'uncertain'}">
                            ${isValidated ? '‚úÖ GitHub Found' : '‚ö†Ô∏è GitHub Uncertain'}
                        </span>
                    </div>

                    <button
                        class="track-btn"
                        onclick="trackOrganization('${escapeHtml(orgLogin)}', '${escapeHtml(company.name)}', this)"
                        data-org="${escapeHtml(orgLogin)}"
                        ${!isValidated ? 'disabled title="GitHub org not validated"' : ''}
                    >
                        ${isValidated ? '+ Track' : 'GitHub Not Found'}
                    </button>
                </div>
            `;
        }).join('');
    }

    function displayGitHubResults(orgs) {
        const grid = document.getElementById('resultsGrid');

        if (!orgs || orgs.length === 0) {
            showGridMessage('No organizations found matching this keyword');
            return;
        }

        grid.innerHTML = orgs.map(org => `
            <div class="org-card" data-login="${escapeHtml(org.login)}">
                <div class="org-card-header">
                    <img src="${org.avatar_url}" alt="${escapeHtml(org.login)}" class="org-avatar" onerror="this.src='https://via.placeholder.com/50'">
                    <div class="org-header-info">
                        <div class="org-name">${escapeHtml(org.login)}</div>
                    </div>
                </div>

                <div class="org-description">${escapeHtml(org.description || 'No description')}</div>

                <div class="org-meta">
                    <span class="org-repos">üì¶ ${org.public_repos} repos</span>
                    <span class="github-status validated">‚úÖ GitHub Found</span>
                </div>

                <button
                    class="track-btn"
                    onclick="trackOrganization('${escapeHtml(org.login)}', '${escapeHtml(org.login)}', this)"
                    data-org="${escapeHtml(org.login)}"
                >
                    + Track
                </button>
            </div>
        `).join('');
    }

    function showGridMessage(message) {
        document.getElementById('resultsGrid').innerHTML = `<div class="console-empty">${escapeHtml(message)}</div>`;
    }

    async function trackOrganization(orgLogin, companyName, button) {
        button.disabled = true;

        try {
            const response = await fetch('/api/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    org_login: orgLogin,
                    company_name: companyName || orgLogin
                })
            });

            const data = await response.json();

            if (response.ok) {
                button.textContent = '‚úÖ Added';
                button.parentElement.classList.add('added');
                addConsoleEntry(`‚úì Tracked ${companyName || orgLogin} (@${orgLogin}) to Tier 0`, 'success');
            } else {
                addConsoleEntry(`‚úó Failed to track ${orgLogin}: ${data.error}`, 'error');
                button.disabled = false;
            }
        } catch (error) {
            addConsoleEntry(`‚úó Error tracking ${orgLogin}: ${error.message}`, 'error');
            button.disabled = false;
        }
    }

    async function processImport(event) {
        event.preventDefault();

        const input = document.getElementById('companiesInput').value.trim();
        const btn = document.getElementById('processBtn');

        if (!input) {
            addConsoleEntry('‚ö† Please enter at least one company name', 'warning');
            return;
        }

        const companies = input.split('\n').map(c => c.trim()).filter(c => c.length > 0);

        clearConsole();
        btn.disabled = true;
        addConsoleEntry(`Starting batch import of ${companies.length} companies...`, 'info');

        try {
            const response = await fetch('/api/import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ companies })
            });

            const data = await response.json();

            if (response.ok) {
                addConsoleEntry('', 'info');
                addConsoleEntry(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
                addConsoleEntry(`Import Complete`, 'success');
                addConsoleEntry(`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`, 'info');
                addConsoleEntry(`Added: ${data.added.length} / ${data.total_processed}`, 'success');
                addConsoleEntry(`Failed: ${data.failed.length} / ${data.total_processed}`, 'error');
                addConsoleEntry('', 'info');

                // Show results
                data.results.forEach(result => {
                    if (result.status === 'added') {
                        addConsoleEntry(`‚úì ${result.company} ‚Üí ${result.github_org}`, 'success');
                    } else {
                        addConsoleEntry(`‚úó ${result.company} (${result.status})`, 'error');
                    }
                });
            } else {
                addConsoleEntry(`Error: ${data.error}`, 'error');
            }
        } catch (error) {
            addConsoleEntry(`Network Error: ${error.message}`, 'error');
        } finally {
            btn.disabled = false;
        }
    }

    function clearConsole() {
        const log = document.getElementById('consoleLog');
        log.innerHTML = '';
    }

    function addConsoleEntry(message, type = 'info') {
        const log = document.getElementById('consoleLog');

        // Clear "empty" message on first entry
        if (log.querySelector('.console-empty')) {
            log.innerHTML = '';
        }

        const entry = document.createElement('div');
        entry.className = `console-entry ${type}`;
        entry.textContent = message;
        log.appendChild(entry);

        // Auto-scroll to bottom
        log.scrollTop = log.scrollHeight;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        setDiscoveryMode('ai');
    });
</script>
{% endblock %}
