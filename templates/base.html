<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Lead Machine{% endblock %}</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%234F46E5'/><circle cx='50' cy='50' r='30' fill='none' stroke='white' stroke-width='4'/><line x1='71' y1='71' x2='90' y2='90' stroke='white' stroke-width='8' stroke-linecap='round'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=2">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    {% block head %}{% endblock %}
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="app-layout">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
            <div class="sidebar-header">
                <a href="{{ url_for('accounts') }}" class="sidebar-brand">
                    <svg class="sidebar-brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="11" cy="11" r="7"></circle>
                        <line x1="16.65" y1="16.65" x2="21" y2="21"></line>
                    </svg>
                    <span class="sidebar-brand-text">Lead Machine</span>
                </a>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <i data-lucide="panel-left-close" class="sidebar-toggle-icon"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <a href="{{ url_for('accounts') }}" class="sidebar-item {% if request.endpoint == 'accounts' %}active{% endif %}">
                    <i data-lucide="radar" class="sidebar-icon"></i>
                    <span class="sidebar-label">RepoRadar</span>
                </a>
                <a href="{{ url_for('contributors') }}" class="sidebar-item {% if request.endpoint == 'contributors' %}active{% endif %}">
                    <i data-lucide="users" class="sidebar-icon"></i>
                    <span class="sidebar-label">Contributors</span>
                </a>
                <a href="{{ url_for('grow') }}" class="sidebar-item {% if request.endpoint == 'grow' %}active{% endif %}">
                    <i data-lucide="trending-up" class="sidebar-icon"></i>
                    <span class="sidebar-label">Grow</span>
                </a>
                <a href="{{ url_for('linkedin_prospector') }}" class="sidebar-item {% if request.endpoint == 'linkedin_prospector' %}active{% endif %}">
                    <i data-lucide="scan-search" class="sidebar-icon"></i>
                    <span class="sidebar-label">LinkedIn Prospector</span>
                </a>
                <a href="{{ url_for('settings') }}" class="sidebar-item {% if request.endpoint == 'settings' %}active{% endif %}">
                    <i data-lucide="settings" class="sidebar-icon"></i>
                    <span class="sidebar-label">Settings</span>
                </a>
            </nav>

            <!-- Outbound Portal -->
            <div class="sidebar-section">
                <div class="sidebar-section-header">
                    <span class="sidebar-section-label">Outbound Portal</span>
                </div>
                <button class="sidebar-item sidebar-item-btn" id="mapSequenceBtn" aria-haspopup="dialog" aria-label="Map New Sequence">
                    <i data-lucide="send" class="sidebar-icon"></i>
                    <span class="sidebar-label">Map Sequence</span>
                </button>
            </div>
        </aside>

        <!-- Map New Sequence Modal -->
        <div class="modal-overlay" id="seqModalOverlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="seqModalTitle">
            <div class="modal-content" style="width:520px;max-width:92vw;">
                <div class="seq-modal-header">
                    <span class="seq-modal-title" id="seqModalTitle">Map New Sequence</span>
                    <button class="seq-modal-close" id="seqModalClose" aria-label="Close">
                        <i data-lucide="x" style="width:16px;height:16px;"></i>
                    </button>
                </div>

                <div class="seq-modal-body">
                    <!-- Apollo Template ID -->
                    <div class="seq-field-group">
                        <label class="seq-field-label" for="seqTemplateId">
                            Apollo Template ID
                            <span class="seq-info-wrap" tabindex="0">
                                <span class="seq-info-icon" aria-label="Help">i</span>
                                <span class="seq-tooltip" role="tooltip">Find your Template ID in Apollo under Sequences → Settings → Sequence ID</span>
                            </span>
                        </label>
                        <div class="seq-input-row">
                            <input type="text" id="seqTemplateId" class="seq-input" placeholder="e.g. 64a3f1b2c8d9e0f12345abcd" autocomplete="off" spellcheck="false">
                            <div class="seq-detect-spinner" id="seqDetectSpinner"></div>
                        </div>
                        <div class="seq-detect-status" id="seqDetectStatus"></div>
                    </div>

                    <!-- Sequence Configuration Cards -->
                    <div class="seq-field-group">
                        <span class="seq-config-label">Sequence Configuration</span>
                        <div class="seq-cards" id="seqCards" role="radiogroup" aria-label="Sequence Configuration">

                            <div class="seq-card" data-value="one_off" tabindex="0" role="radio" aria-checked="false">
                                <div class="seq-card-radio"></div>
                                <div class="seq-card-body">
                                    <div class="seq-card-title">
                                        One-Off Email
                                        <span class="seq-autodetect-badge" id="badge_one_off" style="display:none;">&#10003; Auto-detected</span>
                                    </div>
                                    <div class="seq-card-subtitle">Single email, no threading</div>
                                </div>
                            </div>

                            <div class="seq-card" data-value="threaded_4" tabindex="0" role="radio" aria-checked="false">
                                <div class="seq-card-radio"></div>
                                <div class="seq-card-body">
                                    <div class="seq-card-title">
                                        Threaded Sequence (4 Emails)
                                        <span class="seq-autodetect-badge" id="badge_threaded_4" style="display:none;">&#10003; Auto-detected</span>
                                    </div>
                                    <div class="seq-card-subtitle">4 emails threaded under one subject line</div>
                                </div>
                            </div>

                            <div class="seq-card" data-value="split_2x2" tabindex="0" role="radio" aria-checked="false">
                                <div class="seq-card-radio"></div>
                                <div class="seq-card-body">
                                    <div class="seq-card-title">
                                        Split Thread (2x2)
                                        <span class="seq-autodetect-badge" id="badge_split_2x2" style="display:none;">&#10003; Auto-detected</span>
                                    </div>
                                    <div class="seq-card-subtitle">Two pairs of threaded emails, each pair with its own subject line</div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Saved Sequences List -->
                    <div class="seq-saved-section">
                        <div class="seq-saved-title">Mapped Sequences</div>
                        <div class="seq-saved-list" id="seqSavedList">
                            <div class="seq-saved-empty">No sequences mapped yet.</div>
                        </div>
                    </div>
                </div>

                <div class="seq-modal-footer">
                    <button class="btn-secondary" id="seqCancelBtn">Cancel</button>
                    <button class="btn-primary" id="seqSaveBtn">Save Sequence</button>
                </div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="main-area">
            {% block breadcrumb %}{% endblock %}
            <main class="main-content" id="main-content">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <script>
        function timeAgo(dateString) {
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) {
                return dateString;
            }

            const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
            if (seconds < 60) return `${Math.max(seconds, 1)} sec${seconds === 1 ? '' : 's'} ago`;

            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes} min${minutes === 1 ? '' : 's'} ago`;

            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;

            const days = Math.floor(hours / 24);
            if (days < 30) return `${days} day${days === 1 ? '' : 's'} ago`;

            const months = Math.floor(days / 30);
            if (months < 12) return `${months} month${months === 1 ? '' : 's'} ago`;

            const years = Math.floor(months / 12);
            return `${years} year${years === 1 ? '' : 's'} ago`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.scanned-time').forEach((element) => {
                const dateString = element.dataset.iso || element.textContent.trim();
                element.textContent = timeAgo(dateString);
            });

            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Sidebar collapse toggle
            const sidebar = document.getElementById('sidebar');
            const toggle = document.getElementById('sidebarToggle');
            const collapsed = localStorage.getItem('sidebar-collapsed') === 'true';

            if (collapsed) {
                sidebar.classList.add('collapsed');
            }

            if (toggle) {
                toggle.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    localStorage.setItem('sidebar-collapsed', sidebar.classList.contains('collapsed'));
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                });
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key !== '/' || event.defaultPrevented) return;

            const target = event.target;
            const isEditable = target instanceof HTMLElement
                && (target.isContentEditable
                    || ['INPUT', 'TEXTAREA', 'SELECT'].includes(target.tagName));

            if (isEditable) return;

            const searchInput = document.querySelector("input[name='q']");
            if (searchInput) {
                event.preventDefault();
                searchInput.focus();
            }
        });
    </script>

    <!-- Outbound Portal: Map New Sequence -->
    <script>
    (function () {
        'use strict';

        var STORAGE_KEY = 'outbound_sequences_v1';
        var CONFIG_LABELS = {
            'one_off':      'One-Off Email',
            'threaded_4':   'Threaded Sequence (4 Emails)',
            'split_2x2':    'Split Thread (2x2)'
        };

        // ── Storage helpers ──────────────────────────────────────
        function loadSequences() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
            catch (e) { return []; }
        }
        function saveSequences(list) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }
        function escHtml(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // ── Render saved list ────────────────────────────────────
        function renderSaved(animateLatest) {
            var list = loadSequences();
            var container = document.getElementById('seqSavedList');
            if (!container) return;

            if (!list.length) {
                container.innerHTML = '<div class="seq-saved-empty">No sequences mapped yet.</div>';
                return;
            }

            var lastIdx = list.length - 1;
            container.innerHTML = list.map(function (seq, idx) {
                var displayName = seq.name || seq.id;
                var subtitle = seq.name ? seq.id : '';
                var animClass = (animateLatest && idx === lastIdx) ? ' seq-item-enter' : '';
                return '<div class="seq-saved-item' + animClass + '">' +
                    '<div class="seq-saved-info">' +
                    '<span class="seq-saved-name">' + escHtml(displayName) + '</span>' +
                    (subtitle ? '<span class="seq-saved-id">' + escHtml(subtitle) + '</span>' : '') +
                    '<span class="seq-saved-type">' + escHtml(CONFIG_LABELS[seq.config] || seq.config) + '</span>' +
                    '</div>' +
                    '<button class="seq-saved-delete" data-idx="' + idx + '" aria-label="Delete sequence">' +
                    '<i data-lucide="x" style="width:13px;height:13px;pointer-events:none;"></i>' +
                    '</button>' +
                    '</div>';
            }).join('');

            if (typeof lucide !== 'undefined') lucide.createIcons();

            container.querySelectorAll('.seq-saved-delete').forEach(function (btn) {
                btn.addEventListener('click', function () {
                    var idx = parseInt(this.dataset.idx, 10);
                    var seqs = loadSequences();
                    seqs.splice(idx, 1);
                    saveSequences(seqs);
                    renderSaved();
                });
            });
        }

        // ── Card selection ───────────────────────────────────────
        var selectedConfig = null;
        var detectedName = '';

        function selectCard(value) {
            document.querySelectorAll('.seq-card').forEach(function (c) {
                var isMatch = c.dataset.value === value;
                c.classList.toggle('selected', isMatch);
                c.setAttribute('aria-checked', isMatch ? 'true' : 'false');
            });
            selectedConfig = value;
        }

        function clearAutodetectBadges() {
            document.querySelectorAll('.seq-autodetect-badge').forEach(function (b) {
                b.style.display = 'none';
            });
        }

        function showAutodetectBadge(value) {
            clearAutodetectBadges();
            var badge = document.getElementById('badge_' + value);
            if (badge) badge.style.display = 'inline-flex';
        }

        // ── Apollo auto-detect (debounced) ───────────────────────
        var detectTimer = null;
        var lastDetectedId = '';

        function setDetectStatus(msg, cls) {
            var el = document.getElementById('seqDetectStatus');
            if (!el) return;
            el.textContent = msg;
            el.className = 'seq-detect-status' + (cls ? ' ' + cls : '');
        }

        function setDetectSpinner(show) {
            var el = document.getElementById('seqDetectSpinner');
            if (el) el.style.display = show ? 'block' : 'none';
        }

        function tryAutoDetect(seqId) {
            if (!seqId || seqId === lastDetectedId) return;
            lastDetectedId = seqId;
            clearAutodetectBadges();
            setDetectStatus('');
            setDetectSpinner(true);

            fetch('/api/apollo/sequence-detect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sequence_id: seqId })
            })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                setDetectSpinner(false);
                if (data.status === 'success' && data.detected_config) {
                    selectCard(data.detected_config);
                    showAutodetectBadge(data.detected_config);
                    detectedName = data.sequence_name || '';
                    var name = detectedName ? ' — ' + detectedName : '';
                    setDetectStatus('Auto-detected: ' + (CONFIG_LABELS[data.detected_config] || data.detected_config) + name, 'status-ok');
                } else if (data.status === 'not_found') {
                    setDetectStatus('Sequence not found — select config manually.', 'status-warn');
                } else if (data.status === 'no_key') {
                    setDetectStatus('Apollo API key not set — select config manually.');
                } else {
                    setDetectStatus('Could not auto-detect — select config manually.');
                }
            })
            .catch(function () {
                setDetectSpinner(false);
                setDetectStatus('');
            });
        }

        // ── Modal open / close ───────────────────────────────────
        function openModal() {
            var overlay = document.getElementById('seqModalOverlay');
            if (!overlay) return;
            // Reset form state
            var input = document.getElementById('seqTemplateId');
            if (input) input.value = '';
            document.querySelectorAll('.seq-card').forEach(function (c) {
                c.classList.remove('selected');
                c.setAttribute('aria-checked', 'false');
            });
            clearAutodetectBadges();
            setDetectStatus('');
            setDetectSpinner(false);
            selectedConfig = null;
            lastDetectedId = '';
            renderSaved();
            overlay.style.display = 'flex';
            if (input) setTimeout(function () { input.focus(); }, 50);
        }

        function closeModal() {
            var overlay = document.getElementById('seqModalOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        // ── Init ─────────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', function () {

            // Open / close
            var openBtn = document.getElementById('mapSequenceBtn');
            if (openBtn) openBtn.addEventListener('click', openModal);

            var closeBtn = document.getElementById('seqModalClose');
            if (closeBtn) closeBtn.addEventListener('click', closeModal);

            var cancelBtn = document.getElementById('seqCancelBtn');
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);

            var overlay = document.getElementById('seqModalOverlay');
            if (overlay) {
                overlay.addEventListener('click', function (e) {
                    if (e.target === overlay) closeModal();
                });
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    var ov = document.getElementById('seqModalOverlay');
                    if (ov && ov.style.display !== 'none') closeModal();
                }
            });

            // Card click/keyboard
            document.querySelectorAll('.seq-card').forEach(function (card) {
                card.addEventListener('click', function () {
                    clearAutodetectBadges();
                    selectCard(card.dataset.value);
                });
                card.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        clearAutodetectBadges();
                        selectCard(card.dataset.value);
                    }
                });
            });

            // ID input with debounced auto-detect
            var idInput = document.getElementById('seqTemplateId');
            if (idInput) {
                idInput.addEventListener('input', function () {
                    idInput.classList.remove('input-error');
                    var val = idInput.value.trim();
                    clearTimeout(detectTimer);
                    if (val.length >= 16) {
                        detectTimer = setTimeout(function () { tryAutoDetect(val); }, 600);
                    } else {
                        clearAutodetectBadges();
                        setDetectStatus('');
                        setDetectSpinner(false);
                        lastDetectedId = '';
                    }
                });
            }

            // Save sequence
            var saveBtn = document.getElementById('seqSaveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function () {
                    var input = document.getElementById('seqTemplateId');
                    var id = input ? input.value.trim() : '';

                    if (!id) {
                        if (input) {
                            input.classList.add('input-error');
                            input.focus();
                            setTimeout(function () { input.classList.remove('input-error'); }, 1500);
                        }
                        return;
                    }

                    if (!selectedConfig) {
                        var cards = document.getElementById('seqCards');
                        if (cards) {
                            cards.style.outline = '2px solid var(--color-destructive)';
                            cards.style.borderRadius = '8px';
                            setTimeout(function () {
                                cards.style.outline = '';
                                cards.style.borderRadius = '';
                            }, 1500);
                        }
                        return;
                    }

                    var seqs = loadSequences();
                    var existing = seqs.findIndex(function (s) { return s.id === id; });
                    if (existing !== -1) {
                        seqs[existing].config = selectedConfig;
                        if (detectedName) seqs[existing].name = detectedName;
                    } else {
                        seqs.push({ id: id, config: selectedConfig, name: detectedName || '' });
                    }
                    saveSequences(seqs);
                    renderSaved(true);

                    // Reset form for next entry
                    if (input) input.value = '';
                    document.querySelectorAll('.seq-card').forEach(function (c) {
                        c.classList.remove('selected');
                        c.setAttribute('aria-checked', 'false');
                    });
                    clearAutodetectBadges();
                    setDetectStatus('');
                    selectedConfig = null;
                    lastDetectedId = '';
                    detectedName = '';
                    if (input) input.focus();
                });
            }

        }); // end DOMContentLoaded
    }());
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>
