{% extends "base.html" %}

{% block title %}Contributors - Lead Machine{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('accounts') }}">
                <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Accounts
            </a>
        </li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item active" aria-current="page">Contributors</li>
    </ol>
</nav>
{% endblock %}

{% block head %}
<style>
    .contributors-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    /* Stats bar */
    .contrib-stats-bar {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .contrib-stat-card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 1rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        min-width: 140px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
    }

    .contrib-stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
    }

    .contrib-stat-card .stat-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .contrib-stat-card.stat-enrolled .stat-value { color: var(--accent-color); }
    .contrib-stat-card.stat-emails .stat-value { color: var(--success-color); }

    /* Controls row */
    .contrib-controls {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
    }

    .contrib-search {
        flex: 1;
        min-width: 220px;
        max-width: 400px;
        padding: 0.6rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: border-color var(--transition-fast);
    }

    .contrib-search:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(0, 181, 173, 0.1);
    }

    .contrib-filter-select {
        padding: 0.6rem 0.85rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        background: var(--bg-primary);
        color: var(--text-secondary);
        cursor: pointer;
    }

    .btn-fetch-contributors {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.6rem 1.1rem;
        background: var(--accent-color);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .btn-fetch-contributors:hover { background: var(--accent-hover); }
    .btn-fetch-contributors:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-fetch-contributors svg { width: 15px; height: 15px; }

    /* Table */
    .contrib-table-container {
        background: var(--bg-primary);
        border-radius: 12px;
        overflow-x: auto;
        border: 1px solid var(--border-color);
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    }

    .contrib-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.84rem;
        table-layout: fixed;
    }

    .contrib-table thead th {
        background: var(--bg-secondary);
        padding: 0.7rem 0.6rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--text-secondary);
        border-bottom: 2px solid var(--border-color);
        white-space: nowrap;
        position: sticky;
        top: 0;
        z-index: 2;
        user-select: none;
    }

    .contrib-table thead th.sortable {
        cursor: pointer;
    }

    .contrib-table thead th.sortable:hover {
        color: var(--accent-color);
    }

    .contrib-table thead th .sort-indicator {
        display: inline-flex;
        flex-direction: column;
        font-size: 0.55rem;
        line-height: 0.7;
        margin-left: 0.3rem;
        vertical-align: middle;
        opacity: 0.3;
    }

    .contrib-table thead th.sort-asc .sort-indicator .asc,
    .contrib-table thead th.sort-desc .sort-indicator .desc {
        opacity: 1;
        color: var(--accent-color);
    }

    .contrib-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background var(--transition-fast);
    }

    .contrib-table tbody tr:hover {
        background: var(--bg-secondary);
    }

    .contrib-table tbody tr.expanded {
        background: rgba(0, 181, 173, 0.04);
    }

    .contrib-table tbody td {
        padding: 0.65rem 0.6rem;
        color: var(--text-primary);
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Column widths */
    .col-expand { width: 36px; text-align: center; }
    .col-name { width: 14%; }
    .col-github { width: 11%; }
    .col-company { width: 12%; }
    .col-size { width: 8%; }
    .col-revenue { width: 9%; }
    .col-repo { width: 11%; }
    .col-apollo { width: 8%; text-align: center; }
    .col-emails { width: 6%; text-align: center; }
    .col-insight { width: 21%; }

    /* Expand arrow */
    .expand-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0.2rem;
        border-radius: 4px;
        transition: all var(--transition-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .expand-btn:hover { color: var(--accent-color); background: rgba(0,181,173,0.08); }
    .expand-btn svg { width: 16px; height: 16px; transition: transform 0.2s ease; }
    .expand-btn.open svg { transform: rotate(90deg); }

    /* Expanded detail row */
    .contrib-detail-row td {
        padding: 0 !important;
        background: var(--bg-secondary);
    }

    .contrib-detail-content {
        padding: 1.25rem 1.5rem 1.25rem 3rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
        from { opacity: 0; max-height: 0; }
        to { opacity: 1; max-height: 500px; }
    }

    .detail-section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 0.4rem;
    }

    .detail-email-form {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-width: 600px;
    }

    .detail-email-form input,
    .detail-email-form textarea {
        padding: 0.6rem 0.85rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.85rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: var(--font-sans);
    }

    .detail-email-form textarea {
        min-height: 80px;
        resize: vertical;
    }

    .detail-email-form input:focus,
    .detail-email-form textarea:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(0, 181, 173, 0.1);
    }

    .detail-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .btn-send-email {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.55rem 1rem;
        background: var(--accent-color);
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 0.82rem;
        font-weight: 600;
        cursor: pointer;
        transition: background var(--transition-fast);
    }

    .btn-send-email:hover { background: var(--accent-hover); }
    .btn-send-email:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-send-email svg { width: 14px; height: 14px; }

    .btn-add-sequence {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.55rem 1rem;
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 0.82rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .btn-add-sequence:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .btn-add-sequence.enrolled {
        background: rgba(0, 181, 173, 0.1);
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    .btn-add-sequence svg { width: 14px; height: 14px; }

    /* Apollo badge */
    .apollo-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.25rem 0.6rem;
        border-radius: 20px;
        font-size: 0.72rem;
        font-weight: 600;
        white-space: nowrap;
    }

    .apollo-badge.not-sent {
        background: var(--bg-tertiary);
        color: var(--text-muted);
    }

    .apollo-badge.sent {
        background: rgba(0, 181, 173, 0.12);
        color: var(--accent-color);
    }

    .apollo-badge svg { width: 10px; height: 10px; }

    /* GitHub link */
    .github-link {
        color: var(--text-secondary);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        transition: color var(--transition-fast);
    }

    .github-link:hover { color: var(--accent-color); }
    .github-link svg { width: 13px; height: 13px; flex-shrink: 0; }

    /* Pagination */
    .contrib-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        font-size: 0.82rem;
        color: var(--text-secondary);
    }

    .contrib-pagination .page-info { font-weight: 500; }

    .contrib-page-buttons {
        display: flex;
        gap: 0.35rem;
    }

    .contrib-page-btn {
        padding: 0.4rem 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .contrib-page-btn:hover { border-color: var(--accent-color); color: var(--accent-color); }
    .contrib-page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .contrib-page-btn.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); }

    /* Empty state */
    .contrib-empty {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-muted);
    }

    .contrib-empty svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.4; }
    .contrib-empty h3 { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .contrib-empty p { font-size: 0.85rem; max-width: 400px; margin: 0 auto 1.5rem; }

    /* Detail info grid */
    .detail-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 0.6rem;
    }

    .detail-info-item {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .detail-info-item .label {
        font-size: 0.7rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-weight: 600;
    }

    .detail-info-item .value {
        font-size: 0.85rem;
        color: var(--text-primary);
        word-break: break-word;
    }

    .detail-info-item .value a {
        color: var(--accent-color);
        text-decoration: none;
    }

    .detail-info-item .value a:hover { text-decoration: underline; }

    /* Fetch spinner */
    .fetch-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #fff;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Toast notification */
    .contrib-toast {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        padding: 0.75rem 1.25rem;
        border-radius: 10px;
        font-size: 0.85rem;
        font-weight: 500;
        color: #fff;
        z-index: 9999;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .contrib-toast.visible {
        opacity: 1;
        transform: translateY(0);
    }

    .contrib-toast.success { background: var(--success-color); }
    .contrib-toast.error { background: var(--error-color); }

    /* Row number */
    .col-num { width: 36px; text-align: center; color: var(--text-muted); font-size: 0.75rem; }

    /* Insight text truncation */
    .insight-text {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        line-height: 1.4;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }
</style>
{% endblock %}

{% block content %}
<div class="contributors-container">

    <!-- Stats Bar -->
    <div class="contrib-stats-bar">
        <div class="contrib-stat-card">
            <span class="stat-value" id="stat-total">{{ stats.total_contributors }}</span>
            <span class="stat-label">Contributors</span>
        </div>
        <div class="contrib-stat-card stat-enrolled">
            <span class="stat-value" id="stat-enrolled">{{ stats.total_enrolled }}</span>
            <span class="stat-label">Enrolled in Sequence</span>
        </div>
        <div class="contrib-stat-card stat-emails">
            <span class="stat-value" id="stat-emails">{{ stats.total_emails_sent }}</span>
            <span class="stat-label">Emails Sent</span>
        </div>
    </div>

    <!-- Controls -->
    <div class="contrib-controls">
        <input type="text" class="contrib-search" id="contrib-search" placeholder="Search contributors, companies, repos..." autocomplete="off">
        <select class="contrib-filter-select" id="apollo-filter">
            <option value="">All statuses</option>
            <option value="not_sent">Not sent to Apollo</option>
            <option value="sent">Sent to Apollo</option>
        </select>
        <button type="button" class="btn-fetch-contributors" id="btn-fetch" onclick="fetchContributors()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>Fetch from GitHub</span>
        </button>
    </div>

    <!-- Table -->
    <div class="contrib-table-container">
        <table class="contrib-table" id="contrib-table">
            <thead>
                <tr>
                    <th class="col-expand"></th>
                    <th class="col-num">#</th>
                    <th class="col-name sortable" data-col="1" data-dir="">Name <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-github sortable" data-col="4" data-dir="">GitHub <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-company sortable" data-col="2" data-dir="">Company <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-size sortable" data-col="3" data-dir="">Size <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-revenue sortable" data-col="5" data-dir="">Revenue <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-repo sortable" data-col="6" data-dir="desc">Repo Source <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-apollo sortable" data-col="7" data-dir="">Apollo <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-emails sortable" data-col="8" data-dir="">Emails <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-insight sortable" data-col="9" data-dir="">Insight / Hook <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                </tr>
            </thead>
            <tbody id="contrib-tbody">
                <!-- Populated via JS -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="contrib-pagination">
        <span class="page-info" id="contrib-page-info">Showing 0 contributors</span>
        <div class="contrib-page-buttons" id="contrib-page-buttons"></div>
    </div>

</div>

<!-- Toast -->
<div class="contrib-toast" id="contrib-toast"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // State
    let currentPage = 0;
    let pageLength = 50;
    let totalRecords = 0;
    let filteredRecords = 0;
    let currentSort = { col: 6, dir: 'desc' };
    let searchTimeout = null;
    let expandedRows = new Set();

    const tbody = document.getElementById('contrib-tbody');
    const searchInput = document.getElementById('contrib-search');
    const apolloFilter = document.getElementById('apollo-filter');

    // Load data
    function loadTable() {
        const params = new URLSearchParams({
            draw: 1,
            start: currentPage * pageLength,
            length: pageLength,
            'search[value]': searchInput.value.trim(),
            'order[0][column]': currentSort.col,
            'order[0][dir]': currentSort.dir
        });

        const apolloVal = apolloFilter.value;
        if (apolloVal) params.set('apollo_filter', apolloVal);

        fetch('/api/contributors/datatable?' + params.toString())
            .then(r => r.json())
            .then(data => {
                totalRecords = data.recordsTotal;
                filteredRecords = data.recordsFiltered;
                renderTable(data.data);
                renderPagination();
                updateStats();
            })
            .catch(err => {
                console.error('Failed to load contributors:', err);
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:3rem;color:var(--text-muted);">Failed to load contributors.</td></tr>';
            });
    }

    function renderTable(rows) {
        if (!rows || rows.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="11">
                    <div class="contrib-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3>No contributors yet</h3>
                        <p>Click "Fetch from GitHub" to pull top contributors from your monitored accounts' repositories.</p>
                    </div>
                </td></tr>`;
            return;
        }

        let html = '';
        const startIdx = currentPage * pageLength;

        rows.forEach((c, i) => {
            const rowNum = startIdx + i + 1;
            const isExpanded = expandedRows.has(c.id);
            const apolloClass = c.apollo_status === 'sent' ? 'sent' : 'not-sent';
            const apolloLabel = c.apollo_status === 'sent' ? 'Sent' : 'Not Sent';
            const apolloIcon = c.apollo_status === 'sent'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '';

            const ghUrl = c.github_url || ('https://github.com/' + c.github_login);
            const displayName = c.name || c.github_login;
            const escapedInsight = escapeHtml(c.insight || '');

            html += `
            <tr data-id="${c.id}" class="${isExpanded ? 'expanded' : ''}">
                <td class="col-expand">
                    <button class="expand-btn ${isExpanded ? 'open' : ''}" onclick="toggleRow(${c.id}, this)" title="Expand details">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </td>
                <td class="col-num">${rowNum}</td>
                <td class="col-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</td>
                <td class="col-github">
                    <a href="${escapeHtml(ghUrl)}" target="_blank" rel="noopener" class="github-link" title="${escapeHtml(c.github_login)}">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        ${escapeHtml(c.github_login)}
                    </a>
                </td>
                <td class="col-company" title="${escapeHtml(c.company || '')}">${escapeHtml(c.company || '-')}</td>
                <td class="col-size">${escapeHtml(c.company_size || '-')}</td>
                <td class="col-revenue">${escapeHtml(c.annual_revenue || '-')}</td>
                <td class="col-repo" title="${escapeHtml(c.repo_source || '')}">${escapeHtml(c.repo_source || '-')}</td>
                <td class="col-apollo">
                    <span class="apollo-badge ${apolloClass}">${apolloIcon} ${apolloLabel}</span>
                </td>
                <td class="col-emails" style="text-align:center;">${c.emails_sent || 0}</td>
                <td class="col-insight"><span class="insight-text" title="${escapedInsight}">${escapedInsight || '-'}</span></td>
            </tr>`;

            if (isExpanded) {
                html += buildDetailRow(c);
            }
        });

        tbody.innerHTML = html;
    }

    function buildDetailRow(c) {
        const ghUrl = c.github_url || ('https://github.com/' + c.github_login);
        const blogUrl = c.blog ? (c.blog.startsWith('http') ? c.blog : 'https://' + c.blog) : '';
        const email = c.email || '';
        const isEnrolled = c.apollo_status === 'sent' || c.enrolled_in_sequence === 1;

        return `
        <tr class="contrib-detail-row" data-detail-id="${c.id}">
            <td colspan="11">
                <div class="contrib-detail-content">
                    <div class="detail-info-grid">
                        <div class="detail-info-item">
                            <span class="label">Full Name</span>
                            <span class="value">${escapeHtml(c.name || c.github_login)}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Email</span>
                            <span class="value">${email ? '<a href="mailto:' + escapeHtml(email) + '">' + escapeHtml(email) + '</a>' : '<em style="color:var(--text-muted)">Not available</em>'}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">GitHub</span>
                            <span class="value"><a href="${escapeHtml(ghUrl)}" target="_blank" rel="noopener">${escapeHtml(c.github_login)}</a></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Blog / Website</span>
                            <span class="value">${blogUrl ? '<a href="' + escapeHtml(blogUrl) + '" target="_blank" rel="noopener">' + escapeHtml(c.blog) + '</a>' : '-'}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Company</span>
                            <span class="value">${escapeHtml(c.company || '-')}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Revenue</span>
                            <span class="value">${escapeHtml(c.annual_revenue || '-')}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Contributions</span>
                            <span class="value">${c.contributions || 0}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Sequence</span>
                            <span class="value">${c.sequence_name ? escapeHtml(c.sequence_name) : '<em style="color:var(--text-muted)">Not enrolled</em>'}</span>
                        </div>
                    </div>

                    <div>
                        <div class="detail-section-title">Send Outreach Email</div>
                        <div class="detail-email-form" id="email-form-${c.id}">
                            <input type="email" placeholder="Recipient email" value="${escapeHtml(email)}" id="email-to-${c.id}">
                            <input type="text" placeholder="Subject line" value="Quick question about ${escapeHtml(c.company || 'your work')}" id="email-subject-${c.id}">
                            <textarea placeholder="Write your email body here..." id="email-body-${c.id}"></textarea>
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button class="btn-send-email" onclick="sendEmail(${c.id})" ${!email ? 'disabled title="No email available"' : ''}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Send Email
                        </button>
                        <button class="btn-add-sequence ${isEnrolled ? 'enrolled' : ''}" onclick="toggleSequence(${c.id}, ${isEnrolled ? 'true' : 'false'})" id="seq-btn-${c.id}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                ${isEnrolled
                                    ? '<polyline points="20 6 9 17 4 12"></polyline>'
                                    : '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>'}
                            </svg>
                            ${isEnrolled ? 'Enrolled in Apollo' : 'Add to Sequence'}
                        </button>
                    </div>
                </div>
            </td>
        </tr>`;
    }

    // Toggle expand/collapse
    window.toggleRow = function(id, btn) {
        if (expandedRows.has(id)) {
            expandedRows.delete(id);
            btn.classList.remove('open');
            const detailRow = document.querySelector(`tr[data-detail-id="${id}"]`);
            if (detailRow) detailRow.remove();
            btn.closest('tr').classList.remove('expanded');
        } else {
            expandedRows.add(id);
            btn.classList.add('open');
            btn.closest('tr').classList.add('expanded');

            // Fetch fresh data for this contributor and insert detail row
            const mainRow = btn.closest('tr');
            const cid = mainRow.dataset.id;

            // Get data from current table state (rebuild from DOM or refetch)
            fetch('/api/contributors/datatable?search[value]=' + encodeURIComponent(searchInput.value) + '&start=0&length=10000')
                .then(r => r.json())
                .then(data => {
                    const c = data.data.find(x => x.id == cid);
                    if (c) {
                        const temp = document.createElement('tbody');
                        temp.innerHTML = buildDetailRow(c);
                        const detailTr = temp.firstElementChild;
                        mainRow.after(detailTr);
                    }
                });
        }
    };

    // Send email
    window.sendEmail = function(id) {
        const toInput = document.getElementById('email-to-' + id);
        const subjectInput = document.getElementById('email-subject-' + id);
        const bodyInput = document.getElementById('email-body-' + id);

        if (!toInput || !toInput.value.trim()) {
            showToast('Please enter a recipient email', 'error');
            return;
        }

        const btn = toInput.closest('.contrib-detail-content').querySelector('.btn-send-email');
        btn.disabled = true;
        btn.innerHTML = '<span class="fetch-spinner"></span> Sending...';

        fetch('/api/contributors/' + id + '/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                to_email: toInput.value.trim(),
                subject: subjectInput.value.trim(),
                body: bodyInput.value.trim()
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Email sent successfully', 'success');
                loadTable();
            } else {
                showToast(data.error || 'Failed to send email', 'error');
            }
        })
        .catch(() => showToast('Network error', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg> Send Email';
        });
    };

    // Toggle sequence enrollment
    window.toggleSequence = function(id, isCurrentlyEnrolled) {
        const newStatus = isCurrentlyEnrolled ? 'not_sent' : 'sent';
        const sequenceName = isCurrentlyEnrolled ? '' : 'Apollo Default Sequence';

        fetch('/api/contributors/' + id + '/apollo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus, sequence_name: sequenceName })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(isCurrentlyEnrolled ? 'Removed from sequence' : 'Added to Apollo sequence', 'success');
                loadTable();
            } else {
                showToast(data.error || 'Failed to update', 'error');
            }
        })
        .catch(() => showToast('Network error', 'error'));
    };

    // Fetch contributors from GitHub
    window.fetchContributors = function() {
        const btn = document.getElementById('btn-fetch');
        btn.disabled = true;
        btn.innerHTML = '<span class="fetch-spinner"></span> Fetching...';

        fetch('/api/contributors/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit: 5 })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                showToast(`Fetched ${data.contributors_saved} contributors from ${data.accounts_processed} accounts`, 'success');
                loadTable();
            } else {
                showToast('Failed to fetch contributors', 'error');
            }
        })
        .catch(() => showToast('Network error', 'error'))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> <span>Fetch from GitHub</span>';
        });
    };

    // Update stats
    function updateStats() {
        fetch('/api/contributors/stats')
            .then(r => r.json())
            .then(s => {
                document.getElementById('stat-total').textContent = s.total_contributors;
                document.getElementById('stat-enrolled').textContent = s.total_enrolled;
                document.getElementById('stat-emails').textContent = s.total_emails_sent;
            });
    }

    // Pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredRecords / pageLength) || 1;
        const start = currentPage * pageLength + 1;
        const end = Math.min((currentPage + 1) * pageLength, filteredRecords);

        document.getElementById('contrib-page-info').textContent =
            filteredRecords === 0
                ? 'No contributors found'
                : `Showing ${start}-${end} of ${filteredRecords} contributors`;

        const container = document.getElementById('contrib-page-buttons');
        let btnsHtml = '';

        btnsHtml += `<button class="contrib-page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>&laquo; Prev</button>`;

        const maxBtns = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxBtns / 2));
        let endPage = Math.min(totalPages, startPage + maxBtns);
        if (endPage - startPage < maxBtns) startPage = Math.max(0, endPage - maxBtns);

        for (let p = startPage; p < endPage; p++) {
            btnsHtml += `<button class="contrib-page-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p + 1}</button>`;
        }

        btnsHtml += `<button class="contrib-page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}'>Next &raquo;</button>`;

        container.innerHTML = btnsHtml;
    }

    window.goToPage = function(page) {
        const totalPages = Math.ceil(filteredRecords / pageLength) || 1;
        if (page < 0 || page >= totalPages) return;
        currentPage = page;
        loadTable();
    };

    // Sorting
    document.querySelectorAll('.contrib-table thead th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = parseInt(th.dataset.col);
            let dir = 'asc';
            if (currentSort.col === col && currentSort.dir === 'asc') dir = 'desc';
            currentSort = { col, dir };

            // Update visual indicators
            document.querySelectorAll('.contrib-table thead th.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');

            currentPage = 0;
            loadTable();
        });
    });

    // Search debounce
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 0;
            loadTable();
        }, 300);
    });

    // Apollo filter
    apolloFilter.addEventListener('change', () => {
        currentPage = 0;
        loadTable();
    });

    // Toast
    function showToast(msg, type) {
        const toast = document.getElementById('contrib-toast');
        toast.textContent = msg;
        toast.className = 'contrib-toast visible ' + (type || 'success');
        setTimeout(() => { toast.classList.remove('visible'); }, 3000);
    }

    // Escape HTML
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Keyboard shortcut: "/" to focus search
    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !e.defaultPrevented) {
            const target = e.target;
            if (target.isContentEditable || ['INPUT', 'TEXTAREA', 'SELECT'].includes(target.tagName)) return;
            e.preventDefault();
            searchInput.focus();
        }
    });

    // Initial load
    loadTable();
})();
</script>
{% endblock %}
