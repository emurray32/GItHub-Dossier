{% extends "base.html" %}

{% block title %}Contributors - Lead Machine{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{{ url_for('accounts') }}">
                <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Accounts
            </a>
        </li>
        <li class="breadcrumb-separator">/</li>
        <li class="breadcrumb-item active" aria-current="page">Contributors</li>
    </ol>
</nav>
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/contributors.css') }}">
{% endblock %}

{% block content %}
<div class="contributors-container">

    <!-- Stats Row (pills) -->
    <div class="contrib-stats-row">
        <span class="contrib-stat-pill"><span class="stat-pill-value" id="stat-total">{{ stats.total_contributors }}</span> <span class="stat-pill-label">contributors</span></span>
        <span class="contrib-stat-pill stat-enrolled"><span class="stat-pill-value" id="stat-enrolled">{{ stats.total_enrolled }}</span> <span class="stat-pill-label">enrolled</span></span>
        <span class="contrib-stat-pill stat-emails"><span class="stat-pill-value" id="stat-emails">{{ stats.total_emails_sent }}</span> <span class="stat-pill-label">emails sent</span></span>
    </div>

    <!-- Controls -->
    <div class="contrib-controls">
        <input type="text" class="contrib-search" id="contrib-search" placeholder="Search contributors, companies, repos..." autocomplete="off">
        <select class="contrib-filter-select" id="apollo-filter">
            <option value="">All statuses</option>
            <option value="not_sent">Not sent to Apollo</option>
            <option value="sent">Sent to Apollo</option>
        </select>
        <button type="button" class="btn-fetch-contributors" id="btn-fetch" onclick="fetchContributors()" data-tooltip="Pull contributor data from monitored GitHub repos">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M23 4v6h-6"></path>
                <path d="M1 20v-6h6"></path>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
            <span>Sync Contributors</span>
        </button>
    </div>

    <!-- Filter Chips -->
    <div class="contrib-filter-chips">
        <button class="filter-chip" id="filter-has-email" onclick="toggleFilter('has_email')">Has email</button>
        <button class="filter-chip" id="filter-warm-hot" onclick="toggleFilter('warm_hot')">Warm/Hot leads</button>
        <button class="filter-chip" id="filter-i18n" onclick="toggleFilter('i18n_involved')">i18n involved</button>
        <button class="filter-chip" id="filter-not-contacted" onclick="toggleFilter('not_contacted')">Not contacted</button>
    </div>

    <!-- Table -->
    <div class="contrib-table-container">
        <table class="contrib-table" id="contrib-table">
            <thead>
                <tr>
                    <th class="col-expand"></th>
                    <th class="col-priority">Priority</th>
                    <th class="col-name sortable" data-col="1" data-dir="">Name <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-github sortable" data-col="4" data-dir="">GitHub <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-company sortable" data-col="2" data-dir="">Company <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-size sortable" data-col="3" data-dir="">Size <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-revenue sortable" data-col="5" data-dir="">Revenue <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-repo sortable" data-col="6" data-dir="desc">Repo Source <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-apollo sortable" data-col="7" data-dir="">Apollo <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-emails sortable" data-col="8" data-dir="">Emails <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                    <th class="col-insight sortable" data-col="9" data-dir="">Insight / Hook <span class="sort-indicator"><span class="asc">&#9650;</span><span class="desc">&#9660;</span></span></th>
                </tr>
            </thead>
            <tbody id="contrib-tbody">
                <!-- Populated via JS -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="contrib-pagination">
        <span class="page-info" id="contrib-page-info">Showing 0 contributors</span>
        <div class="contrib-page-buttons" id="contrib-page-buttons"></div>
    </div>

</div>

<!-- Toast -->
<div class="contrib-toast" id="contrib-toast"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    // State
    let currentPage = 0;
    let pageLength = 50;
    let totalRecords = 0;
    let filteredRecords = 0;
    let currentSort = { col: 6, dir: 'desc' };
    let searchTimeout = null;
    let expandedRows = new Set();
    let activeFilters = {};

    const tbody = document.getElementById('contrib-tbody');
    const searchInput = document.getElementById('contrib-search');
    const apolloFilter = document.getElementById('apollo-filter');

    // Toggle filter chips
    window.toggleFilter = function(filterName) {
        if (activeFilters[filterName]) {
            delete activeFilters[filterName];
        } else {
            activeFilters[filterName] = '1';
        }
        // Update chip visuals
        const chipMap = { has_email: 'filter-has-email', warm_hot: 'filter-warm-hot', i18n_involved: 'filter-i18n', not_contacted: 'filter-not-contacted' };
        Object.entries(chipMap).forEach(([key, id]) => {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('active', !!activeFilters[key]);
        });
        currentPage = 0;
        loadTable();
    };

    // Load data
    function loadTable() {
        const params = new URLSearchParams({
            draw: 1,
            start: currentPage * pageLength,
            length: pageLength,
            'search[value]': searchInput.value.trim(),
            'order[0][column]': currentSort.col,
            'order[0][dir]': currentSort.dir
        });

        const apolloVal = apolloFilter.value;
        if (apolloVal) params.set('apollo_filter', apolloVal);

        // Add active filters
        Object.entries(activeFilters).forEach(([key, val]) => {
            params.set(key, val);
        });

        fetch('/api/contributors/datatable?' + params.toString())
            .then(r => r.json())
            .then(data => {
                totalRecords = data.recordsTotal;
                filteredRecords = data.recordsFiltered;
                renderTable(data.data);
                renderPagination();
                updateStats();
            })
            .catch(err => {
                console.error('Failed to load contributors:', err);
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:3rem;color:var(--text-muted);">Failed to load contributors.</td></tr>';
            });
    }

    function renderTable(rows) {
        if (!rows || rows.length === 0) {
            tbody.innerHTML = `
                <tr><td colspan="11">
                    <div class="contrib-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3>No contributors yet</h3>
                        <p>Click "Sync Contributors" to pull top contributors from your monitored accounts' repositories.</p>
                    </div>
                </td></tr>`;
            return;
        }

        let html = '';
        const startIdx = currentPage * pageLength;

        // Tier color classes
        const tierColors = { 0: '#94a3b8', 1: '#d97706', 2: '#16a34a', 3: '#dc2626', 4: '#64748b' };

        rows.forEach((c, i) => {
            const isExpanded = expandedRows.has(c.id);
            const apolloClass = c.apollo_status === 'sent' ? 'sent' : 'not-sent';
            const apolloLabel = c.apollo_status === 'sent' ? 'Sent' : 'Not Sent';
            const apolloIcon = c.apollo_status === 'sent'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                : '';

            const ghUrl = c.github_url || ('https://github.com/' + c.github_login);
            const displayName = c.name || c.github_login;
            const escapedInsight = escapeHtml(c.insight || '');
            const priorityScore = c.priority_score || 0;
            const tierName = c.company_tier_name || '';
            const tierNum = c.company_tier;
            const tierDot = tierNum !== null && tierNum !== undefined
                ? `<span class="tier-dot" style="background:${tierColors[tierNum] || '#94a3b8'}" title="${tierName}"></span>`
                : '';

            html += `
            <tr data-id="${c.id}" class="${isExpanded ? 'expanded' : ''}">
                <td class="col-expand">
                    <button class="expand-btn ${isExpanded ? 'open' : ''}" onclick="toggleRow(${c.id}, this)" title="Expand details">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </td>
                <td class="col-priority"><span class="priority-score">${priorityScore}</span></td>
                <td class="col-name" title="${escapeHtml(displayName)}">${escapeHtml(displayName)}</td>
                <td class="col-github">
                    <a href="${escapeHtml(ghUrl)}" target="_blank" rel="noopener" class="github-link" title="${escapeHtml(c.github_login)}">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        ${escapeHtml(c.github_login)}
                    </a>
                </td>
                <td class="col-company" title="${escapeHtml(c.company || '')}">${tierDot}${escapeHtml(c.company || '-')}</td>
                <td class="col-size">${escapeHtml(c.company_size || '-')}</td>
                <td class="col-revenue">${escapeHtml(c.annual_revenue || '-')}</td>
                <td class="col-repo" title="${escapeHtml(c.repo_source || '')}">${escapeHtml(c.repo_source || '-')}</td>
                <td class="col-apollo">
                    <span class="apollo-badge ${apolloClass}">${apolloIcon} ${apolloLabel}</span>
                </td>
                <td class="col-emails" style="text-align:center;">${c.emails_sent || 0}</td>
                <td class="col-insight"><span class="insight-text ${escapedInsight.length > 60 ? 'expandable' : ''}" onclick="this.classList.toggle('expanded')" title="${escapedInsight}">${escapedInsight || '-'}</span></td>
            </tr>`;

            if (isExpanded) {
                html += buildDetailRow(c);
            }
        });

        tbody.innerHTML = html;
    }

    function buildDetailRow(c) {
        const ghUrl = c.github_url || ('https://github.com/' + c.github_login);
        const blogUrl = c.blog ? (c.blog.startsWith('http') ? c.blog : 'https://' + c.blog) : '';
        const email = c.email || '';
        const isEnrolled = c.apollo_status === 'sent' || c.enrolled_in_sequence === 1;
        const hasEmail = !!email;

        // Parse AI-generated outreach copy from stored analysis
        let aiSubject = '';
        let aiBody = '';
        try {
            const ai = c.ai_analysis
                ? (typeof c.ai_analysis === 'string' ? JSON.parse(c.ai_analysis) : c.ai_analysis)
                : null;
            if (ai) { aiSubject = ai.subject || ''; aiBody = ai.body || ''; }
        } catch (e) {}

        return `
        <tr class="contrib-detail-row" data-detail-id="${c.id}">
            <td colspan="11">
                <div class="contrib-detail-content">
                    <div class="detail-info-grid">
                        <div class="detail-info-item">
                            <span class="label">Full Name</span>
                            <span class="value">${escapeHtml(c.name || c.github_login)}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Work Email</span>
                            <span class="value" id="detail-email-${c.id}">${email ? '<a href="mailto:' + escapeHtml(email) + '">' + escapeHtml(email) + '</a>' : '<em style="color:var(--color-text-tertiary)">Use Find Email to look up</em>'}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">GitHub</span>
                            <span class="value"><a href="${escapeHtml(ghUrl)}" target="_blank" rel="noopener">${escapeHtml(c.github_login)}</a></span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Blog / Website</span>
                            <span class="value">${blogUrl ? '<a href="' + escapeHtml(blogUrl) + '" target="_blank" rel="noopener">' + escapeHtml(c.blog) + '</a>' : '-'}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Company</span>
                            <span class="value">${escapeHtml(c.company || '-')}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Revenue</span>
                            <span class="value">${escapeHtml(c.annual_revenue || '-')}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Contributions</span>
                            <span class="value">${c.contributions || 0}</span>
                        </div>
                        <div class="detail-info-item">
                            <span class="label">Sequence</span>
                            <span class="value">${c.sequence_name ? escapeHtml(c.sequence_name) : '<em style="color:var(--color-text-tertiary)">Not enrolled</em>'}</span>
                        </div>
                    </div>

                    <div class="detail-outreach-section">
                        <div class="outreach-field">
                            <label class="outreach-label">Subject Line <span class="outreach-hint">(→ personalized_subject)</span></label>
                            <input type="text" id="email-subject-${c.id}" class="outreach-input"
                                   value="${escapeHtml(aiSubject)}"
                                   placeholder="AI-generated subject line...">
                        </div>
                        <div class="outreach-field">
                            <label class="outreach-label">Email Body <span class="outreach-hint">(→ personalized_email_1)</span></label>
                            <textarea id="email-body-${c.id}" class="outreach-textarea" rows="4"
                                      placeholder="AI-generated email body...">${escapeHtml(aiBody)}</textarea>
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button class="btn-find-email" onclick="findEmail(${c.id}, '${escapeHtml(c.github_login)}', '${escapeHtml(c.name || '')}', '${escapeHtml(c.company || '')}')" id="find-email-btn-${c.id}" ${hasEmail ? 'disabled' : ''}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                            ${hasEmail ? 'Email found' : 'Find Email'}
                        </button>
                        <button class="btn-add-sequence ${isEnrolled ? 'enrolled' : ''}" onclick="toggleSequence(${c.id}, ${isEnrolled ? 'true' : 'false'})" id="seq-btn-${c.id}" ${!hasEmail && !isEnrolled ? 'disabled' : ''}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                ${isEnrolled
                                    ? '<polyline points="20 6 9 17 4 12"></polyline>'
                                    : '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>'}
                            </svg>
                            ${isEnrolled ? 'Enrolled in Apollo' : 'Add to Sequence'}
                        </button>
                    </div>
                </div>
            </td>
        </tr>`;
    }

    // Toggle expand/collapse
    window.toggleRow = function(id, btn) {
        if (expandedRows.has(id)) {
            expandedRows.delete(id);
            btn.classList.remove('open');
            const detailRow = document.querySelector(`tr[data-detail-id="${id}"]`);
            if (detailRow) detailRow.remove();
            btn.closest('tr').classList.remove('expanded');
        } else {
            expandedRows.add(id);
            btn.classList.add('open');
            btn.closest('tr').classList.add('expanded');

            // Fetch fresh data for this contributor and insert detail row
            const mainRow = btn.closest('tr');
            const cid = mainRow.dataset.id;

            // Get data from current table state (rebuild from DOM or refetch)
            fetch('/api/contributors/datatable?search[value]=' + encodeURIComponent(searchInput.value) + '&start=0&length=10000')
                .then(r => r.json())
                .then(data => {
                    const c = data.data.find(x => x.id == cid);
                    if (c) {
                        const temp = document.createElement('tbody');
                        temp.innerHTML = buildDetailRow(c);
                        const detailTr = temp.firstElementChild;
                        mainRow.after(detailTr);
                    }
                });
        }
    };

    // Find email via Apollo lookup
    window.findEmail = function(id, githubLogin, name, company) {
        const btn = document.getElementById('find-email-btn-' + id);
        if (!btn) return;
        btn.disabled = true;
        btn.innerHTML = '<span class="fetch-spinner"></span> Looking up...';

        fetch('/api/apollo-lookup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contributor_id: id,
                github_login: githubLogin,
                name: name,
                company: company
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.email) {
                // Update the email display in detail row
                const emailEl = document.getElementById('detail-email-' + id);
                if (emailEl) {
                    emailEl.innerHTML = '<a href="mailto:' + escapeHtml(data.email) + '">' + escapeHtml(data.email) + '</a>';
                }
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Email found';
                btn.disabled = true;

                // Enable "Add to Sequence" button
                const seqBtn = document.getElementById('seq-btn-' + id);
                if (seqBtn) seqBtn.disabled = false;

                showToast('Found email: ' + data.email, 'success');
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Not found';
                btn.disabled = false;
                showToast(data.error || 'No email found via Apollo', 'error');
            }
        })
        .catch(() => {
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg> Find Email';
            btn.disabled = false;
            showToast('Network error during lookup', 'error');
        });
    };

    // Toggle sequence enrollment
    window.toggleSequence = function(id, isCurrentlyEnrolled) {
        if (isCurrentlyEnrolled) {
            // Disenroll: just update DB status
            fetch('/api/contributors/' + id + '/apollo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'not_sent', sequence_name: '' })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Removed from sequence', 'success');
                    loadTable();
                } else {
                    showToast(data.error || 'Failed to update', 'error');
                }
            })
            .catch(() => showToast('Network error', 'error'));
            return;
        }

        // Enroll: fetch sequences then show inline picker
        const seqBtn = document.getElementById('seq-btn-' + id);
        const existingPicker = document.getElementById('seq-picker-' + id);
        if (existingPicker) { existingPicker.remove(); return; }

        if (seqBtn) {
            seqBtn.disabled = true;
            seqBtn.innerHTML = '<span class="fetch-spinner"></span> Loading...';
        }

        fetch('/api/apollo/sequences')
            .then(r => r.json())
            .then(data => {
                if (seqBtn) {
                    seqBtn.disabled = false;
                    seqBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add to Sequence';
                }
                const sequences = data.sequences || [];
                if (!sequences.length) {
                    showToast('No sequences found in Apollo', 'error');
                    return;
                }

                const picker = document.createElement('div');
                picker.id = 'seq-picker-' + id;
                picker.className = 'seq-picker-panel';
                picker.innerHTML = `
                    <div class="seq-picker-label">Choose Sequence</div>
                    <select class="seq-picker-select" id="seq-select-${id}">
                        ${sequences.map(s => `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`).join('')}
                    </select>
                    <div class="seq-picker-actions">
                        <button class="btn-confirm-enroll" onclick="confirmEnroll(${id})">Enroll</button>
                        <button class="btn-cancel-enroll" onclick="document.getElementById('seq-picker-${id}').remove()">Cancel</button>
                    </div>
                `;
                if (seqBtn) seqBtn.after(picker);
            })
            .catch(() => {
                if (seqBtn) {
                    seqBtn.disabled = false;
                    seqBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add to Sequence';
                }
                showToast('Failed to load sequences', 'error');
            });
    };

    window.confirmEnroll = async function(id) {
        const seqSelect = document.getElementById('seq-select-' + id);
        if (!seqSelect) return;
        const sequenceId = seqSelect.value;
        const sequenceName = seqSelect.options[seqSelect.selectedIndex].text;

        const subjectEl = document.getElementById('email-subject-' + id);
        const bodyEl = document.getElementById('email-body-' + id);
        const subject = subjectEl ? subjectEl.value.trim() : '';
        const body = bodyEl ? bodyEl.value.trim() : '';

        const picker = document.getElementById('seq-picker-' + id);
        if (picker) picker.innerHTML = '<span class="fetch-spinner"></span> Enrolling...';

        try {
            // Fetch contributor data for email/name
            const dtResp = await fetch('/api/contributors/datatable?start=0&length=10000');
            const dtData = await dtResp.json();
            const contributor = dtData.data.find(x => x.id == id);
            if (!contributor) { if (picker) picker.remove(); showToast('Contributor not found', 'error'); return; }

            // Step 1: Create/update Apollo contact + inject custom fields
            const enrollResp = await fetch('/api/apollo/enroll-sequence', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: contributor.email,
                    first_name: (contributor.name || '').split(' ')[0] || contributor.github_login,
                    last_name: (contributor.name || '').split(' ').slice(1).join(' '),
                    sequence_id: sequenceId,
                    company_name: contributor.company || '',
                    personalized_subject: subject,
                    personalized_email_body: body
                })
            });
            const enrollData = await enrollResp.json();

            if (enrollData.status === 'success') {
                // Step 2: Record enrollment in local DB
                await fetch('/api/contributors/' + id + '/apollo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'sent', sequence_name: sequenceName })
                });
                if (picker) picker.remove();
                showToast('Enrolled in ' + sequenceName, 'success');
                loadTable();
            } else {
                if (picker) picker.remove();
                showToast(enrollData.message || 'Failed to enroll', 'error');
            }
        } catch (e) {
            if (picker) picker.remove();
            showToast('Network error during enrollment', 'error');
        }
    };

    // Fetch contributors from GitHub
    let fetchAbortController = null;

    window.fetchContributors = function() {
        const btn = document.getElementById('btn-fetch');
        const controlsRow = btn.closest('.contrib-controls');

        // Create progress UI
        let progressEl = document.getElementById('fetch-progress');
        if (!progressEl) {
            progressEl = document.createElement('div');
            progressEl.id = 'fetch-progress';
            progressEl.className = 'fetch-progress-bar';
            controlsRow.after(progressEl);
        }

        btn.disabled = true;
        fetchAbortController = new AbortController();

        // Show progress UI
        progressEl.style.display = 'block';
        progressEl.innerHTML = `
            <div class="fetch-progress-inner">
                <div class="fetch-progress-track"><div class="fetch-progress-fill" id="fetch-progress-fill"></div></div>
                <span class="fetch-progress-text" id="fetch-progress-text">Connecting to GitHub...</span>
                <button class="fetch-cancel-btn" id="fetch-cancel-btn" type="button">Cancel</button>
            </div>
        `;
        btn.innerHTML = '<span class="fetch-spinner"></span> Fetching...';

        document.getElementById('fetch-cancel-btn').onclick = function() {
            if (fetchAbortController) fetchAbortController.abort();
            resetFetchUI('Cancelled');
            showToast('Fetch cancelled', 'info');
        };

        // Simulate progress while waiting
        const progressFill = document.getElementById('fetch-progress-fill');
        const progressText = document.getElementById('fetch-progress-text');
        let elapsed = 0;
        const progressMessages = [
            'Connecting to GitHub...',
            'Scanning repositories...',
            'Discovering contributors...',
            'Processing contributor profiles...',
            'Saving contributor data...'
        ];
        const progressInterval = setInterval(() => {
            elapsed += 1;
            const pct = Math.min(90, elapsed * 3);
            if (progressFill) progressFill.style.width = pct + '%';
            const msgIdx = Math.min(Math.floor(elapsed / 8), progressMessages.length - 1);
            if (progressText) progressText.textContent = progressMessages[msgIdx] + ` (${elapsed}s)`;
        }, 1000);

        fetch('/api/contributors/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ limit: 5 }),
            signal: fetchAbortController.signal
        })
        .then(r => r.json())
        .then(data => {
            clearInterval(progressInterval);
            if (data.status === 'success') {
                if (progressFill) progressFill.style.width = '100%';
                if (progressText) progressText.textContent = `Done! Found ${data.contributors_saved} contributors from ${data.accounts_processed} accounts.`;
                showToast(`Fetched ${data.contributors_saved} contributors from ${data.accounts_processed} accounts`, 'success');
                loadTable();
                setTimeout(() => resetFetchUI(), 3000);
            } else {
                resetFetchUI('Failed');
                showToast('Failed to fetch contributors', 'error');
            }
        })
        .catch(err => {
            clearInterval(progressInterval);
            if (err.name === 'AbortError') return;
            resetFetchUI('Error');
            showToast('Network error', 'error');
        });

        function resetFetchUI(label) {
            clearInterval(progressInterval);
            const pe = document.getElementById('fetch-progress');
            if (pe) pe.style.display = 'none';
            btn.disabled = false;
            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg> <span>Sync Contributors</span>';
            fetchAbortController = null;
        }
    };

    // Update stats
    function updateStats() {
        fetch('/api/contributors/stats')
            .then(r => r.json())
            .then(s => {
                document.getElementById('stat-total').textContent = s.total_contributors;
                document.getElementById('stat-enrolled').textContent = s.total_enrolled;
                document.getElementById('stat-emails').textContent = s.total_emails_sent;
            });
    }

    // Pagination
    function renderPagination() {
        const totalPages = Math.ceil(filteredRecords / pageLength) || 1;
        const start = currentPage * pageLength + 1;
        const end = Math.min((currentPage + 1) * pageLength, filteredRecords);

        document.getElementById('contrib-page-info').textContent =
            filteredRecords === 0
                ? 'No contributors found'
                : `Showing ${start}-${end} of ${filteredRecords} contributors`;

        const container = document.getElementById('contrib-page-buttons');
        let btnsHtml = '';

        btnsHtml += `<button class="contrib-page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}>&laquo; Prev</button>`;

        const maxBtns = 5;
        let startPage = Math.max(0, currentPage - Math.floor(maxBtns / 2));
        let endPage = Math.min(totalPages, startPage + maxBtns);
        if (endPage - startPage < maxBtns) startPage = Math.max(0, endPage - maxBtns);

        for (let p = startPage; p < endPage; p++) {
            btnsHtml += `<button class="contrib-page-btn ${p === currentPage ? 'active' : ''}" onclick="goToPage(${p})">${p + 1}</button>`;
        }

        btnsHtml += `<button class="contrib-page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage >= totalPages - 1 ? 'disabled' : ''}>Next &raquo;</button>`;

        container.innerHTML = btnsHtml;
    }

    window.goToPage = function(page) {
        const totalPages = Math.ceil(filteredRecords / pageLength) || 1;
        if (page < 0 || page >= totalPages) return;
        currentPage = page;
        loadTable();
    };

    // Sorting
    document.querySelectorAll('.contrib-table thead th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const col = parseInt(th.dataset.col);
            let dir = 'asc';
            if (currentSort.col === col && currentSort.dir === 'asc') dir = 'desc';
            currentSort = { col, dir };

            // Update visual indicators
            document.querySelectorAll('.contrib-table thead th.sortable').forEach(h => {
                h.classList.remove('sort-asc', 'sort-desc');
            });
            th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');

            currentPage = 0;
            loadTable();
        });
    });

    // Search debounce
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            currentPage = 0;
            loadTable();
        }, 300);
    });

    // Apollo filter
    apolloFilter.addEventListener('change', () => {
        currentPage = 0;
        loadTable();
    });

    // Toast
    function showToast(msg, type) {
        const toast = document.getElementById('contrib-toast');
        toast.textContent = msg;
        toast.className = 'contrib-toast visible ' + (type || 'success');
        setTimeout(() => { toast.classList.remove('visible'); }, 3000);
    }

    // Escape HTML
    function escapeHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Keyboard shortcut: "/" to focus search
    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !e.defaultPrevented) {
            const target = e.target;
            if (target.isContentEditable || ['INPUT', 'TEXTAREA', 'SELECT'].includes(target.tagName)) return;
            e.preventDefault();
            searchInput.focus();
        }
    });

    // Initial load
    loadTable();
})();
</script>
{% endblock %}
