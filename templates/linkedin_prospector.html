{% extends "base.html" %}
{% block title %}LinkedIn Prospector - Lead Machine{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{{ url_for('accounts') }}">
      <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>Accounts</a></li>
    <li class="breadcrumb-separator">/</li>
    <li class="breadcrumb-item active" aria-current="page">LinkedIn Prospector</li>
  </ol>
</nav>
{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/linkedin_prospector.css') }}">
{% endblock %}
{% block content %}
<div class="lp-container">

  <div class="lp-header">
    <h1>LinkedIn Prospector</h1>
    <p>Drop in a LinkedIn profile screenshot — we extract the contact, find their email in Apollo, and generate a personalized sequence email ready to send.</p>
  </div>

  <!-- 1. Upload zone -->
  <div class="lp-upload-zone" id="upload-zone">
    <input type="file" id="file-input" accept="image/*">
    <svg class="lp-upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
      <polyline points="21 15 16 10 5 21"/>
    </svg>
    <h3 id="upload-title">Drop a LinkedIn screenshot here</h3>
    <p id="upload-sub">PNG or JPG — the full profile page works best</p>
    <button class="lp-upload-btn" id="upload-btn" onclick="document.getElementById('file-input').click()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      Choose file
    </button>
    <img id="preview-img" class="lp-preview-img" style="display:none" alt="LinkedIn screenshot preview">
  </div>

  <!-- 2. Processing indicator -->
  <div class="lp-section lp-section--hidden" id="section-status">
    <ul class="lp-status-list">
      <li class="lp-status-item" id="status-extract">
        <span class="lp-status-icon" id="status-extract-icon"><span class="lp-spinner"></span></span>
        <span>Extracting contact from screenshot...</span>
      </li>
      <li class="lp-status-item" id="status-apollo">
        <span class="lp-status-icon" id="status-apollo-icon"></span>
        <span>Searching Apollo for email...</span>
      </li>
    </ul>
  </div>

  <!-- 3. Contact card (merged extracted + Apollo) -->
  <div class="lp-section lp-section--hidden" id="section-contact">
    <div class="lp-card">
      <div class="lp-card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Contact
        <span class="lp-badge" id="apollo-badge" style="display:none"></span>
      </div>
      <div class="lp-fields-row">
        <div class="lp-field"><label>Full Name</label><input class="lp-value" id="f-name" type="text" placeholder="—"></div>
        <div class="lp-field"><label>Company</label><input class="lp-value" id="f-company" type="text" placeholder="—"></div>
      </div>
      <div class="lp-field"><label>Job Title</label><input class="lp-value" id="f-title" type="text" placeholder="—"></div>
      <div class="lp-fields-row">
        <div class="lp-field"><label>Location</label><input class="lp-value" id="f-location" type="text" placeholder="—"></div>
        <div class="lp-field"><label>Phone</label><input class="lp-value" id="f-phone" type="text" placeholder="—"></div>
      </div>
      <div class="lp-field"><label>Headline</label><input class="lp-value" id="f-headline" type="text" placeholder="—"></div>
      <div class="lp-field"><label>Email</label><input class="lp-value" id="f-email" type="email" placeholder="Enter email if not found in Apollo"></div>
    </div>
  </div>

  <!-- 4. Sequence & Email -->
  <div class="lp-section lp-section--hidden" id="section-email">
    <div class="lp-card">
      <div class="lp-card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Sequence &amp; Email
      </div>
      <div class="lp-field">
        <label>Apollo Sequence</label>
        <select class="lp-select" id="sequence-select">
          <option value="">Loading sequences...</option>
        </select>
      </div>
      <div class="lp-actions">
        <button class="lp-btn lp-btn-primary" id="btn-gen-email" onclick="generateEmail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
          Generate Email with AI
        </button>
      </div>

      <!-- Email preview (hidden until generated) -->
      <div id="email-preview-wrap" style="display:none">
        <hr style="border:none;border-top:1px solid var(--color-border);margin:1.25rem 0">
        <div class="lp-field">
          <label>Subject</label>
          <input class="lp-value" id="email-subject" type="text" placeholder="(generated by AI)">
        </div>
        <div class="lp-field">
          <label>Body</label>
          <div class="lp-email-preview" id="email-body-preview"></div>
        </div>
        <div class="lp-actions">
          <button class="lp-btn lp-btn-secondary" id="btn-copy" onclick="copyEmail()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            Copy
          </button>
          <button class="lp-btn lp-btn-secondary" onclick="generateEmail()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Regenerate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 5. Enroll -->
  <div class="lp-section lp-section--hidden" id="section-enroll">
    <div id="enroll-action">
      <button class="lp-btn lp-btn-primary" id="btn-enroll" onclick="enrollContact()" style="width:100%;justify-content:center;padding:0.75rem">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        Enroll in Sequence
      </button>
    </div>
    <div id="enroll-success" style="display:none">
      <div class="lp-success-card">
        <svg class="lp-success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <h3>Enrolled!</h3>
        <p id="enroll-success-msg"></p>
      </div>
    </div>
  </div>

  <!-- 6. Start over -->
  <div class="lp-section lp-section--hidden" id="section-reset">
    <div class="lp-start-over">
      <a href="#" onclick="resetAll(); return false;">Start over with a new screenshot</a>
    </div>
  </div>

</div>

<div class="lp-toast" id="lp-toast"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // ── State ──────────────────────────────────────────────────────────────
  let extractedContact = null;
  let apolloContact = null;
  let uploadedFile = null;
  let sequences = [];

  // ── Helpers ────────────────────────────────────────────────────────────
  function $(id) { return document.getElementById(id); }

  function showSection(id) {
    const el = $(id);
    el.classList.remove('lp-section--hidden');
    el.classList.add('lp-section--visible');
    setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }), 80);
  }

  function hideSection(id) {
    const el = $(id);
    el.classList.remove('lp-section--visible');
    el.classList.add('lp-section--hidden');
  }

  function showToast(msg, type) {
    type = type || 'success';
    var t = $('lp-toast');
    t.textContent = msg;
    t.className = 'lp-toast visible ' + type;
    setTimeout(function() { t.className = 'lp-toast'; }, 3000);
  }

  function escH(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  var SVG_SPINNER = '<span class="lp-spinner"></span>';
  var SVG_CHECK = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
  var SVG_X = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';

  function setStatus(id, state) {
    var item = $(id);
    var icon = $(id + '-icon');
    item.className = 'lp-status-item ' + state;
    if (state === 'active') icon.innerHTML = SVG_SPINNER;
    else if (state === 'done') icon.innerHTML = SVG_CHECK;
    else if (state === 'error') icon.innerHTML = SVG_X;
    else icon.innerHTML = '';
  }

  // ── Upload & drag/drop ─────────────────────────────────────────────────
  var zone = $('upload-zone');
  var fileInput = $('file-input');

  zone.addEventListener('dragover', function(e) { e.preventDefault(); zone.classList.add('drag-over'); });
  zone.addEventListener('dragleave', function() { zone.classList.remove('drag-over'); });
  zone.addEventListener('drop', function(e) {
    e.preventDefault();
    zone.classList.remove('drag-over');
    var file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleFile(file);
  });
  fileInput.addEventListener('change', function() {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });

  function handleFile(file) {
    uploadedFile = file;
    var reader = new FileReader();
    reader.onload = function(e) {
      var img = $('preview-img');
      img.src = e.target.result;
      img.style.display = 'block';
      $('upload-title').textContent = file.name;
      $('upload-sub').textContent = 'Click to change screenshot';
    };
    reader.readAsDataURL(file);

    // Reset downstream sections
    hideSection('section-contact');
    hideSection('section-email');
    hideSection('section-enroll');
    hideSection('section-reset');
    $('email-preview-wrap').style.display = 'none';
    $('enroll-action').style.display = '';
    $('enroll-success').style.display = 'none';

    // Show status & start auto-chain
    setStatus('status-extract', 'active');
    setStatus('status-apollo', '');
    showSection('section-status');
    extractContact();
  }

  // ── Extract via AI ─────────────────────────────────────────────────────
  async function extractContact() {
    var formData = new FormData();
    formData.append('image', uploadedFile);

    try {
      var resp = await fetch('/api/linkedin/extract', { method: 'POST', body: formData });
      var data = await resp.json();
      // BUG FIX: backend returns { data: {...} } not { contact: {...} }
      if (data.status === 'success' && data.data) {
        extractedContact = data.data;
        setStatus('status-extract', 'done');

        // Populate fields
        $('f-name').value     = data.data.name || '';
        $('f-title').value    = data.data.title || '';
        $('f-company').value  = data.data.company || '';
        $('f-location').value = data.data.location || '';
        $('f-headline').value = data.data.headline || '';

        // Auto-trigger Apollo search
        findInApollo();
      } else {
        setStatus('status-extract', 'error');
        showToast(data.message || 'Could not extract contact info', 'error');
      }
    } catch(e) {
      setStatus('status-extract', 'error');
      showToast('Extraction failed — check your connection', 'error');
    }
  }

  // ── Find in Apollo (auto-triggered) ────────────────────────────────────
  window.findInApollo = async function() {
    setStatus('status-apollo', 'active');

    var payload = {
      name: $('f-name').value,
      company: $('f-company').value,
      title: $('f-title').value
    };

    try {
      var resp = await fetch('/api/linkedin/find-contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      var data = await resp.json();
      var badge = $('apollo-badge');

      if (data.status === 'success' && data.contact) {
        apolloContact = data.contact;
        setStatus('status-apollo', 'done');

        // Badge
        badge.style.display = '';
        badge.className = 'lp-badge found';
        badge.innerHTML = SVG_CHECK + ' Found';

        // Fill email + phone from Apollo
        var email = data.contact.email || '';
        $('f-email').value = email;
        $('f-phone').value = data.contact.phone_number || data.contact.sanitized_phone || '';

        if (!email) {
          showToast('Found in Apollo but no email — enter one manually', 'error');
        }
      } else {
        setStatus('status-apollo', 'done');
        badge.style.display = '';
        badge.className = 'lp-badge not-found';
        badge.textContent = 'Not found';
        showToast('Not found in Apollo — enter email manually to continue', 'error');
      }

      // Reveal contact card + email section regardless
      showSection('section-contact');
      setTimeout(function() { showSection('section-email'); }, 200);
      setTimeout(function() { showSection('section-reset'); }, 350);
    } catch(e) {
      setStatus('status-apollo', 'error');
      showToast('Apollo search failed', 'error');
      // Still show contact card so user can enter email manually
      showSection('section-contact');
      setTimeout(function() { showSection('section-email'); }, 200);
      setTimeout(function() { showSection('section-reset'); }, 350);
    }
  };

  // ── Generate email via AI ──────────────────────────────────────────────
  window.generateEmail = async function() {
    var btn = $('btn-gen-email');
    btn.disabled = true;
    btn.innerHTML = '<span class="lp-spinner lp-spinner--white"></span> Generating...';

    var contact = {
      name: $('f-name').value,
      title: $('f-title').value,
      company: $('f-company').value,
      location: $('f-location').value,
      headline: $('f-headline').value,
      email: $('f-email').value
    };

    try {
      var resp = await fetch('/api/linkedin/generate-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact: contact })
      });
      var data = await resp.json();

      // BUG FIX: backend returns { email: { subject, body } } not { subject, body }
      if (data.status === 'success' && data.email) {
        $('email-subject').value = data.email.subject || '';
        $('email-body-preview').className = 'lp-email-preview';
        $('email-body-preview').textContent = data.email.body || '';
        $('email-preview-wrap').style.display = '';
        showSection('section-enroll');
        showToast('Email generated');
        $('email-preview-wrap').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        showToast(data.message || 'Email generation failed', 'error');
      }
    } catch(e) {
      showToast('Network error generating email', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg> Generate Email with AI';
    }
  };

  // ── Enroll in Apollo sequence ──────────────────────────────────────────
  window.enrollContact = async function() {
    var email = ($('f-email').value || '').trim();
    if (!email) { showToast('No email address — cannot enroll', 'error'); return; }

    var seqId = $('sequence-select').value;
    var seqName = $('sequence-select').selectedOptions[0] ? $('sequence-select').selectedOptions[0].text : '';
    if (!seqId) { showToast('Please select a sequence', 'error'); return; }

    var btn = $('btn-enroll');
    btn.disabled = true;
    btn.innerHTML = '<span class="lp-spinner lp-spinner--white"></span> Enrolling...';

    var nameParts = ($('f-name').value || '').trim().split(' ');
    var payload = {
      email: email,
      first_name: nameParts[0] || '',
      last_name: nameParts.slice(1).join(' ') || '',
      sequence_id: seqId,
      company_name: $('f-company').value || '',
      personalized_subject: $('email-subject').value || '',
      // BUG FIX: backend reads 'personalized_email_body', not 'personalized_email_1'
      personalized_email_body: $('email-body-preview').textContent || ''
    };

    try {
      var resp = await fetch('/api/apollo/enroll-sequence', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      var data = await resp.json();

      if (data.status === 'success') {
        $('enroll-action').style.display = 'none';
        $('enroll-success').style.display = '';
        $('enroll-success-msg').textContent = email + ' enrolled in "' + seqName + '"';
        showToast(email + ' enrolled successfully');
        $('enroll-success').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';
        showToast(data.message || 'Enrollment failed', 'error');
      }
    } catch(e) {
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';
      showToast('Network error', 'error');
    }
  };

  // ── Copy email ─────────────────────────────────────────────────────────
  window.copyEmail = function() {
    var subj = $('email-subject').value;
    var body = $('email-body-preview').textContent;
    navigator.clipboard.writeText('Subject: ' + subj + '\n\n' + body)
      .then(function() { showToast('Copied to clipboard'); })
      .catch(function() { showToast('Copy failed', 'error'); });
  };

  // ── Reset everything ──────────────────────────────────────────────────
  window.resetAll = function() {
    // Clear state
    extractedContact = null;
    apolloContact = null;
    uploadedFile = null;

    // Reset upload zone
    $('file-input').value = '';
    $('preview-img').style.display = 'none';
    $('preview-img').src = '';
    $('upload-title').textContent = 'Drop a LinkedIn screenshot here';
    $('upload-sub').textContent = 'PNG or JPG — the full profile page works best';
    $('upload-btn').disabled = false;

    // Reset fields
    $('f-name').value = '';
    $('f-title').value = '';
    $('f-company').value = '';
    $('f-location').value = '';
    $('f-headline').value = '';
    $('f-phone').value = '';
    $('f-email').value = '';
    $('email-subject').value = '';
    $('email-body-preview').textContent = '';
    $('email-preview-wrap').style.display = 'none';

    // Reset enroll
    $('enroll-action').style.display = '';
    $('enroll-success').style.display = 'none';
    var enrollBtn = $('btn-enroll');
    enrollBtn.disabled = false;
    enrollBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';

    // Reset badge
    $('apollo-badge').style.display = 'none';

    // Hide all sections
    hideSection('section-status');
    hideSection('section-contact');
    hideSection('section-email');
    hideSection('section-enroll');
    hideSection('section-reset');

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // ── Load sequences on page init ────────────────────────────────────────
  async function loadSequences() {
    var sel = $('sequence-select');
    try {
      var resp = await fetch('/api/apollo/sequences');
      var data = await resp.json();
      if (data.status === 'success' && data.sequences && data.sequences.length) {
        sequences = data.sequences;
        sel.innerHTML = data.sequences.map(function(s) {
          return '<option value="' + escH(s.id) + '">' + escH(s.name) + (s.active ? '' : ' (inactive)') + '</option>';
        }).join('');
      } else {
        sel.innerHTML = '<option value="">No sequences found</option>';
      }
    } catch(e) {
      sel.innerHTML = '<option value="">Could not load sequences</option>';
    }
  }

  loadSequences();
})();
</script>
{% endblock %}
