{% extends "base.html" %}
{% block title %}LinkedIn Prospector - Lead Machine{% endblock %}
{% block page_title %}LinkedIn Prospector{% endblock %}
{% block breadcrumb %}
<nav class="breadcrumb-container" aria-label="Breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item active" aria-current="page">
      <svg class="breadcrumb-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>LinkedIn Prospector</li>
  </ol>
</nav>
{% endblock %}
{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/linkedin_prospector.css') }}">
{% endblock %}
{% block content %}
<div class="lp-container">

  <div class="lp-header">
    <h1>LinkedIn Prospector</h1>
    <p>Upload a LinkedIn profile screenshot or paste a URL to generate prospect intelligence.</p>
  </div>

  <!-- 1. Upload zone -->
  <div class="lp-input-zone" id="input-zone">
    <div class="lp-upload-zone" id="upload-zone">
      <input type="file" id="file-input" accept="image/*" tabindex="-1">
      <span class="sr-only" id="upload-instructions">Drop a LinkedIn profile screenshot here. PNG or JPG. The full profile page works best.</span>

      <!-- Collapsed state icon -->
      <svg class="lp-collapsed-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>

      <!-- Empty state -->
      <div class="lp-upload-empty" id="upload-empty">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="48" height="48" class="lp-upload-illustration" aria-hidden="true">
          <!-- Down arrow -->
          <path d="M32 4v16M24 14l8 8 8-8" stroke="currentColor" stroke-opacity="0.35" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          <!-- Image frame -->
          <rect x="10" y="28" width="44" height="32" rx="4" fill="currentColor" fill-opacity="0.03" stroke="currentColor" stroke-opacity="0.18" stroke-width="1.5"/>
          <!-- Sun -->
          <circle cx="22" cy="38" r="4" fill="currentColor" fill-opacity="0.07" stroke="currentColor" stroke-opacity="0.18" stroke-width="1.5"/>
          <!-- Mountain -->
          <path d="M10 56l14-14 8 8 8-10 14 16" stroke="currentColor" stroke-opacity="0.18" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="currentColor" fill-opacity="0.03"/>
        </svg>
        <span class="lp-upload-hint" id="upload-hint">Drop a LinkedIn profile screenshot here</span>
        <button class="lp-upload-btn" id="upload-btn" onclick="document.getElementById('file-input').click()" aria-describedby="upload-instructions">Browse</button>
      </div>

      <!-- Filled state (filename bar) -->
      <div class="lp-upload-filled" id="upload-filled" hidden>
        <div class="lp-upload-file-info">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span class="lp-upload-filename" id="upload-filename"></span>
        </div>
        <button type="button" class="lp-upload-clear-btn" id="clear-file-btn" aria-label="Remove selected file">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>

      <h3 id="upload-title" style="display:none">Drop a LinkedIn screenshot here</h3>
      <p id="upload-sub" style="display:none">PNG or JPG</p>
      <img id="preview-img" class="lp-preview-img" style="display:none" alt="LinkedIn screenshot preview">
    </div>

    <div class="lp-url-divider">or</div>

    <div class="lp-url-row">
      <input type="text" class="lp-url-input" id="url-input" placeholder="Paste a LinkedIn profile URL..." autocomplete="off" spellcheck="false">
      <button class="lp-url-btn" id="url-btn" onclick="handleUrlLookup()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Look up
      </button>
    </div>
  </div>

  <!-- Back button (visible when input zone is collapsed) -->
  <div id="back-bar" style="display:none">
    <a href="#" class="lp-back-link" onclick="resetAll(); return false;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="15 18 9 12 15 6"/></svg>
      New lookup
    </a>
  </div>

  <!-- 2. Processing indicator -->
  <div class="lp-section lp-section--hidden" id="section-status">
    <ul class="lp-status-list">
      <li class="lp-status-item" id="status-extract">
        <span class="lp-status-icon" id="status-extract-icon"><span class="lp-spinner"></span></span>
        <span id="status-extract-text">Extracting contact from screenshot...</span>
      </li>
      <li class="lp-status-item" id="status-apollo">
        <span class="lp-status-icon" id="status-apollo-icon"></span>
        <span id="status-apollo-text">Searching Apollo for email...</span>
      </li>
    </ul>
  </div>

  <!-- 3. Profile card (replaces old flat contact card) -->
  <div class="lp-section lp-section--hidden" id="section-contact">
    <div class="lp-profile-card">
      <!-- Profile header -->
      <div class="lp-profile-header">
        <div class="lp-profile-avatar initials" id="profile-avatar">
          <span id="avatar-initials"></span>
          <img id="avatar-img" style="display:none" alt="">
        </div>
        <h2 class="lp-profile-name" id="profile-name"></h2>
        <p class="lp-profile-title" id="profile-title-display"></p>
        <p class="lp-profile-company" id="profile-company-display"></p>
        <p class="lp-profile-location" id="profile-location-display"></p>
        <div class="lp-profile-badge">
          <span class="lp-badge" id="apollo-badge" style="display:none"></span>
        </div>
      </div>

      <!-- Contact info row -->
      <div class="lp-profile-contact">
        <div class="lp-profile-contact-row" id="contact-email-row">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          <span id="contact-email-text" class="lp-no-data">No email found</span>
        </div>
        <div class="lp-profile-contact-row" id="contact-phone-row">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          <span id="contact-phone-text" class="lp-no-data">No phone</span>
        </div>
      </div>

      <!-- Edit toggle -->
      <div class="lp-profile-edit-toggle">
        <button class="lp-profile-edit-btn" id="edit-toggle-btn" onclick="toggleEditFields()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
          Edit details
        </button>
      </div>

      <!-- Collapsible edit fields -->
      <div class="lp-profile-edit-fields" id="edit-fields">
        <div class="lp-profile-edit-fields-inner">
          <div class="lp-fields-row">
            <div class="lp-field"><label>Full Name</label><input class="lp-value" id="f-name" type="text" placeholder="Full name"></div>
            <div class="lp-field"><label>Company</label><input class="lp-value" id="f-company" type="text" placeholder="Company name"></div>
          </div>
          <div class="lp-field"><label>Job Title</label><input class="lp-value" id="f-title" type="text" placeholder="Job title"></div>
          <div class="lp-fields-row">
            <div class="lp-field"><label>Location</label><input class="lp-value" id="f-location" type="text" placeholder="City, State"></div>
            <div class="lp-field"><label>Phone</label><input class="lp-value" id="f-phone" type="text" placeholder="Phone number"></div>
          </div>
          <div class="lp-field"><label>Headline</label><input class="lp-value" id="f-headline" type="text" placeholder="LinkedIn headline"></div>
          <div class="lp-field"><label>Email</label><input class="lp-value" id="f-email" type="email" placeholder="Enter email if not found in Apollo"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 4. Sequence & Email -->
  <div class="lp-section lp-section--hidden" id="section-email">
    <div class="lp-card">
      <div class="lp-card-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        Sequence &amp; Email
      </div>
      <div class="lp-field">
        <label>Apollo Sequence</label>
        <select class="lp-select" id="sequence-select">
          <option value="">Loading sequences...</option>
        </select>
      </div>
      <div class="lp-actions">
        <button class="lp-btn lp-btn-primary" id="btn-gen-email" onclick="generateEmail()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"/><path d="M20 3v4"/><path d="M22 5h-4"/></svg>
          Generate Email with AI
        </button>
      </div>

      <!-- Email preview (hidden until generated) -->
      <div id="email-preview-wrap" style="display:none">
        <hr style="border:none;border-top:1px solid var(--color-border);margin:1.25rem 0">
        <div class="lp-field">
          <label>Subject</label>
          <input class="lp-value" id="email-subject" type="text" placeholder="(generated by AI)">
        </div>
        <div class="lp-field">
          <label>Body</label>
          <textarea class="lp-email-preview" id="email-body-preview" rows="6"></textarea>
        </div>
        <div class="lp-actions">
          <button class="lp-btn lp-btn-secondary" id="btn-copy" onclick="copyEmail()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            Copy
          </button>
          <button class="lp-btn lp-btn-secondary" onclick="generateEmail()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
            Regenerate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- 5. Enroll -->
  <div class="lp-section lp-section--hidden" id="section-enroll">
    <div id="enroll-action">
      <button class="lp-btn lp-btn-primary" id="btn-enroll" onclick="enrollContact()" style="width:100%;justify-content:center;padding:0.75rem">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        Enroll in Sequence
      </button>
    </div>
    <div id="enroll-success" style="display:none">
      <div class="lp-success-card">
        <svg class="lp-success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <h3>Enrolled!</h3>
        <p id="enroll-success-msg"></p>
      </div>
    </div>
  </div>

  <!-- 6. Start over -->
  <div class="lp-section lp-section--hidden" id="section-reset">
    <div class="lp-start-over">
      <a href="#" onclick="resetAll(); return false;">Start over with a new prospect</a>
    </div>
  </div>

</div>

<div class="lp-toast" id="lp-toast"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // -- State --
  let extractedContact = null;
  let apolloContact = null;
  let uploadedFile = null;
  let sequences = [];
  let currentLinkedinUrl = '';

  // -- Helpers --
  function $(id) { return document.getElementById(id); }

  function showSection(id) {
    var el = $(id);
    el.classList.remove('lp-section--hidden');
    el.classList.add('lp-section--visible');
    setTimeout(function() { el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }, 80);
  }

  function hideSection(id) {
    var el = $(id);
    el.classList.remove('lp-section--visible');
    el.classList.add('lp-section--hidden');
  }

  function showToast(msg, type) {
    type = type || 'success';
    var t = $('lp-toast');
    t.textContent = msg;
    t.className = 'lp-toast visible ' + type;
    setTimeout(function() { t.className = 'lp-toast'; }, 3000);
  }

  function escH(s) {
    if (!s) return '';
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  var SVG_SPINNER = '<span class="lp-spinner"></span>';
  var SVG_CHECK = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
  var SVG_X = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';

  function setStatus(id, state) {
    var item = $(id);
    var icon = $(id + '-icon');
    item.className = 'lp-status-item ' + state;
    if (state === 'active') icon.innerHTML = SVG_SPINNER;
    else if (state === 'done') icon.innerHTML = SVG_CHECK;
    else if (state === 'error') icon.innerHTML = SVG_X;
    else icon.innerHTML = '';
  }

  function getInitials(name) {
    if (!name) return '?';
    var parts = name.trim().split(/\s+/);
    if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    return parts[0][0].toUpperCase();
  }

  function collapseInputZone() {
    // Hides URL divider + row but keeps collapsed upload bar visible
    $('input-zone').classList.add('collapsed');
    $('back-bar').style.display = '';
  }

  function hideInputZone() {
    // Completely hides input zone (for URL lookup flow)
    $('input-zone').classList.add('hidden');
    $('back-bar').style.display = '';
  }

  function expandInputZone() {
    $('input-zone').classList.remove('collapsed');
    $('input-zone').classList.remove('hidden');
    $('back-bar').style.display = 'none';
  }

  function collapseUploadZone(filename) {
    var zone = $('upload-zone');
    zone.classList.add('collapsed');
    $('upload-title').textContent = filename || 'Screenshot uploaded';
    $('upload-title').style.display = '';
  }

  function showFilledState(filename) {
    $('upload-empty').hidden = true;
    $('upload-filled').hidden = false;
    $('upload-filename').textContent = filename;
  }

  function showEmptyState() {
    $('upload-empty').hidden = false;
    $('upload-filled').hidden = true;
    $('upload-filename').textContent = '';
    $('file-input').value = '';
    var hint = document.getElementById('upload-hint');
    if (hint) hint.textContent = 'Drop a LinkedIn profile screenshot here';
  }

  // -- Update profile card display --
  function updateProfileCard(contact) {
    var name = contact.name || '';
    var title = contact.title || '';
    var company = contact.company || '';
    var location = contact.location || '';
    var email = contact.email || '';
    var phone = contact.phone || '';
    var photoUrl = contact.photo_url || '';

    // Avatar
    var avatarEl = $('profile-avatar');
    var avatarImg = $('avatar-img');
    var avatarInitials = $('avatar-initials');
    if (photoUrl) {
      avatarImg.src = photoUrl;
      avatarImg.style.display = '';
      avatarInitials.style.display = 'none';
      avatarEl.classList.remove('initials');
    } else {
      avatarImg.style.display = 'none';
      avatarInitials.style.display = '';
      avatarInitials.textContent = getInitials(name);
      avatarEl.classList.add('initials');
    }

    // Text fields
    $('profile-name').textContent = name || '';
    $('profile-name').style.display = name ? '' : 'none';
    $('profile-title-display').textContent = title || '';
    $('profile-title-display').style.display = title ? '' : 'none';
    $('profile-company-display').textContent = company || '';
    $('profile-company-display').style.display = company ? '' : 'none';
    $('profile-location-display').textContent = location || '';

    // Contact row
    var emailText = $('contact-email-text');
    if (email) {
      emailText.textContent = email;
      emailText.className = '';
    } else {
      emailText.textContent = 'No email found — expand Edit to enter';
      emailText.className = 'lp-no-data';
    }

    var phoneText = $('contact-phone-text');
    if (phone) {
      phoneText.textContent = phone;
      phoneText.className = '';
    } else {
      phoneText.textContent = 'No phone';
      phoneText.className = 'lp-no-data';
    }
  }

  // -- Edit fields toggle --
  window.toggleEditFields = function() {
    var fields = $('edit-fields');
    var btn = $('edit-toggle-btn');
    fields.classList.toggle('open');
    btn.classList.toggle('open');
    btn.querySelector('span') || null; // no-op
    if (fields.classList.contains('open')) {
      btn.childNodes[btn.childNodes.length - 1].textContent = ' Hide details';
    } else {
      btn.childNodes[btn.childNodes.length - 1].textContent = ' Edit details';
    }
  };

  // Sync edit fields back to profile card when user changes them
  ['f-name', 'f-title', 'f-company', 'f-location', 'f-email', 'f-phone'].forEach(function(id) {
    var el = $(id);
    if (el) {
      el.addEventListener('input', function() {
        updateProfileCard({
          name: $('f-name').value,
          title: $('f-title').value,
          company: $('f-company').value,
          location: $('f-location').value,
          email: $('f-email').value,
          phone: $('f-phone').value,
          photo_url: ($('avatar-img').style.display !== 'none') ? $('avatar-img').src : ''
        });
      });
    }
  });

  // -- Upload & drag/drop --
  var zone = $('upload-zone');
  var fileInput = $('file-input');

  zone.addEventListener('dragover', function(e) {
    e.preventDefault();
    zone.classList.add('drag-over');
    var hint = document.getElementById('upload-hint');
    if (hint) hint.textContent = 'Release to drop';
  });
  zone.addEventListener('dragleave', function() {
    zone.classList.remove('drag-over');
    var hint = document.getElementById('upload-hint');
    if (hint) hint.textContent = 'Drop a LinkedIn profile screenshot here';
  });
  zone.addEventListener('drop', function(e) {
    e.preventDefault();
    zone.classList.remove('drag-over');
    var hint = document.getElementById('upload-hint');
    if (hint) hint.textContent = 'Drop a LinkedIn profile screenshot here';
    var file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) handleFile(file);
  });
  fileInput.addEventListener('change', function() {
    if (fileInput.files[0]) handleFile(fileInput.files[0]);
  });
  // Clear file button
  var clearBtn = $('clear-file-btn');
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      showEmptyState();
      uploadedFile = null;
    });
  }
  // Re-open file picker if collapsed upload zone is clicked
  zone.addEventListener('click', function(e) {
    if (zone.classList.contains('collapsed') && e.target !== fileInput) {
      fileInput.click();
    }
  });

  function handleFile(file) {
    // File size limit: 10MB
    if (file.size > 10 * 1024 * 1024) {
      showToast('File too large (max 10MB)', 'error');
      return;
    }
    uploadedFile = file;
    currentLinkedinUrl = '';

    // Show filled state, then collapse to bar
    showFilledState(file.name);
    collapseUploadZone(file.name);
    collapseInputZone();

    // Reset downstream sections
    hideSection('section-contact');
    hideSection('section-email');
    hideSection('section-enroll');
    hideSection('section-reset');
    $('email-preview-wrap').style.display = 'none';
    $('enroll-action').style.display = '';
    $('enroll-success').style.display = 'none';

    // Show status & start auto-chain
    $('status-extract-text').textContent = 'Extracting contact from screenshot...';
    $('status-extract').style.display = '';
    $('status-apollo-text').textContent = 'Searching Apollo for email...';
    setStatus('status-extract', 'active');
    setStatus('status-apollo', '');
    showSection('section-status');
    extractContact();
  }

  // -- LinkedIn URL lookup --
  var urlLookupInProgress = false;
  window.handleUrlLookup = async function() {
    if (urlLookupInProgress) return;
    urlLookupInProgress = true;
    var lookupBtn = $('url-btn');
    if (lookupBtn) lookupBtn.disabled = true;

    var urlInput = $('url-input');
    var rawUrl = (urlInput.value || '').trim();

    // Validate LinkedIn URL pattern
    var match = rawUrl.match(/linkedin\.com\/in\/([a-zA-Z0-9_-]+)/);
    if (!match) {
      showToast('Enter a valid LinkedIn URL (linkedin.com/in/...)', 'error');
      urlLookupInProgress = false;
      if (lookupBtn) lookupBtn.disabled = false;
      return;
    }

    // Normalize to full URL
    currentLinkedinUrl = rawUrl.startsWith('http') ? rawUrl : 'https://' + rawUrl;
    uploadedFile = null;

    // Fully hide the input zone
    hideInputZone();

    // Reset downstream
    hideSection('section-contact');
    hideSection('section-email');
    hideSection('section-enroll');
    hideSection('section-reset');
    $('email-preview-wrap').style.display = 'none';
    $('enroll-action').style.display = '';
    $('enroll-success').style.display = 'none';

    // Show status — skip extraction step, go straight to Apollo
    $('status-extract-text').textContent = 'Looking up LinkedIn profile...';
    $('status-extract').style.display = 'none';
    $('status-apollo-text').textContent = 'Searching Apollo for email...';
    setStatus('status-apollo', 'active');
    showSection('section-status');

    // Go directly to Apollo with linkedin_url
    await findInApollo(currentLinkedinUrl);
    urlLookupInProgress = false;
    if (lookupBtn) lookupBtn.disabled = false;
  };

  // Allow Enter key in URL input
  $('url-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      window.handleUrlLookup();
    }
  });

  // -- Extract via AI --
  async function extractContact() {
    var formData = new FormData();
    formData.append('image', uploadedFile);

    try {
      var resp = await fetch('/api/linkedin/extract', { method: 'POST', body: formData });
      var data = await resp.json();
      if (data.status === 'success' && data.data) {
        extractedContact = data.data;
        setStatus('status-extract', 'done');

        // Store linkedin_url from extraction if found
        if (data.data.linkedin_url) {
          currentLinkedinUrl = data.data.linkedin_url;
        }

        // Populate edit fields
        $('f-name').value     = data.data.name || '';
        $('f-title').value    = data.data.title || '';
        $('f-company').value  = data.data.company || '';
        $('f-location').value = data.data.location || '';
        $('f-headline').value = data.data.headline || '';

        // Auto-trigger Apollo search
        findInApollo(currentLinkedinUrl);
      } else {
        setStatus('status-extract', 'error');
        showToast(data.message || 'Could not extract contact info', 'error');
      }
    } catch(e) {
      setStatus('status-extract', 'error');
      showToast('Extraction failed — check your connection', 'error');
    }
  }

  // -- Find in Apollo (auto-triggered) --
  window.findInApollo = async function(linkedinUrl) {
    setStatus('status-apollo', 'active');

    var payload = {
      name: $('f-name').value || '',
      company: $('f-company').value || '',
      title: $('f-title').value || ''
    };

    // Add linkedin_url if available
    if (linkedinUrl) {
      payload.linkedin_url = linkedinUrl;
    }

    try {
      var resp = await fetch('/api/linkedin/find-contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      var data = await resp.json();
      var badge = $('apollo-badge');

      if (data.status === 'success' && data.contact) {
        apolloContact = data.contact;
        setStatus('status-apollo', 'done');
        $('status-apollo-text').textContent = data.contact.email ? 'Email found in Apollo' : 'Found in Apollo (no email)';

        // Badge
        badge.style.display = '';
        badge.className = 'lp-badge found';
        badge.innerHTML = SVG_CHECK + ' Found';

        // Fill edit fields from Apollo data (enrich what extraction gave us)
        var c = data.contact;
        if (c.name) $('f-name').value = c.name;
        if (c.title) $('f-title').value = c.title;
        if (c.company) $('f-company').value = c.company;
        var loc = [c.city, c.state, c.country].filter(Boolean).join(', ');
        if (loc) $('f-location').value = loc;
        $('f-email').value = c.email || '';
        $('f-phone').value = c.phone || c.phone_number || c.sanitized_phone || '';

        // Update profile card display
        updateProfileCard({
          name: $('f-name').value,
          title: $('f-title').value,
          company: $('f-company').value,
          location: $('f-location').value,
          email: $('f-email').value,
          phone: $('f-phone').value,
          photo_url: c.photo_url || ''
        });

        if (!c.email) {
          showToast('Found in Apollo but no email — expand Edit to enter one', 'error');
        }
      } else {
        setStatus('status-apollo', 'done');
        $('status-apollo-text').textContent = 'Not found in Apollo';
        badge.style.display = '';
        badge.className = 'lp-badge not-found';
        badge.textContent = 'Not found';
        showToast('Not found in Apollo — expand Edit to enter email manually', 'error');

        // Still update profile card from whatever we have
        updateProfileCard({
          name: $('f-name').value,
          title: $('f-title').value,
          company: $('f-company').value,
          location: $('f-location').value,
          email: $('f-email').value,
          phone: $('f-phone').value,
          photo_url: ''
        });
      }

      // Reveal contact card + email section regardless
      showSection('section-contact');
      setTimeout(function() { showSection('section-email'); }, 200);
      setTimeout(function() { showSection('section-reset'); }, 350);
    } catch(e) {
      setStatus('status-apollo', 'error');
      $('status-apollo-text').textContent = 'Apollo search failed';
      showToast('Apollo search failed', 'error');

      // Still update profile card from extraction data
      updateProfileCard({
        name: $('f-name').value,
        title: $('f-title').value,
        company: $('f-company').value,
        location: $('f-location').value,
        email: '',
        phone: '',
        photo_url: ''
      });

      // Still show contact card so user can enter email manually
      showSection('section-contact');
      setTimeout(function() { showSection('section-email'); }, 200);
      setTimeout(function() { showSection('section-reset'); }, 350);
    }
  };

  // -- Generate email via AI --
  window.generateEmail = async function() {
    var btn = $('btn-gen-email');
    btn.disabled = true;
    btn.classList.add('lp-btn-loading');
    btn.innerHTML = '<span class="lp-spinner lp-spinner--white"></span> Generating...';

    var contact = {
      name: $('f-name').value,
      title: $('f-title').value,
      company: $('f-company').value,
      location: $('f-location').value,
      headline: $('f-headline').value,
      email: $('f-email').value
    };

    try {
      var resp = await fetch('/api/linkedin/generate-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contact: contact })
      });

      var data;
      if (!resp.ok) {
        try { data = await resp.json(); } catch(_) { data = {}; }
        var errMsg = data.message || 'Email generation failed — please try again shortly';
        // Never show raw JSON/stack traces to the user
        if (errMsg.length > 200 || errMsg.indexOf('{') !== -1) {
          errMsg = 'AI service is temporarily unavailable. Please try again shortly.';
        }
        showToast(errMsg, 'error');
        return;
      }
      data = await resp.json();

      if (data.status === 'success' && data.email) {
        $('email-subject').value = data.email.subject || '';
        $('email-body-preview').className = 'lp-email-preview';
        $('email-body-preview').value = data.email.body || '';
        $('email-preview-wrap').style.display = '';
        showSection('section-enroll');
        showToast('Email generated');
        $('email-preview-wrap').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        showToast(data.message || 'Email generation failed', 'error');
      }
    } catch(e) {
      showToast('Network error generating email', 'error');
    } finally {
      btn.classList.remove('lp-btn-loading');
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg> Generate Email with AI';
    }
  };

  // -- Enroll in Apollo sequence --
  window.enrollContact = async function() {
    var email = ($('f-email').value || '').trim();
    if (!email) { showToast('No email address — cannot enroll', 'error'); return; }

    var seqId = $('sequence-select').value;
    var seqName = $('sequence-select').selectedOptions[0] ? $('sequence-select').selectedOptions[0].text : '';
    if (!seqId) { showToast('Please select a sequence', 'error'); return; }

    var btn = $('btn-enroll');
    btn.disabled = true;
    btn.innerHTML = '<span class="lp-spinner lp-spinner--white"></span> Enrolling...';

    var nameParts = ($('f-name').value || '').trim().split(' ');
    var payload = {
      email: email,
      first_name: nameParts[0] || '',
      last_name: nameParts.slice(1).join(' ') || '',
      sequence_id: seqId,
      company_name: $('f-company').value || '',
      personalized_subject: $('email-subject').value || '',
      personalized_email_body: $('email-body-preview').value || ''
    };

    try {
      var resp = await fetch('/api/apollo/enroll-sequence', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      var data = await resp.json();

      if (data.status === 'success') {
        $('enroll-action').style.display = 'none';
        $('enroll-success').style.display = '';
        $('enroll-success-msg').textContent = email + ' enrolled in "' + seqName + '"';
        showToast(email + ' enrolled successfully');
        $('enroll-success').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        btn.disabled = false;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';
        showToast(data.message || 'Enrollment failed', 'error');
      }
    } catch(e) {
      btn.disabled = false;
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';
      showToast('Network error', 'error');
    }
  };

  // -- Copy email --
  window.copyEmail = function() {
    var subj = $('email-subject').value;
    var body = $('email-body-preview').value;
    var text = 'Subject: ' + subj + '\n\n' + body;
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
          .then(function() { showToast('Copied to clipboard'); })
          .catch(function() { showToast('Copy failed', 'error'); });
      } else {
        // Fallback for non-secure contexts
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Copied to clipboard');
      }
    } catch(e) { showToast('Copy failed', 'error'); }
  };

  // -- Reset everything --
  window.resetAll = function() {
    // Clear state
    extractedContact = null;
    apolloContact = null;
    uploadedFile = null;
    currentLinkedinUrl = '';

    // Reset upload zone
    showEmptyState();
    $('preview-img').style.display = 'none';
    $('preview-img').src = '';
    $('upload-title').textContent = 'Drop a LinkedIn screenshot here';
    $('upload-title').style.display = 'none';
    $('upload-btn').disabled = false;
    $('upload-zone').classList.remove('collapsed');

    // Reset URL input
    $('url-input').value = '';
    expandInputZone();

    // Reset fields
    $('f-name').value = '';
    $('f-title').value = '';
    $('f-company').value = '';
    $('f-location').value = '';
    $('f-headline').value = '';
    $('f-phone').value = '';
    $('f-email').value = '';
    $('email-subject').value = '';
    $('email-body-preview').value = '';
    $('email-preview-wrap').style.display = 'none';

    // Reset profile card
    $('profile-name').textContent = '';
    $('profile-name').style.display = '';
    $('profile-title-display').textContent = '';
    $('profile-title-display').style.display = '';
    $('profile-company-display').textContent = '';
    $('profile-company-display').style.display = '';
    $('profile-location-display').textContent = '';
    $('contact-email-text').textContent = 'No email found';
    $('contact-email-text').className = 'lp-no-data';
    $('contact-phone-text').textContent = 'No phone';
    $('contact-phone-text').className = 'lp-no-data';
    $('avatar-img').style.display = 'none';
    $('avatar-initials').textContent = '';
    $('profile-avatar').classList.add('initials');

    // Close edit fields if open
    $('edit-fields').classList.remove('open');
    $('edit-toggle-btn').classList.remove('open');
    var btnNodes = $('edit-toggle-btn').childNodes;
    btnNodes[btnNodes.length - 1].textContent = ' Edit details';

    // Reset enroll
    $('enroll-action').style.display = '';
    $('enroll-success').style.display = 'none';
    var enrollBtn = $('btn-enroll');
    enrollBtn.disabled = false;
    enrollBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Enroll in Sequence';

    // Reset badge
    $('apollo-badge').style.display = 'none';

    // Hide all sections
    hideSection('section-status');
    hideSection('section-contact');
    hideSection('section-email');
    hideSection('section-enroll');
    hideSection('section-reset');

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  // -- Load sequences on page init (filtered) --
  async function loadSequences() {
    var sel = $('sequence-select');
    try {
      var resp = await fetch('/api/apollo/sequences');
      var data = await resp.json();
      if (data.status === 'success' && data.sequences && data.sequences.length) {
        sequences = data.sequences;
        // Filter to preferred sequence; fall back to all if not found
        var preferred = sequences.filter(function(s) {
          var name = (s.name || '').toLowerCase();
          return name === 'test zapier workflow' || name.indexOf('zapier') !== -1;
        });
        var displaySequences = preferred.length > 0 ? preferred : sequences;
        sel.innerHTML = displaySequences.map(function(s) {
          return '<option value="' + escH(s.id) + '"' + (s.active ? '' : ' title="Paused in Apollo — emails won\'t send until activated"') + '>' + escH(s.name) + (s.active ? '' : ' (paused)') + '</option>';
        }).join('');
      } else {
        sel.innerHTML = '<option value="">No sequences found</option>';
      }
    } catch(e) {
      sel.innerHTML = '<option value="">Could not load sequences</option>';
    }
  }

  loadSequences();
})();
</script>
{% endblock %}
