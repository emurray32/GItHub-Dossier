{% extends "base.html" %}

{% block title %}WebScraper Accounts - Lead Machine{% endblock %}
{% block page_title %}WebScraper Accounts{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/webscraper_accounts.css') }}?v={{ cache_bust }}">
{% endblock %}

{% block content %}
<div class="container accounts-page">
    <header class="page-header">
        <div class="accounts-header">
            <div>
                <h1 class="page-title">WebScraper Accounts</h1>
                <p class="page-subtitle">Analyze websites for localization signals and quality gaps</p>
            </div>

            <div class="accounts-stats">
                <div class="search-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="account-search" class="search-input" placeholder="Search accounts..." autocomplete="off">
                </div>

                <div class="tier-filter">
                    <button class="tier-filter-btn active" data-tier="all">
                        All <span class="tier-count" id="count-all">0</span>
                    </button>
                    <button class="tier-filter-btn" data-tier="1">
                        Tier 1 <span class="tier-count" id="count-1">0</span>
                    </button>
                    <button class="tier-filter-btn" data-tier="2">
                        Tier 2 <span class="tier-count" id="count-2">0</span>
                    </button>
                    <button class="tier-filter-btn" data-tier="3">
                        Tier 3 <span class="tier-count" id="count-3">0</span>
                    </button>
                    <button class="tier-filter-btn" data-tier="4">
                        Tier 4 <span class="tier-count" id="count-4">0</span>
                    </button>
                    <button class="tier-filter-btn archived-btn" data-tier="archived">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="21 8 21 21 3 21 3 8"></polyline>
                            <rect x="1" y="3" width="22" height="5"></rect>
                            <line x1="10" y1="12" x2="14" y2="12"></line>
                        </svg>
                        Archived <span class="tier-count" id="count-archived">0</span>
                    </button>

                    <span class="tier-filter-divider"></span>

                    <button class="tier-filter-btn action-btn" id="grow-btn" onclick="openGrowModal()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 20V10"></path>
                            <path d="M18 20V4"></path>
                            <path d="M6 20v-4"></path>
                        </svg>
                        Grow
                    </button>
                    <button class="tier-filter-btn action-btn" id="ruleset-btn" onclick="openRuleSetModal()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                        Rule Set
                    </button>
                    <button class="tier-filter-btn action-btn" id="history-btn" onclick="openHistoryModal()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        History
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Tier Legend -->
    <div class="status-legend-container">
        <div class="legend-item tier-1">
            <div class="legend-header">
                <span class="status-dot"></span>
                <span class="status-title">Tier 1: Global Leader</span>
            </div>
            <span class="status-desc">Mature global presence (10+ locales)</span>
        </div>
        <div class="legend-item tier-2">
            <div class="legend-header">
                <span class="status-dot"></span>
                <span class="status-title">Tier 2: Active Expansion</span>
            </div>
            <span class="status-desc">Already global, expanding to new markets</span>
        </div>
        <div class="legend-item tier-3">
            <div class="legend-header">
                <span class="status-dot"></span>
                <span class="status-title">Tier 3: Going Global</span>
            </div>
            <span class="status-desc">First-time global expansion</span>
        </div>
        <div class="legend-item tier-4">
            <div class="legend-header">
                <span class="status-dot"></span>
                <span class="status-title">Tier 4: Not Yet Global</span>
            </div>
            <span class="status-desc">No localization signals - potential prospect</span>
        </div>
    </div>

    <!-- Data Table -->
    <div class="accounts-table-container" id="table-container">
        <div class="loading-overlay" id="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        <table class="accounts-table" id="accounts-table">
            <thead>
                <tr>
                    <th class="select-col">
                        <input type="checkbox" id="select-all" class="select-account-checkbox" aria-label="Select all">
                    </th>
                    <th class="row-num-col">#</th>
                    <th class="sortable company-col" data-column="0">Company</th>
                    <th class="sortable website-col" data-column="1">Website URL</th>
                    <th class="sortable tier-col" data-column="2">Tier</th>
                    <th class="sortable locale-col" data-column="3">Locales</th>
                    <th class="sortable score-col" data-column="4">Score</th>
                    <th class="sortable last-scanned-col" data-column="5">Last Scanned</th>
                    <th class="evidence-col">Evidence</th>
                    <th class="actions-col">Actions</th>
                </tr>
            </thead>
            <tbody id="accounts-tbody">
                <!-- Data will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" id="pagination-container">
        <div class="pagination-info" id="pagination-info">Loading...</div>
        <div class="pagination-controls">
            <select id="limit-select" class="pagination-limit-select" aria-label="Rows per page">
                <option value="25">25 rows</option>
                <option value="50" selected>50 rows</option>
                <option value="100">100 rows</option>
                <option value="250">250 rows</option>
            </select>
            <button type="button" class="pagination-btn" id="prev-page" disabled>Previous</button>
            <span class="pagination-page-display" id="page-display">Page 1 of 1</span>
            <button type="button" class="pagination-btn" id="next-page" disabled>Next</button>
        </div>
    </div>

    <!-- Bulk Action Bar -->
    <div class="bulk-command-bar hidden" id="bulk-bar">
        <span class="bulk-command-count"><span id="selected-count">0</span> accounts selected</span>
        <div class="bulk-command-actions">
            <button type="button" class="btn-scan" id="bulk-scan" title="Scan selected accounts for localization signals">
                Scan Selected
            </button>
            <button type="button" class="btn-secondary" id="bulk-export">
                Export CSV
            </button>
            <button type="button" class="btn-secondary" id="bulk-tier-change">
                Change Tier
            </button>
            <button type="button" class="btn-secondary" id="bulk-archive">
                Archive
            </button>
            <button type="button" class="btn-danger" id="bulk-delete">
                Delete
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// State
let currentPage = 0;
let pageSize = 50;
let totalRecords = 0;
let totalPages = 1;
let currentTierFilter = null;
let searchQuery = '';
let sortColumn = 0;
let sortDir = 'asc';
let selectedIds = new Set();

// DOM Elements
const searchInput = document.getElementById('account-search');
const tbody = document.getElementById('accounts-tbody');
const loadingOverlay = document.getElementById('loading-overlay');
const paginationInfo = document.getElementById('pagination-info');
const pageDisplay = document.getElementById('page-display');
const prevPageBtn = document.getElementById('prev-page');
const nextPageBtn = document.getElementById('next-page');
const limitSelect = document.getElementById('limit-select');
const selectAllCheckbox = document.getElementById('select-all');
const bulkBar = document.getElementById('bulk-bar');
const selectedCountEl = document.getElementById('selected-count');

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadTierCounts();
    loadAccounts();
    setupEventListeners();
});

function setupEventListeners() {
    // Search with debounce
    let searchTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchQuery = searchInput.value.trim();
            currentPage = 0;
            loadAccounts();
        }, 300);
    });

    // Tier filter buttons
    document.querySelectorAll('.tier-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.tier-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const tier = btn.dataset.tier;
            if (tier === 'all') {
                currentTierFilter = null;
            } else if (tier === 'archived') {
                // TODO: Handle archived view
                currentTierFilter = null;
            } else {
                currentTierFilter = [parseInt(tier)];
            }
            currentPage = 0;
            loadAccounts();
        });
    });

    // Pagination
    limitSelect.addEventListener('change', () => {
        pageSize = parseInt(limitSelect.value);
        currentPage = 0;
        loadAccounts();
    });

    prevPageBtn.addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            loadAccounts();
        }
    });

    nextPageBtn.addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            currentPage++;
            loadAccounts();
        }
    });

    // Select all
    selectAllCheckbox.addEventListener('change', () => {
        const checkboxes = tbody.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = selectAllCheckbox.checked;
            const id = parseInt(cb.dataset.id);
            if (selectAllCheckbox.checked) {
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
            }
        });
        updateBulkBar();
    });

    // Bulk actions
    document.getElementById('bulk-archive').addEventListener('click', bulkArchive);
    document.getElementById('bulk-delete').addEventListener('click', bulkDelete);
    document.getElementById('bulk-export').addEventListener('click', exportCSV);
    document.getElementById('bulk-tier-change').addEventListener('click', bulkChangeTier);
    document.getElementById('bulk-scan').addEventListener('click', bulkScan);

    // Sort headers
    document.querySelectorAll('.accounts-table th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const column = parseInt(th.dataset.column);
            if (sortColumn === column) {
                sortDir = sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDir = 'asc';
            }
            loadAccounts();
        });
    });
}

async function loadTierCounts() {
    try {
        const response = await fetch('/api/webscraper/accounts/tier-counts');
        const counts = await response.json();

        document.getElementById('count-1').textContent = counts['1'] || 0;
        document.getElementById('count-2').textContent = counts['2'] || 0;
        document.getElementById('count-3').textContent = counts['3'] || 0;
        document.getElementById('count-4').textContent = counts['4'] || 0;
        document.getElementById('count-archived').textContent = counts['archived'] || 0;

        const total = (counts['1'] || 0) + (counts['2'] || 0) + (counts['3'] || 0) + (counts['4'] || 0);
        document.getElementById('count-all').textContent = total;
    } catch (error) {
        console.error('Failed to load tier counts:', error);
    }
}

async function loadAccounts() {
    loadingOverlay.style.display = 'flex';

    try {
        let url = `/api/webscraper/accounts/datatable?draw=1&start=${currentPage * pageSize}&length=${pageSize}`;
        url += `&search[value]=${encodeURIComponent(searchQuery)}`;
        url += `&order[0][column]=${sortColumn}&order[0][dir]=${sortDir}`;

        if (currentTierFilter) {
            currentTierFilter.forEach(t => url += `&tier=${t}`);
        }

        const response = await fetch(url);
        const data = await response.json();

        totalRecords = data.recordsFiltered;
        totalPages = Math.ceil(totalRecords / pageSize);

        renderTable(data.data);
        updatePagination();

    } catch (error) {
        console.error('Failed to load accounts:', error);
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: var(--text-muted);">Failed to load accounts</td></tr>';
    } finally {
        loadingOverlay.style.display = 'none';
    }
}

function renderTable(accounts) {
    if (!accounts || accounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: var(--text-muted);">No accounts found</td></tr>';
        return;
    }

    tbody.innerHTML = accounts.map((account, index) => {
        const rowNum = currentPage * pageSize + index + 1;
        const isSelected = selectedIds.has(account.id);

        const websiteHtml = account.website_url
            ? `<a href="${escapeHtml(normalizeUrl(account.website_url))}" target="_blank" rel="noopener" class="website-link">
                <span>${escapeHtml(truncateUrl(account.website_url))}</span>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                    <polyline points="15 3 21 3 21 9"></polyline>
                    <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
               </a>`
            : '<span class="not-scanned">-</span>';

        const tierLabel = {
            1: 'Global Leader',
            2: 'Expanding',
            3: 'Going Global',
            4: 'Not Yet Global'
        }[account.current_tier] || 'Not Yet Global';

        const localeCount = account.locale_count !== null && account.locale_count !== undefined
            ? account.locale_count
            : '<span class="not-scanned">-</span>';

        const coverageScore = account.localization_coverage_score !== null
            ? account.localization_coverage_score
            : '<span class="not-scanned">-</span>';

        const lastScanned = account.last_scanned_at
            ? timeAgo(account.last_scanned_at)
            : '<span class="never-scanned">Never</span>';

        const evidence = account.evidence_summary
            ? escapeHtml(account.evidence_summary)
            : '<span class="not-scanned">Awaiting scan</span>';

        return `
            <tr data-id="${account.id}">
                <td class="select-col">
                    <input type="checkbox" class="select-account-checkbox row-checkbox" data-id="${account.id}" ${isSelected ? 'checked' : ''}>
                </td>
                <td class="row-num-col">${rowNum}</td>
                <td class="company-cell">${escapeHtml(account.company_name)}</td>
                <td class="website-cell">${websiteHtml}</td>
                <td>
                    <span class="tier-badge tier-${account.current_tier}">${tierLabel}</span>
                </td>
                <td class="locale-cell">${localeCount}</td>
                <td class="score-cell">${coverageScore}</td>
                <td class="last-scanned-cell">${lastScanned}</td>
                <td class="evidence-cell">
                    <span class="evidence-text" title="${escapeHtml(account.evidence_summary || '')}">${evidence}</span>
                </td>
                <td class="actions-cell">
                    <button class="btn-scan" onclick="scanAccount(${account.id})" title="Scan this account">Scan</button>
                    <button class="btn-archive" onclick="archiveAccount(${account.id})" title="Archive">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="21 8 21 21 3 21 3 8"></polyline>
                            <rect x="1" y="3" width="22" height="5"></rect>
                        </svg>
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    // Re-attach checkbox listeners
    tbody.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
            const id = parseInt(cb.dataset.id);
            if (cb.checked) {
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
            }
            updateBulkBar();
        });
    });
}

function updatePagination() {
    const start = currentPage * pageSize + 1;
    const end = Math.min((currentPage + 1) * pageSize, totalRecords);

    paginationInfo.textContent = totalRecords > 0
        ? `Showing ${start} to ${end} of ${totalRecords} accounts`
        : 'No accounts found';

    pageDisplay.textContent = `Page ${currentPage + 1} of ${Math.max(1, totalPages)}`;

    prevPageBtn.disabled = currentPage === 0;
    nextPageBtn.disabled = currentPage >= totalPages - 1;
}

function updateBulkBar() {
    const count = selectedIds.size;
    selectedCountEl.textContent = count;
    bulkBar.classList.toggle('hidden', count === 0);
    selectAllCheckbox.checked = count > 0 && count === tbody.querySelectorAll('.row-checkbox').length;
}

// Actions
async function scanAccount(id) {
    const btn = event.target;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Scanning...';

    try {
        const response = await fetch(`/api/webscraper/accounts/scan/${id}`, { method: 'POST' });
        const result = await response.json();

        if (result.status === 'completed') {
            // Show success with tier info
            const tierLabel = result.results?.tier_label || 'Unknown';
            const localeCount = result.results?.locale_count || 0;
            alert(`Scan complete!\n\nTier: ${tierLabel}\nLocales: ${localeCount}\nEvidence: ${result.results?.evidence || 'N/A'}`);
            loadAccounts();
            loadTierCounts();
        } else if (result.status === 'error') {
            alert(`Scan failed: ${result.message}`);
        } else {
            alert(result.message || 'Scan completed');
        }
    } catch (error) {
        alert('Failed to scan account: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function archiveAccount(id) {
    if (!confirm('Archive this account?')) return;

    try {
        const response = await fetch(`/api/webscraper/accounts/${id}/archive`, { method: 'POST' });
        if (response.ok) {
            loadAccounts();
            loadTierCounts();
        } else {
            alert('Failed to archive account');
        }
    } catch (error) {
        alert('Failed to archive account');
    }
}

async function bulkArchive() {
    if (selectedIds.size === 0) return;
    if (!confirm(`Archive ${selectedIds.size} accounts?`)) return;

    try {
        const response = await fetch('/api/webscraper/accounts/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'archive', account_ids: Array.from(selectedIds) })
        });

        if (response.ok) {
            selectedIds.clear();
            updateBulkBar();
            loadAccounts();
            loadTierCounts();
        } else {
            alert('Failed to archive accounts');
        }
    } catch (error) {
        alert('Failed to archive accounts');
    }
}

async function bulkDelete() {
    if (selectedIds.size === 0) return;
    if (!confirm(`Delete ${selectedIds.size} accounts? This cannot be undone.`)) return;

    try {
        const response = await fetch('/api/webscraper/accounts/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'delete', account_ids: Array.from(selectedIds) })
        });

        if (response.ok) {
            selectedIds.clear();
            updateBulkBar();
            loadAccounts();
            loadTierCounts();
        } else {
            alert('Failed to delete accounts');
        }
    } catch (error) {
        alert('Failed to delete accounts');
    }
}

async function bulkChangeTier() {
    if (selectedIds.size === 0) return;

    const tier = prompt('Enter new tier (1-4):');
    if (!tier) return;

    const tierNum = parseInt(tier);
    if (isNaN(tierNum) || tierNum < 1 || tierNum > 4) {
        alert('Invalid tier. Please enter 1, 2, 3, or 4.');
        return;
    }

    try {
        const response = await fetch('/api/webscraper/accounts/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'change_tier', account_ids: Array.from(selectedIds), tier: tierNum })
        });

        if (response.ok) {
            selectedIds.clear();
            updateBulkBar();
            loadAccounts();
            loadTierCounts();
        } else {
            alert('Failed to change tier');
        }
    } catch (error) {
        alert('Failed to change tier');
    }
}

function exportCSV() {
    // Get all visible rows
    const rows = tbody.querySelectorAll('tr');
    let csv = 'Company,Website,Tier,Locales,Score,Last Scanned,Evidence\n';

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 9) {
            const company = cells[2].textContent.trim();
            const website = cells[3].textContent.trim();
            const tier = cells[4].textContent.trim();
            const locales = cells[5].textContent.trim();
            const score = cells[6].textContent.trim();
            const lastScanned = cells[7].textContent.trim();
            const evidence = cells[8].textContent.trim();

            csv += `"${company}","${website}","${tier}","${locales}","${score}","${lastScanned}","${evidence}"\n`;
        }
    });

    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'webscraper_accounts.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

async function bulkScan() {
    if (selectedIds.size === 0) return;

    const count = selectedIds.size;
    if (!confirm(`Scan ${count} account(s) for localization and global expansion signals?\n\nThis may take a few moments.`)) return;

    // Show scanning progress
    const bulkScanBtn = document.getElementById('bulk-scan');
    const originalText = bulkScanBtn.textContent;
    bulkScanBtn.disabled = true;
    bulkScanBtn.textContent = `Scanning 0/${count}...`;

    try {
        const response = await fetch('/api/webscraper/accounts/bulk', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'scan', account_ids: Array.from(selectedIds) })
        });

        const result = await response.json();

        if (response.ok) {
            // Build result message
            let message = `Scan Complete!\n\n`;
            message += `Completed: ${result.completed}\n`;
            message += `Failed: ${result.failed}\n`;
            message += `Skipped: ${result.skipped}\n`;

            // Show tier breakdown if there are completed scans
            if (result.details && result.completed > 0) {
                const tierCounts = {1: 0, 2: 0, 3: 0, 4: 0};
                result.details.filter(d => d.status === 'completed').forEach(d => {
                    tierCounts[d.tier] = (tierCounts[d.tier] || 0) + 1;
                });
                message += `\nTier Breakdown:\n`;
                message += `  Tier 1 (Global Leader): ${tierCounts[1]}\n`;
                message += `  Tier 2 (Active Expansion): ${tierCounts[2]}\n`;
                message += `  Tier 3 (Going Global): ${tierCounts[3]}\n`;
                message += `  Tier 4 (Not Yet Global): ${tierCounts[4]}`;
            }

            alert(message);
            selectedIds.clear();
            updateBulkBar();
            loadAccounts();
            loadTierCounts();
        } else {
            alert(`Bulk scan failed: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        alert('Failed to perform bulk scan: ' + error.message);
    } finally {
        bulkScanBtn.disabled = false;
        bulkScanBtn.textContent = originalText;
    }
}

// Utility functions
function escapeHtml(text) {
    if (!text) return '';
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

function normalizeUrl(url) {
    if (!url) return '';
    url = url.trim();
    if (!url.toLowerCase().startsWith('http://') && !url.toLowerCase().startsWith('https://')) {
        return 'https://' + url;
    }
    return url;
}

function truncateUrl(url) {
    if (!url) return '';
    // Remove protocol and www
    let clean = url.replace(/^https?:\/\/(www\.)?/, '');
    // Remove trailing slash
    clean = clean.replace(/\/$/, '');
    // Truncate if too long
    if (clean.length > 30) {
        clean = clean.substring(0, 27) + '...';
    }
    return clean;
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return dateString;

    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    if (seconds < 60) return `${Math.max(seconds, 1)} sec${seconds === 1 ? '' : 's'} ago`;

    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} min${minutes === 1 ? '' : 's'} ago`;

    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours === 1 ? '' : 's'} ago`;

    const days = Math.floor(hours / 24);
    if (days < 30) return `${days} day${days === 1 ? '' : 's'} ago`;

    const months = Math.floor(days / 30);
    if (months < 12) return `${months} month${months === 1 ? '' : 's'} ago`;

    const years = Math.floor(months / 12);
    return `${years} year${years === 1 ? '' : 's'} ago`;
}

// ============================================================
// GROW MODAL
// ============================================================
function openGrowModal() {
    document.getElementById('grow-modal').classList.add('active');
}

function closeGrowModal() {
    document.getElementById('grow-modal').classList.remove('active');
}

async function growFromRepoRadar() {
    closeGrowModal();
    try {
        const response = await fetch('/api/webscraper/accounts/populate-from-reporadar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();
        if (response.ok) {
            alert(`Added ${result.added} new accounts from RepoRadar!\n\nSkipped ${result.skipped} (already exist)`);
            loadAccounts();
            loadTierCounts();
        } else {
            alert('Failed to populate: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to populate from RepoRadar: ' + error.message);
    }
}

// ============================================================
// RULE SET MODAL
// ============================================================
let ruleSetData = null;

async function openRuleSetModal() {
    document.getElementById('ruleset-modal').classList.add('active');
    await loadRuleSet();
}

function closeRuleSetModal() {
    document.getElementById('ruleset-modal').classList.remove('active');
}

async function loadRuleSet() {
    const body = document.getElementById('ruleset-body');
    body.innerHTML = '<p style="color: var(--text-muted);">Loading rule set...</p>';

    try {
        const response = await fetch('/api/webscraper/ruleset');
        ruleSetData = await response.json();

        let html = '';

        // Global Expansion Keywords
        html += `
            <div class="ruleset-category">
                <h4>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Global Expansion Keywords
                </h4>
                <div class="ruleset-items">
                    ${ruleSetData.expansion_keywords.map(k => `<span class="ruleset-item">${escapeHtml(k)}</span>`).join('')}
                </div>
            </div>
        `;

        // Locale Detection Patterns
        html += `
            <div class="ruleset-category">
                <h4>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                        <polyline points="22,6 12,13 2,6"></polyline>
                    </svg>
                    Locale Detection Patterns
                </h4>
                <div class="ruleset-items">
                    ${ruleSetData.locale_patterns.map(p => `<span class="ruleset-item">${escapeHtml(p)}</span>`).join('')}
                </div>
            </div>
        `;

        // Tier Classification Rules
        html += `
            <div class="ruleset-category">
                <h4>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Tier Classification Rules
                </h4>
                <div class="ruleset-items" style="flex-direction: column; align-items: stretch;">
                    ${Object.entries(ruleSetData.tier_rules).map(([tier, rule]) => `
                        <div class="ruleset-item" style="display: flex; gap: 0.5rem;">
                            <strong style="color: var(--accent-color);">Tier ${tier}:</strong>
                            <span>${escapeHtml(rule)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;

        // Last Updated
        html += `
            <div class="ruleset-last-updated">
                <strong>Last Updated:</strong> ${ruleSetData.last_updated || 'Unknown'}
                <br><small>Rule sets refresh automatically every 24 hours based on scanner.py heuristics.</small>
            </div>
        `;

        body.innerHTML = html;
    } catch (error) {
        body.innerHTML = `<p style="color: #e74c3c;">Failed to load rule set: ${escapeHtml(error.message)}</p>`;
    }
}

// ============================================================
// HISTORY MODAL
// ============================================================
async function openHistoryModal() {
    document.getElementById('history-modal').classList.add('active');
    await loadHistory();
}

function closeHistoryModal() {
    document.getElementById('history-modal').classList.remove('active');
}

async function loadHistory() {
    const body = document.getElementById('history-body');
    body.innerHTML = '<p style="color: var(--text-muted);">Loading scan history...</p>';

    try {
        const response = await fetch('/api/webscraper/history?limit=20');
        const history = await response.json();

        if (history.length === 0) {
            body.innerHTML = '<p style="color: var(--text-muted);">No scan history yet.</p>';
            return;
        }

        let html = '<div class="history-list">';
        for (const item of history) {
            html += `
                <div class="history-item">
                    <div class="history-item-header">
                        <span class="history-item-company">${escapeHtml(item.company_name)}</span>
                        <span class="history-item-time">${timeAgo(item.scanned_at)}</span>
                    </div>
                    <div class="history-item-details">
                        Tier ${item.tier} | ${item.locale_count} locales | Score: ${item.score || 'N/A'}%
                        ${item.evidence ? `<br><small>${escapeHtml(item.evidence.substring(0, 100))}${item.evidence.length > 100 ? '...' : ''}</small>` : ''}
                    </div>
                </div>
            `;
        }
        html += '</div>';
        body.innerHTML = html;
    } catch (error) {
        body.innerHTML = `<p style="color: #e74c3c;">Failed to load history: ${escapeHtml(error.message)}</p>`;
    }
}

// Close modals when clicking outside
document.addEventListener('click', (e) => {
    if (e.target.classList.contains('ws-modal-overlay')) {
        e.target.classList.remove('active');
    }
});

// Close modals with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        document.querySelectorAll('.ws-modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
        });
    }
});
</script>

<!-- Grow Modal -->
<div class="ws-modal-overlay" id="grow-modal">
    <div class="ws-modal">
        <div class="ws-modal-header">
            <h3>Grow Account List</h3>
            <button class="ws-modal-close" onclick="closeGrowModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="ws-modal-body">
            <p class="grow-description">
                Expand your WebScraper account list by importing accounts from various sources.
                Each source will add accounts that have website URLs for localization analysis.
            </p>
            <div class="grow-options">
                <div class="grow-option" onclick="growFromRepoRadar()">
                    <h4>Import from RepoRadar</h4>
                    <p>Add accounts from RepoRadar that have website URLs. Useful for cross-referencing GitHub signals with website localization status.</p>
                </div>
                <div class="grow-option" onclick="alert('Coming soon: CSV upload for bulk import')">
                    <h4>Upload CSV</h4>
                    <p>Import a CSV file with company names and website URLs for batch processing.</p>
                </div>
                <div class="grow-option" onclick="alert('Coming soon: Integration with CRM systems')">
                    <h4>CRM Integration</h4>
                    <p>Connect to Salesforce, HubSpot, or other CRM systems to sync prospect lists.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rule Set Modal -->
<div class="ws-modal-overlay" id="ruleset-modal">
    <div class="ws-modal">
        <div class="ws-modal-header">
            <h3>WebScraper Rule Set</h3>
            <button class="ws-modal-close" onclick="closeRuleSetModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="ws-modal-body" id="ruleset-body">
            <p style="color: var(--text-muted);">Loading rule set...</p>
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="ws-modal-overlay" id="history-modal">
    <div class="ws-modal">
        <div class="ws-modal-header">
            <h3>Recent Scan History</h3>
            <button class="ws-modal-close" onclick="closeHistoryModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="ws-modal-body" id="history-body">
            <p style="color: var(--text-muted);">Loading scan history...</p>
        </div>
    </div>
</div>

{% endblock %}
