{% extends "base.html" %}

{% block title %}Campaigns - Lead Machine{% endblock %}
{% block page_title %}Campaigns{% endblock %}

{% block head %}
<style>
    .campaigns-page { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

    /* Page header */
    .campaigns-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    .campaigns-header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; color: var(--color-text); }
    .campaigns-header .subtitle { font-size: 0.9rem; color: var(--color-text-secondary); margin-top: 0.25rem; }
    .btn-create-campaign {
        display: inline-flex; align-items: center; gap: 0.5rem;
        padding: 0.6rem 1.25rem; background: var(--color-primary); color: #fff;
        border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600;
        cursor: pointer; transition: background 0.15s;
    }
    .btn-create-campaign:hover { background: var(--color-primary-hover); }

    /* Campaign cards grid */
    .campaigns-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 1rem; }

    .campaign-card {
        background: var(--color-surface); border: 1px solid var(--color-border);
        border-radius: 12px; padding: 1.25rem; transition: box-shadow 0.15s;
        position: relative;
    }
    .campaign-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.06); }
    .campaign-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 0.75rem; }
    .campaign-card-name { font-size: 1.05rem; font-weight: 700; color: var(--color-text); margin: 0; }
    .campaign-card-status {
        font-size: 0.75rem; font-weight: 600; padding: 2px 10px; border-radius: 20px;
        text-transform: uppercase; letter-spacing: 0.5px;
    }
    .campaign-card-status.draft { background: #f3f4f6; color: #6b7280; }
    .campaign-card-status.active { background: #d1fae5; color: #065f46; }

    .campaign-card-prompt {
        font-size: 0.85rem; color: var(--color-text-secondary); line-height: 1.5;
        margin-bottom: 0.75rem; max-height: 3.6em; overflow: hidden;
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
    }

    .campaign-card-meta { display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.8rem; color: var(--color-text-tertiary); }
    .campaign-card-meta .meta-item { display: flex; align-items: center; gap: 0.35rem; }
    .campaign-card-meta svg { width: 14px; height: 14px; flex-shrink: 0; }

    .campaign-card-actions {
        display: flex; gap: 0.5rem; margin-top: 0.75rem; padding-top: 0.75rem;
        border-top: 1px solid var(--color-border-subtle);
    }
    .campaign-card-actions button {
        flex: 1; padding: 0.4rem 0.75rem; font-size: 0.8rem; font-weight: 500;
        border-radius: 6px; cursor: pointer; border: 1px solid var(--color-border);
        background: transparent; color: var(--color-text-secondary); transition: all 0.15s;
    }
    .campaign-card-actions button:hover { background: var(--color-bg); color: var(--color-text); }
    .campaign-card-actions button.btn-del:hover { background: #fef2f2; color: var(--color-destructive); border-color: var(--color-destructive); }

    /* Empty state */
    .campaigns-empty {
        text-align: center; padding: 3rem 1.5rem;
        background: var(--color-surface); border: 2px dashed var(--color-border);
        border-radius: 12px;
    }
    .campaigns-empty svg { width: 48px; height: 48px; color: var(--color-text-tertiary); margin-bottom: 1rem; }
    .campaigns-empty h3 { font-size: 1.1rem; font-weight: 600; margin: 0 0 0.5rem; color: var(--color-text); }
    .campaigns-empty p { font-size: 0.9rem; color: var(--color-text-secondary); margin: 0 0 1rem; }

    /* ============================================================
       CREATE/EDIT MODAL
       ============================================================ */
    .campaign-modal-overlay {
        display: none; position: fixed; inset: 0; z-index: 1000;
        background: rgba(0,0,0,0.45); align-items: center; justify-content: center;
    }
    .campaign-modal-overlay.open { display: flex; }
    .campaign-modal {
        background: var(--color-surface); border-radius: 14px;
        width: 680px; max-width: 95vw; max-height: 90vh; overflow-y: auto;
        box-shadow: 0 24px 48px rgba(0,0,0,0.12);
    }
    .campaign-modal-header {
        display: flex; align-items: center; justify-content: space-between;
        padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--color-border);
    }
    .campaign-modal-header h2 { margin: 0; font-size: 1.15rem; font-weight: 700; }
    .campaign-modal-close {
        background: none; border: none; cursor: pointer; color: var(--color-text-secondary);
        padding: 0.25rem; border-radius: 6px;
    }
    .campaign-modal-close:hover { background: var(--color-bg); }
    .campaign-modal-body { padding: 1.5rem; }
    .campaign-modal-footer {
        padding: 1rem 1.5rem; border-top: 1px solid var(--color-border);
        display: flex; gap: 0.75rem; justify-content: flex-end;
    }

    /* Form fields */
    .form-group { margin-bottom: 1.25rem; }
    .form-group label {
        display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.35rem;
        color: var(--color-text);
    }
    .form-group .form-help { font-size: 0.8rem; color: var(--color-text-tertiary); margin-top: 0.25rem; }
    .form-input, .form-textarea, .form-select {
        width: 100%; padding: 0.6rem 0.75rem; border: 1px solid var(--color-border);
        border-radius: 8px; font-size: 0.9rem; font-family: var(--font-sans);
        background: var(--color-surface); color: var(--color-text);
        transition: border-color 0.15s;
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1);
    }
    .form-textarea { min-height: 100px; resize: vertical; line-height: 1.6; }

    /* Sequence picker */
    .seq-picker { display: flex; gap: 0.5rem; align-items: flex-end; }
    .seq-picker .form-select { flex: 1; }
    .seq-picker .btn-detect {
        padding: 0.6rem 1rem; background: var(--color-bg); border: 1px solid var(--color-border);
        border-radius: 8px; font-size: 0.85rem; cursor: pointer; white-space: nowrap;
        color: var(--color-text-secondary); font-weight: 500;
    }
    .seq-picker .btn-detect:hover { background: var(--color-border-subtle); color: var(--color-text); }

    /* Sequence steps preview */
    .seq-steps-preview { margin-top: 0.75rem; }
    .seq-steps-list {
        background: var(--color-bg); border-radius: 8px; padding: 0.5rem;
        max-height: 240px; overflow-y: auto;
    }
    .seq-step-item {
        display: flex; align-items: center; gap: 0.75rem;
        padding: 0.5rem 0.75rem; border-radius: 6px;
        font-size: 0.85rem;
    }
    .seq-step-item:not(:last-child) { margin-bottom: 2px; }
    .seq-step-item:hover { background: var(--color-surface); }
    .seq-step-num {
        width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
        background: var(--color-primary); color: #fff; border-radius: 50%;
        font-size: 0.75rem; font-weight: 700; flex-shrink: 0;
    }
    .seq-step-num.task { background: var(--color-warning); }
    .seq-step-num.linkedin { background: #0a66c2; }
    .seq-step-type {
        font-size: 0.75rem; font-weight: 600; color: var(--color-text-tertiary);
        text-transform: uppercase; letter-spacing: 0.3px; width: 50px; flex-shrink: 0;
    }
    .seq-step-subject { flex: 1; color: var(--color-text); font-weight: 500; }
    .seq-step-delay { font-size: 0.75rem; color: var(--color-text-tertiary); flex-shrink: 0; }

    /* Persona rows */
    .persona-row { display:flex; gap:0.5rem; align-items:flex-start; padding:0.6rem; background:var(--color-bg); border-radius:8px; margin-bottom:0.4rem; }
    .persona-row input[type="text"] { padding:0.4rem 0.6rem; border:1px solid var(--color-border); border-radius:6px; font-size:0.8rem; }
    .persona-row .p-name { width:140px; }
    .persona-row .p-titles { flex:1; min-width:200px; }
    .persona-row select { padding:0.4rem 0.6rem; border:1px solid var(--color-border); border-radius:6px; font-size:0.8rem; flex:1; min-width:160px; }
    .persona-row .p-remove { background:none; border:none; color:#DC2626; cursor:pointer; font-size:1.1rem; padding:0.3rem; line-height:1; }
    .persona-row .p-remove:hover { background:#FEF2F2; border-radius:4px; }
    .seniority-checks { display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.25rem; }
    .seniority-checks label { font-size:0.7rem; display:flex; align-items:center; gap:0.2rem; color:var(--color-text-secondary); cursor:pointer; }
    .seniority-checks input { width:13px; height:13px; }
    .seq-steps-empty { padding: 1rem; text-align: center; color: var(--color-text-tertiary); font-size: 0.85rem; }
    .seq-steps-loading { padding: 0.75rem; text-align: center; color: var(--color-text-tertiary); font-size: 0.85rem; }

    /* Notification toast */
    .campaign-toast {
        position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 2000;
        padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.9rem; font-weight: 500;
        color: #fff; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(100px); opacity: 0; transition: all 0.3s;
    }
    .campaign-toast.show { transform: translateY(0); opacity: 1; }
    .campaign-toast.success { background: var(--color-success); }
    .campaign-toast.error { background: var(--color-destructive); }
    .campaign-toast.info { background: var(--color-info); }

    /* Assets tag display */
    .assets-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.5rem; }
    .asset-tag {
        display: inline-flex; align-items: center; gap: 0.25rem;
        padding: 2px 8px; background: var(--color-primary-subtle); color: var(--color-primary);
        border-radius: 6px; font-size: 0.75rem; max-width: 200px; overflow: hidden;
        text-overflow: ellipsis; white-space: nowrap;
    }
    .asset-tag svg { width: 12px; height: 12px; flex-shrink: 0; }
</style>
{% endblock %}

{% block content %}
<div class="campaigns-page">
    <div class="campaigns-header">
        <div>
            <h1>Campaigns</h1>
            <p class="subtitle">Create outreach campaigns with custom prompts, assets, and mapped Apollo sequences</p>
        </div>
        <button class="btn-create-campaign" onclick="openCreateModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="18" height="18"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Campaign
        </button>
    </div>

    {% if campaigns %}
    <div class="campaigns-grid" id="campaigns-grid">
        {% for c in campaigns %}
        <div class="campaign-card" id="campaign-{{ c.id }}" data-id="{{ c.id }}">
            <div class="campaign-card-header">
                <h3 class="campaign-card-name">{{ c.name }}</h3>
                <span class="campaign-card-status {{ c.status }}">{{ c.status }}</span>
            </div>
            {% if c.prompt %}
            <p class="campaign-card-prompt">{{ c.prompt }}</p>
            {% endif %}
            <div class="campaign-card-meta">
                {% if c.sequence_name %}
                <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    {{ c.sequence_name }}
                </span>
                {% endif %}
                {% if c.sequence_config %}
                <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                    {{ c.sequence_config | replace('_', ' ') | title }}
                </span>
                {% endif %}
                {% if c.persona_count %}
                <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    {{ c.persona_count }} persona{{ 's' if c.persona_count != 1 else '' }}
                </span>
                {% endif %}
                {% if c.assets %}
                <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                    {{ c.assets | length }} asset{{ 's' if c.assets | length != 1 else '' }}
                </span>
                {% endif %}
                <span class="meta-item">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    {{ c.updated_at[:10] if c.updated_at else 'N/A' }}
                </span>
            </div>
            <div class="campaign-card-actions">
                <button onclick="editCampaign({{ c.id }})">Edit</button>
                <button onclick="toggleCampaignStatus({{ c.id }})">{{ 'Deactivate' if c.status == 'active' else 'Activate' }}</button>
                <button class="btn-del" onclick="deleteCampaign({{ c.id }}, '{{ c.name | e }}')">Delete</button>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="campaigns-empty" id="campaigns-empty">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
        </svg>
        <h3>No campaigns yet</h3>
        <p>Create your first campaign to pair a custom prompt and assets with an Apollo sequence.</p>
        <button class="btn-create-campaign" onclick="openCreateModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            New Campaign
        </button>
    </div>
    {% endif %}
</div>

<!-- Create/Edit Campaign Modal -->
<div class="campaign-modal-overlay" id="campaign-modal">
    <div class="campaign-modal">
        <div class="campaign-modal-header">
            <h2 id="modal-title">New Campaign</h2>
            <button class="campaign-modal-close" onclick="closeModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" width="20" height="20"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="campaign-modal-body">
            <input type="hidden" id="campaign-edit-id" value="">

            <div class="form-group">
                <label for="campaign-name">Campaign Name</label>
                <input type="text" id="campaign-name" class="form-input" placeholder="e.g. Q1 Greenfield Outreach">
            </div>

            <div class="form-group">
                <label for="campaign-prompt">Campaign Prompt</label>
                <textarea id="campaign-prompt" class="form-textarea" placeholder="Describe the messaging angle, tone, and what signals to reference. This prompt guides the AI when generating cold emails for contacts enrolled in this campaign."></textarea>
                <p class="form-help">The AI uses this prompt to craft personalized emails when contacts are enrolled in this campaign's sequence.</p>
            </div>

            <div class="form-group">
                <label for="campaign-assets">Assets (URLs, one per line)</label>
                <textarea id="campaign-assets" class="form-textarea" style="min-height:70px" placeholder="https://phrase.com/blog/posts/i18n-guide&#10;https://phrase.com/pricing"></textarea>
                <p class="form-help">Reference URLs the AI can cite in generated emails — blog posts, case studies, pricing pages, etc.</p>
            </div>

            <div class="form-group">
                <label>Mapped Apollo Sequence</label>
                <div class="seq-picker">
                    <select id="campaign-sequence" class="form-select">
                        <option value="">Select a sequence...</option>
                    </select>
                    <button type="button" class="btn-detect" onclick="loadApolloSequences()">Refresh</button>
                </div>
                <p class="form-help">Choose the Apollo sequence contacts will be enrolled in. Steps are shown below.</p>
                <div id="seq-shared-info" style="display:none; margin-top:0.5rem; padding:0.4rem 0.75rem; background:#fef3c7; border-radius:6px; font-size:0.8rem; color:#92400e;">
                    ⚡ Also used by: <span id="seq-shared-campaigns" style="font-weight:600;"></span>
                </div>

                <!-- Sequence Steps Preview -->
                <div class="seq-steps-preview" id="seq-steps-preview" style="display:none">
                    <div class="seq-steps-list" id="seq-steps-list">
                        <div class="seq-steps-loading">Loading steps...</div>
                    </div>
                </div>
            </div>

            <!-- Personas Configuration -->
            <div class="form-group">
                <label>Personas <span style="font-weight:400;color:var(--color-text-secondary);font-size:0.8rem;">(optional — for batch enrollment)</span></label>
                <p class="form-help" style="margin-bottom:0.5rem;">Define target personas with title/seniority filters and assign each to an Apollo sequence. Used by the Enrollment page.</p>
                <div id="personas-list"></div>
                <button type="button" class="btn-detect" style="margin-top:0.5rem;" onclick="addPersonaRow()">+ Add Persona</button>
            </div>
        </div>
        <div class="campaign-modal-footer">
            <button class="btn-detect" onclick="closeModal()">Cancel</button>
            <button class="btn-create-campaign" onclick="saveCampaign()">Save Campaign</button>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="campaign-toast" id="campaign-toast"></div>

{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    let editingId = null;
    let sequencesCache = [];
    const SENIORITY_OPTIONS = [
        {value: 'c_suite', label: 'C-Suite'},
        {value: 'vp', label: 'VP'},
        {value: 'director', label: 'Director'},
        {value: 'manager', label: 'Manager'},
        {value: 'senior', label: 'Senior'},
    ];

    // ── Toast ──
    function showToast(msg, type) {
        const toast = document.getElementById('campaign-toast');
        toast.textContent = msg;
        toast.className = 'campaign-toast ' + (type || 'info');
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    window.showToast = showToast;

    // ── Modal open/close ──
    window.openCreateModal = function() {
        editingId = null;
        document.getElementById('modal-title').textContent = 'New Campaign';
        document.getElementById('campaign-edit-id').value = '';
        document.getElementById('campaign-name').value = '';
        document.getElementById('campaign-prompt').value = '';
        document.getElementById('campaign-assets').value = '';
        document.getElementById('campaign-sequence').value = '';
        document.getElementById('seq-steps-preview').style.display = 'none';
        document.getElementById('seq-shared-info').style.display = 'none';
        document.getElementById('personas-list').innerHTML = '';
        document.getElementById('campaign-modal').classList.add('open');
        loadApolloSequences();
        setTimeout(() => document.getElementById('campaign-name').focus(), 100);
    };

    window.closeModal = function() {
        document.getElementById('campaign-modal').classList.remove('open');
    };

    // Close on overlay click or Escape
    document.getElementById('campaign-modal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('campaign-modal').classList.contains('open')) {
            closeModal();
        }
    });

    // ── Load enabled sequences into dropdown ──
    window.loadApolloSequences = async function() {
        const sel = document.getElementById('campaign-sequence');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="">Loading sequences...</option>';

        try {
            const resp = await fetch('/api/sequence-mappings/enabled');
            const data = await resp.json();
            if (data.status === 'success' && data.sequences) {
                sequencesCache = data.sequences.map(s => ({
                    id: s.sequence_id,
                    name: s.sequence_name,
                    num_steps: s.num_steps,
                    active: s.active,
                }));
                sel.innerHTML = '<option value="">Select a sequence...</option>';
                for (const seq of sequencesCache) {
                    const opt = document.createElement('option');
                    opt.value = seq.id;
                    opt.textContent = `${seq.name} (${seq.num_steps} steps${seq.active ? '' : ', inactive'})`;
                    opt.dataset.name = seq.name;
                    opt.dataset.steps = seq.num_steps;
                    sel.appendChild(opt);
                }
                // Restore previous selection if exists
                if (currentVal) sel.value = currentVal;
            } else {
                sel.innerHTML = '<option value="">No enabled sequences — enable them in Mapping Sequences</option>';
            }
        } catch(e) {
            sel.innerHTML = '<option value="">Failed to load sequences</option>';
        }
    };

    // ── Show sequence steps + shared-campaign indicator when selection changes ──
    document.getElementById('campaign-sequence').addEventListener('change', async function() {
        const seqId = this.value;
        const preview = document.getElementById('seq-steps-preview');
        const list = document.getElementById('seq-steps-list');
        const sharedInfo = document.getElementById('seq-shared-info');

        if (!seqId) {
            preview.style.display = 'none';
            sharedInfo.style.display = 'none';
            return;
        }

        preview.style.display = 'block';
        list.innerHTML = '<div class="seq-steps-loading">Loading steps...</div>';

        // Fetch steps
        try {
            const resp = await fetch(`/api/apollo/sequence-steps/${seqId}`);
            const data = await resp.json();

            if (data.status === 'success' && data.steps && data.steps.length > 0) {
                let html = '';
                for (const step of data.steps) {
                    const isEmail = step.type.includes('email');
                    const isLinkedIn = step.type.includes('linkedin');
                    const numClass = isLinkedIn ? 'linkedin' : (!isEmail ? 'task' : '');
                    const delay = step.wait_time > 0 ? `${step.wait_time}d` : '';

                    html += `<div class="seq-step-item">
                        <span class="seq-step-num ${numClass}">${step.position}</span>
                        <span class="seq-step-type">${step.type_label}</span>
                        <span class="seq-step-subject">${escHtml(step.subject)}</span>
                        ${delay ? `<span class="seq-step-delay">+${delay}</span>` : ''}
                    </div>`;
                }
                list.innerHTML = html;
            } else {
                list.innerHTML = '<div class="seq-steps-empty">No steps found for this sequence</div>';
            }
        } catch(e) {
            list.innerHTML = '<div class="seq-steps-empty">Failed to load steps</div>';
        }

        // Fetch shared campaigns for this sequence
        try {
            const cResp = await fetch(`/api/campaigns/by-sequence/${seqId}`);
            const cData = await cResp.json();
            if (cData.status === 'success' && cData.campaigns && cData.campaigns.length > 0) {
                const others = cData.campaigns.filter(c => c.id !== editingId);
                if (others.length > 0) {
                    document.getElementById('seq-shared-campaigns').textContent = others.map(c => c.name).join(', ');
                    sharedInfo.style.display = 'block';
                } else {
                    sharedInfo.style.display = 'none';
                }
            } else {
                sharedInfo.style.display = 'none';
            }
        } catch(e) {
            sharedInfo.style.display = 'none';
        }
    });

    function escHtml(s) {
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
    }

    // ── Persona helpers ──
    function buildSequenceOptions(selectedId) {
        let html = '<option value="">Select sequence...</option>';
        for (const seq of sequencesCache) {
            const sel = seq.id === selectedId ? ' selected' : '';
            html += `<option value="${seq.id}" data-name="${escHtml(seq.name)}"${sel}>${escHtml(seq.name)} (${seq.num_steps} steps)</option>`;
        }
        return html;
    }

    function buildSeniorityChecks(selected) {
        const set = new Set(selected || []);
        return SENIORITY_OPTIONS.map(s =>
            `<label><input type="checkbox" value="${s.value}"${set.has(s.value) ? ' checked' : ''}> ${s.label}</label>`
        ).join('');
    }

    window.addPersonaRow = function(data) {
        const list = document.getElementById('personas-list');
        const row = document.createElement('div');
        row.className = 'persona-row';
        row.innerHTML = `
            <div style="display:flex;flex-direction:column;gap:0.35rem;flex:1;">
                <div style="display:flex;gap:0.5rem;align-items:center;">
                    <input type="text" class="p-name" placeholder="Persona name" value="${escHtml((data && data.persona_name) || '')}">
                    <input type="text" class="p-titles" placeholder="Titles (comma-separated)" value="${escHtml((data && data.titles || []).join(', '))}">
                    <select class="p-sequence">${buildSequenceOptions(data && data.sequence_id)}</select>
                    <button type="button" class="p-remove" title="Remove" onclick="this.closest('.persona-row').remove()">&times;</button>
                </div>
                <div class="seniority-checks">${buildSeniorityChecks(data && data.seniorities)}</div>
            </div>`;
        list.appendChild(row);
    };

    function renderPersonaRows(personas) {
        document.getElementById('personas-list').innerHTML = '';
        if (!personas || !personas.length) return;
        for (const p of personas) {
            addPersonaRow({
                persona_name: p.persona_name,
                titles: typeof p.titles_json === 'string' ? JSON.parse(p.titles_json || '[]') : (p.titles || []),
                seniorities: typeof p.seniorities_json === 'string' ? JSON.parse(p.seniorities_json || '[]') : (p.seniorities || []),
                sequence_id: p.sequence_id,
            });
        }
    }

    function getPersonasFromForm() {
        const rows = document.querySelectorAll('#personas-list .persona-row');
        const personas = [];
        rows.forEach((row, idx) => {
            const name = row.querySelector('.p-name').value.trim();
            if (!name) return;
            const titlesRaw = row.querySelector('.p-titles').value.trim();
            const titles = titlesRaw ? titlesRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
            const seniorities = [];
            row.querySelectorAll('.seniority-checks input:checked').forEach(cb => seniorities.push(cb.value));
            const seqSelect = row.querySelector('.p-sequence');
            const seqId = seqSelect.value || null;
            const seqOpt = seqSelect.selectedOptions[0];
            const seqName = (seqOpt && seqOpt.dataset.name) || null;
            if (seqId) {
                personas.push({
                    persona_name: name,
                    titles_json: JSON.stringify(titles),
                    seniorities_json: JSON.stringify(seniorities),
                    sequence_id: seqId,
                    sequence_name: seqName,
                    priority: idx,
                });
            }
        });
        return personas;
    }

    // ── Save campaign (create or update) ──
    window.saveCampaign = async function() {
        const name = document.getElementById('campaign-name').value.trim();
        if (!name) {
            document.getElementById('campaign-name').focus();
            document.getElementById('campaign-name').style.borderColor = 'var(--color-destructive)';
            setTimeout(() => document.getElementById('campaign-name').style.borderColor = '', 1500);
            return;
        }

        const prompt = document.getElementById('campaign-prompt').value.trim();
        const assetsRaw = document.getElementById('campaign-assets').value.trim();
        const assets = assetsRaw ? assetsRaw.split('\n').map(a => a.trim()).filter(Boolean) : [];
        const seqSelect = document.getElementById('campaign-sequence');
        const seqId = seqSelect.value || null;
        const seqOpt = seqSelect.selectedOptions[0];
        const seqName = (seqOpt && seqOpt.dataset.name) || null;

        // Detect config from the sequence
        let seqConfig = null;
        if (seqId) {
            try {
                const dr = await fetch('/api/apollo/sequence-detect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sequence_id: seqId})
                });
                const dd = await dr.json();
                if (dd.detected_config) seqConfig = dd.detected_config;
            } catch(e) {}
        }

        const personas = getPersonasFromForm();

        const payload = {
            name, prompt, assets,
            sequence_id: seqId,
            sequence_name: seqName,
            sequence_config: seqConfig,
            personas: personas
        };

        try {
            let resp;
            if (editingId) {
                resp = await fetch(`/api/campaigns/${editingId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            } else {
                resp = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            }

            const data = await resp.json();
            if (data.status === 'success') {
                showToast(editingId ? 'Campaign updated' : 'Campaign created', 'success');
                closeModal();
                // Reload to show new/updated campaign
                window.location.reload();
            } else {
                showToast(data.message || 'Failed to save', 'error');
            }
        } catch(e) {
            showToast('Network error', 'error');
        }
    };

    // ── Edit campaign ──
    window.editCampaign = async function(id) {
        try {
            const resp = await fetch(`/api/campaigns/${id}`);
            const data = await resp.json();
            if (data.status !== 'success') {
                showToast('Failed to load campaign', 'error');
                return;
            }
            const c = data.campaign;
            editingId = id;
            document.getElementById('modal-title').textContent = 'Edit Campaign';
            document.getElementById('campaign-edit-id').value = id;
            document.getElementById('campaign-name').value = c.name || '';
            document.getElementById('campaign-prompt').value = c.prompt || '';
            document.getElementById('campaign-assets').value = (c.assets || []).join('\n');
            document.getElementById('campaign-modal').classList.add('open');

            // Load sequences then set selected
            await loadApolloSequences();
            if (c.sequence_id) {
                document.getElementById('campaign-sequence').value = c.sequence_id;
                // Trigger step preview
                document.getElementById('campaign-sequence').dispatchEvent(new Event('change'));
            }

            // Load personas
            renderPersonaRows(c.personas || []);
        } catch(e) {
            showToast('Failed to load campaign', 'error');
        }
    };

    // ── Toggle status ──
    window.toggleCampaignStatus = async function(id) {
        try {
            const resp = await fetch(`/api/campaigns/${id}/activate`, {method: 'POST'});
            const data = await resp.json();
            if (data.status === 'success') {
                showToast(`Campaign ${data.new_status}`, 'success');
                window.location.reload();
            }
        } catch(e) {
            showToast('Failed to update status', 'error');
        }
    };

    // ── Delete campaign ──
    window.deleteCampaign = async function(id, name) {
        if (!confirm(`Delete campaign "${name}"? This cannot be undone.`)) return;
        try {
            const resp = await fetch(`/api/campaigns/${id}`, {method: 'DELETE'});
            const data = await resp.json();
            if (data.status === 'success') {
                showToast('Campaign deleted', 'info');
                const card = document.getElementById(`campaign-${id}`);
                if (card) {
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.95)';
                    card.style.transition = 'all 0.2s';
                    setTimeout(() => {
                        card.remove();
                        // Show empty state if no campaigns left
                        const grid = document.getElementById('campaigns-grid');
                        if (grid && grid.children.length === 0) {
                            window.location.reload();
                        }
                    }, 200);
                }
            }
        } catch(e) {
            showToast('Failed to delete', 'error');
        }
    };

})();
</script>
{% endblock %}
